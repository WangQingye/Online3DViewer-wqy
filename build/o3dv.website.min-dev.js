var OV=(()=>{var ki=Object.defineProperty;var Vs=Object.getOwnPropertyDescriptor;var Ls=Object.getOwnPropertyNames;var Bs=Object.prototype.hasOwnProperty;var Os=(s,e)=>{for(var t in e)ki(s,t,{get:e[t],enumerable:!0})},ks=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ls(e))!Bs.call(s,r)&&r!==t&&ki(s,r,{get:()=>e[r],enumerable:!(i=Vs(e,r))||i.enumerable});return s};var Us=s=>ks(ki({},"__esModule",{value:!0}),s);var ro={};Os(ro,{CreateHeaderButton:()=>io,SetWebsiteEventHandler:()=>$s,StartEmbed:()=>to,StartWebsite:()=>eo});var li=null,nn=new Set;function Ui(s){li=s}function Hi(s){return li===null?null:li+"/"+s}function Se(s){return new Promise((e,t)=>{if(li===null){t();return}if(nn.has(s)){e();return}let i=document.createElement("script");i.type="text/javascript",i.src=Hi(s),i.onload=()=>{nn.add(s),e()},i.onerror=()=>{t()},document.head.appendChild(i)})}var sn=57.29577951308232,bt=.017453292519943;function kt(s){return Math.abs(s)<1e-8}function ai(s,e){return e-s>1e-8}function on(s,e){return s-e>1e-8}function hi(s,e){return e-s>-1e-8}function ui(s,e){return s-e>-1e-8}function X(s,e){return Math.abs(e-s)<1e-8}function zi(s,e,t){return Math.abs(e-s)<t}function Le(s){return s>1e-8}function nt(s){return s<-1e-8}var S={X:1,Y:2,Z:3};var V=class{constructor(e,t){this.x=e,this.y=t}Clone(){return new V(this.x,this.y)}};function St(s,e){return X(s.x,e.x)&&X(s.y,e.y)}function Wi(s,e){return new V(s.x-e.x,s.y-e.y)}function ji(s,e){return Math.sqrt((s.x-e.x)*(s.x-e.x)+(s.y-e.y)*(s.y-e.y))}function oe(s){return Math.round(parseFloat(s))}function ln(s){let e=oe(s.paddingLeft)+oe(s.paddingRight),t=oe(s.borderLeftWidth)+oe(s.borderRightWidth),i=oe(s.marginLeft)+oe(s.marginRight);return e+t+i}function an(s){let e=oe(s.paddingTop)+oe(s.paddingBottom),t=oe(s.borderTopWidth)+oe(s.borderBottomWidth),i=oe(s.marginTop)+oe(s.marginBottom);return e+t+i}function hn(s,e,t){let i=getComputedStyle(s),r=e-ln(i),n=t-an(i);return{width:r,height:n}}function st(s,e,t){if(s.getBoundingClientRect){let i=s.getBoundingClientRect();e-=i.left,t-=i.top}return window.pageXOffset&&window.pageYOffset&&(e+=window.pageXOffset,t+=window.pageYOffset),new V(e,t)}function wt(s,e,t){let i=document.createElement(s);return e&&(i.className=e),t&&(i.innerHTML=t),i}function ee(s,e,t,i){let r=wt(e,t,i);return s.appendChild(r),r}function C(s,e,t){return ee(s,"div",e,t)}function Ie(s){for(;s.firstChild;)s.removeChild(s.firstChild)}function ot(s,e){e.parentNode.insertBefore(s,e)}function un(s,e){e.parentNode.insertBefore(s,e.nextSibling)}function R(s,e){e?s.style.display="block":s.style.display="none"}function di(s){return s.offsetParent!==null}function Et(s,e){s.style.width=e.toString()+"px"}function ce(s,e){s.style.height=e.toString()+"px"}function At(s){let e=getComputedStyle(s);return s.offsetWidth+oe(e.marginLeft)+oe(e.marginRight)}function We(s){let e=getComputedStyle(s);return s.offsetHeight+oe(e.marginTop)+oe(e.marginBottom)}function dn(s,e){let t=getComputedStyle(s);Et(s,e-ln(t))}function Ze(s,e){let t=getComputedStyle(s);ce(s,e-an(t))}function pe(s,e){return wt("div",s,e)}var w=class{constructor(e,t,i){this.r=e,this.g=t,this.b=i}Set(e,t,i){this.r=e,this.g=t,this.b=i}Clone(){return new w(this.r,this.g,this.b)}};function we(s){return parseInt(Math.round(s*255),10)}function Pe(s,e,t){return new w(we(s),we(e),we(t))}function Ut(s){return s<.0031308?s*12.92:1.055*Math.pow(s,.41666)-.055}function J(s){let e=parseInt(s,10).toString(16);for(;e.length<2;)e="0"+e;return e}function le(s){let e=J(s.r),t=J(s.g),i=J(s.b);return e+t+i}function mn(s){return new w(s[0],s[1],s[2])}function Dt(s,e){return s.r===e.r&&s.g===e.g&&s.b===e.b}function te(s){return new TextDecoder("utf-8").decode(s)}function Ht(s){let e="data:";if(!s.startsWith(e))return null;let t=s.indexOf(";");if(t===-1)return null;let i=s.indexOf(",");if(i===-1)return null;let r=s.substring(e.length,e.length+t-5),n=atob(s.substring(i+1)),o=new ArrayBuffer(n.length),l=new Uint8Array(o);for(let a=0;a<n.length;a++)l[a]=n.charCodeAt(a);return{mimeType:r,buffer:o}}function Gt(s){if(s==null)return"";let e=s.split("/");return e.length===0?"":e[e.length-1]}function Pt(s){let e=new Blob([s]);return URL.createObjectURL(e)}function qi(s,e){let t=new Blob([s],{type:e});return URL.createObjectURL(t)}function fn(s){URL.revokeObjectURL(s)}function cn(s,e){let t=null,i=n=>{n.preventDefault();let o=n.clientX-t;e.onSplit(o)},r=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",r),document.removeEventListener("mouseleave",r),t=null};s.addEventListener("mousedown",n=>{t=n.clientX,e.onSplitStart(),document.addEventListener("mousemove",i),document.addEventListener("mouseup",r),document.addEventListener("mouseleave",r)})}function Xi(s,e){return s.length>0?s:e}function pn(s){return Xi(s,"No Name")}function mi(s){return Xi(s,"No Name")}function fi(s){return Xi(s,"No Name")}function Yi(){return window.matchMedia("(hover: hover)").matches}function gn(s){window.matchMedia("(max-width: 800px)").addEventListener("change",s)}function xn(){return window.matchMedia("(max-width: 800px)").matches}function ci(s,e){function t(r,n){let o=window.innerWidth,l=r.getBoundingClientRect(),a=r.offsetWidth,h=r.offsetHeight,u=n.offsetWidth,d=10,m=l.left+a/2-u/2;return m+u>o-d&&(m=o-u-d),m<d&&(m=d),m=Math.max(m,0),{left:m,top:l.top+h+d}}if(!Yi())return;let i=null;s.addEventListener("mouseover",()=>{i=C(document.body,"ov_tooltip",e);let r=t(s,i);i.style.left=r.left+"px",i.style.top=r.top+"px"}),s.addEventListener("mouseout",()=>{i.remove()})}function zt(s,e){let t=pe("ov_svg_icon");return e&&t.classList.add(e),ee(t,"i","icon icon-"+s),t}function Z(s,e,t){let i=zt(e,t);return s.appendChild(i),i}function je(s,e){let t=s.firstChild;t.className="icon icon-"+e}function pi(s){let e="#"+le(s),t=new w(Math.max(0,s.r-50),Math.max(0,s.g-50),Math.max(0,s.b-50)),i="#"+le(t),r=pe("ov_color_circle");return r.style.background=e,r.style.border="1px solid "+i,r}function Cn(s){return s.r*.299+s.g*.587+s.b*.114>186}function gi(s,e,t,i){let r=null;cn(s,{onSplitStart:()=>{r=At(e)},onSplit:n=>{let a=0;t?a=r-n:a=r+n,a<280?a=280:a>450&&(a=450),dn(e,a),i()}})}function vn(s,e){async function t(n,o){let l=n.createReader();return new Promise((a,h)=>{l.readEntries(async u=>{for(let d of u)d.isFile?o.push(d):d.isDirectory&&await t(d,o);a()},u=>{h(u)})})}async function i(n,o){let l=[];for(let h of n)h.isFile?l.push(h):h.isDirectory&&await t(h,l);let a=await Promise.all(l.map(h=>new Promise((u,d)=>{h.file(m=>{u(m)},m=>{d(m)})})));o(a)}let r=null;if(DataTransferItem&&(DataTransferItem.prototype.getAsEntry?r=DataTransferItem.prototype.getAsEntry:DataTransferItem.prototype.webkitGetAsEntry&&(r=DataTransferItem.prototype.webkitGetAsEntry)),r!==null){let n=[];for(let o of s.items){let l=r.call(o);l!==null&&n.push(l)}i(n,o=>{e(o)})}else e(s.files)}function Ki(s,e,t,i,r){let n=ee(s,"label");n.setAttribute("for",e);let o=ee(n,"input","ov_checkbox");return o.setAttribute("type","checkbox"),o.setAttribute("id",e),o.checked=i,ee(n,"span",null,t),r&&o.addEventListener("change",r),o}function In(s,e,t){let i=ee(s,"input","ov_slider");return i.setAttribute("type","range"),i.setAttribute("min",e.toString()),i.setAttribute("max",t.toString()),i}function Ji(s,e){function t(l,a){a?l.classList.add("on"):l.classList.remove("on")}let i=!1,r=null,n="ov_toggle";e&&(n+=" "+e);let o=C(s,n);return C(o,"ov_toggle_slider"),o.addEventListener("click",()=>{i=!i,t(o,i),r&&r()}),{element:o,GetStatus:()=>i,SetStatus:l=>{i=l,t(o,i)},OnChange:l=>{r=l}}}var xi=null;function Tn(s){xi=s}function ae(s,e,t){xi?.(s,e,t)}var I=class{constructor(e,t,i){this.x=e,this.y=t,this.z=i}Length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}MultiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}Normalize(){let e=this.Length();return e>0&&this.MultiplyScalar(1/e),this}Offset(e,t){let i=e.Clone().Normalize();return this.x+=i.x*t,this.y+=i.y*t,this.z+=i.z*t,this}Rotate(e,t,i){let r=e.Clone().Normalize(),n=r.x,o=r.y,l=r.z,a=this.x-i.x,h=this.y-i.y,u=this.z-i.z,d=Math.sin(t),m=Math.cos(t);return this.x=-n*(-n*a-o*h-l*u)*(1-m)+a*m+(-l*h+o*u)*d,this.y=-o*(-n*a-o*h-l*u)*(1-m)+h*m+(l*a-n*u)*d,this.z=-l*(-n*a-o*h-l*u)*(1-m)+u*m+(-o*a+n*h)*d,this.x+=i.x,this.y+=i.y,this.z+=i.z,this}Clone(){return new I(this.x,this.y,this.z)}};function Be(s,e){return X(s.x,e.x)&&X(s.y,e.y)&&X(s.z,e.z)}function Mn(s,e){return new I(s.x+e.x,s.y+e.y,s.z+e.z)}function ie(s,e){return new I(s.x-e.x,s.y-e.y,s.z-e.z)}function _e(s,e){return Math.sqrt((s.x-e.x)*(s.x-e.x)+(s.y-e.y)*(s.y-e.y)+(s.z-e.z)*(s.z-e.z))}function Zi(s,e){return s.x*e.x+s.y*e.y+s.z*e.z}function yn(s,e){let t=s.Clone().Normalize(),i=e.Clone().Normalize();if(Be(t,i))return 0;let r=Zi(t,i);return Math.acos(r)}function qe(s,e){let t=new I(0,0,0);return t.x=s.y*e.z-s.z*e.y,t.y=s.z*e.x-s.x*e.z,t.z=s.x*e.y-s.y*e.x,t}function Ci(s,e,t){return Math.sqrt(s*s+e*e+t*t)}function Xe(s){return new I(s[0],s[1],s[2])}var Ye=class{constructor(e,t,i){this.eye=e,this.center=t,this.up=i}Clone(){return new Ye(this.eye.Clone(),this.center.Clone(),this.up.Clone())}};function bn(s,e){return Be(s.eye,e.eye)&&Be(s.center,e.center)&&Be(s.up,e.up)}var ge={IntegerToString(s){return s.toString()},StringToInteger(s){return parseInt(s,10)},NumberToString(s){let e=5;return s.toFixed(e)},StringToNumber(s){return parseFloat(s)},ModelUrlsToString:function(s){return s===null?null:s.join(",")},StringToModelUrls:function(s){return s===null||s.length===0?null:s.split(",")},CameraToString:function(s){return s===null?null:[this.NumberToString(s.eye.x),this.NumberToString(s.eye.y),this.NumberToString(s.eye.z),this.NumberToString(s.center.x),this.NumberToString(s.center.y),this.NumberToString(s.center.z),this.NumberToString(s.up.x),this.NumberToString(s.up.y),this.NumberToString(s.up.z)].join(",")},StringToCamera:function(s){if(s===null||s.length===0)return null;let e=s.split(",");return e.length!==9?null:new Ye(new I(this.StringToNumber(e[0]),this.StringToNumber(e[1]),this.StringToNumber(e[2])),new I(this.StringToNumber(e[3]),this.StringToNumber(e[4]),this.StringToNumber(e[5])),new I(this.StringToNumber(e[6]),this.StringToNumber(e[7]),this.StringToNumber(e[8])))},ColorToString:function(s){return s===null?null:[this.IntegerToString(s.r),this.IntegerToString(s.g),this.IntegerToString(s.b)].join(",")},StringToColor:function(s){if(s===null||s.length===0)return null;let e=s.split(",");return e.length!==3?null:new w(this.StringToInteger(e[0]),this.StringToInteger(e[1]),this.StringToInteger(e[2]))},EnvironmentSettingsToString(s){return s===null?null:[s.environmentMapName,s.backgroundIsEnvMap?"on":"off"].join(",")},StringToEnvironmentSettings:function(s){if(s===null||s.length===0)return null;let e=s.split(",");return e.length!==2?null:{environmentMapName:e[0],backgroundIsEnvMap:e[1]==="on"}},EdgeSettingsToString:function(s){return s===null?null:[s.showEdges?"on":"off",this.ColorToString(s.edgeColor),this.IntegerToString(s.edgeThreshold)].join(",")},StringToEdgeSettings:function(s){if(s===null||s.length===0)return null;let e=s.split(",");return e.length!==5?null:{showEdges:e[0]==="on",edgeColor:new w(this.StringToInteger(e[1]),this.StringToInteger(e[2]),this.StringToInteger(e[3])),edgeThreshold:this.StringToInteger(e[4])}}},Sn=class{constructor(e){this.separator=e,this.paramList=""}AddModelUrls(e){return this.AddUrlPart("model",ge.ModelUrlsToString(e)),this}AddCamera(e){return this.AddUrlPart("camera",ge.CameraToString(e)),this}AddEnvironmentSettings(e){return this.AddUrlPart("envsettings",ge.EnvironmentSettingsToString(e)),this}AddBackgroundColor(e){return this.AddUrlPart("backgroundcolor",ge.ColorToString(e)),this}AddDefaultColor(e){return this.AddUrlPart("defaultcolor",ge.ColorToString(e)),this}AddEdgeSettings(e){return this.AddUrlPart("edgesettings",ge.EdgeSettingsToString(e)),this}AddUrlPart(e,t){e===null||t===null||(this.paramList.length>0&&(this.paramList+=this.separator),this.paramList+=e+"="+t)}GetParameterList(){return this.paramList}},wn=class{constructor(e,t){this.separator=t,this.paramList=e}GetModelUrls(){if(this.paramList.indexOf("=")===-1)return this.paramList.split(",");let e=this.GetKeywordParams("model");return ge.StringToModelUrls(e)}GetCamera(){let e=this.GetKeywordParams("camera");return ge.StringToCamera(e)}GetEnvironmentSettings(){let e=this.GetKeywordParams("envsettings");return ge.StringToEnvironmentSettings(e)}GetBackgroundColor(){let e=this.GetKeywordParams("backgroundcolor");return ge.StringToColor(e)}GetDefaultColor(){let e=this.GetKeywordParams("defaultcolor");return ge.StringToColor(e)}GetEdgeSettings(){let e=this.GetKeywordParams("edgesettings");return ge.StringToEdgeSettings(e)}GetKeywordParams(e){if(this.paramList===null||this.paramList.length===0)return null;let t=e+"=",i=this.paramList.split(this.separator);for(let r=0;r<i.length;r++){let n=i[r];if(n.startsWith(t))return n.substring(t.length)}return null}};function En(){return new Sn("$")}function lt(s){return new wn(s,"$")}function vi(s){let e=En();return e.AddModelUrls(s),e.GetParameterList()}var K={Url:1,File:2,Decompressed:3},xe={Text:1,Binary:2};function re(s){let e=s.lastIndexOf("/");e===-1&&(e=s.lastIndexOf("\\"));let t=s;e!==-1&&(t=s.substring(e+1));let i=t.indexOf("?");return i!==-1&&(t=t.substring(0,i)),decodeURI(t)}function Oe(s){let e=re(s),t=e.lastIndexOf(".");return t===-1?"":e.substring(t+1).toLowerCase()}function An(s,e){return new Promise((t,i)=>{let r=new XMLHttpRequest;if(r.open("GET",s,!0),e===xe.Text)r.responseType="text";else if(e===xe.Binary)r.responseType="arraybuffer";else{i();return}r.onload=function(){r.status===200?t(r.response):i()},r.onerror=function(){i()},r.send(null)})}function Dn(s,e){return new Promise((t,i)=>{let r=new FileReader;r.onloadend=function(n){n.target.readyState===FileReader.DONE&&t(n.target.result)},r.onerror=function(){i()},e===xe.Text?r.readAsText(s):e===xe.Binary?r.readAsArrayBuffer(s):i()})}function Ii(s){for(let e=0;e<s.length;e++){let t=s[e];if(t.search(/www\.dropbox\.com/u)!==-1){t=t.replace("www.dropbox.com","dl.dropbox.com");let i=t.indexOf("?");i!==-1&&(t=t.substring(0,i)),s[e]=t}else if(t.search(/github\.com/u)!==-1){t=t.replace("github.com","raw.githubusercontent.com"),t=t.replace("/blob","");let i=t.indexOf("?");i!==-1&&(t=t.substring(0,i)),s[e]=t}}}var Qi=class{constructor(){this.count=null,this.current=null,this.callbacks=null}Run(e,t){this.count=e,this.current=0,this.callbacks=t,e===0?this.TaskReady():this.RunOnce()}RunBatch(e,t,i){let r=0;e>0&&(r=parseInt((e-1)/t,10)+1),this.Run(r,{runTask:(n,o)=>{let l=n*t,a=Math.min((n+1)*t,e)-1;i.runTask(l,a,o)},onReady:i.onReady})}RunOnce(){setTimeout(()=>{this.callbacks.runTask(this.current,this.TaskReady.bind(this))},0)}TaskReady(){this.current+=1,this.current<this.count?this.RunOnce():this.callbacks.onReady&&this.callbacks.onReady()}};function _t(s){setTimeout(()=>{s()},0)}function Gn(s,e){new Qi().Run(s,e)}function Pn(s,e,t){new Qi().RunBatch(s,e,t)}function _n(s){function e(t){t()&&setTimeout(()=>{e(t)},1)}e(s)}var Ti=class{constructor(e,t){this.source=t,t===K.Url?(this.fileUrl=e,this.fileObject=null,this.name=re(e),this.extension=Oe(e)):t===K.File?(this.fileUrl=null,this.fileObject=e,this.name=re(e.name),this.extension=Oe(e.name)):t===K.Decompressed&&(this.fileUrl=null,this.fileObject=null,this.name=re(e),this.extension=Oe(e)),this.content=null}SetContent(e){this.content=e}},Mi=class{constructor(){this.files=[]}FillFromFileUrls(e){this.Fill(e,K.Url)}FillFromFileObjects(e){this.Fill(e,K.File)}ExtendFromFileList(e){for(let t=0;t<e.length;t++){let i=e[t];this.ContainsFileByPath(i.name)||this.files.push(i)}}GetFiles(){return this.files}GetContent(e){Gn(this.files.length,{runTask:(t,i)=>{this.GetFileContent(this.files[t],i)},onReady:e})}ContainsFileByPath(e){return this.FindFileByPath(e)!==null}FindFileByPath(e){let t=re(e).toLowerCase();for(let i=0;i<this.files.length;i++){let r=this.files[i];if(r.name.toLowerCase()===t)return r}return null}IsOnlyUrlSource(){if(this.files.length===0)return!1;for(let e=0;e<this.files.length;e++){let t=this.files[e];if(t.source!==K.Url&&t.source!==K.Decompressed)return!1}return!0}Fill(e,t){this.files=[];for(let i=0;i<e.length;i++){let r=e[i],n=new Ti(r,t);this.AddFile(n)}}AddFile(e){this.files.push(e)}GetFileContent(e,t){if(e.content!==null){t();return}let i=null;if(e.source===K.Url)i=An(e.fileUrl,xe.Binary);else if(e.source===K.File)i=Dn(e.fileObject,xe.Binary);else{t();return}i.then(r=>{e.SetContent(r)}).catch(()=>{}).finally(()=>{t()})}};var Te=class{constructor(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r}};function Rt(s){return new Te(s[0],s[1],s[2],s[3])}function Rn(s,e){let t=e/2,i=Math.sin(t);return new Te(s.x*i,s.y*i,s.z*i,Math.cos(t))}var ke=class{constructor(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r}Clone(){return new ke(this.x,this.y,this.z,this.w)}};var B=class{constructor(e){this.matrix=null,e!=null&&(this.matrix=e)}IsValid(){return this.matrix!==null}Set(e){return this.matrix=e,this}Get(){return this.matrix}Clone(){let e=[this.matrix[0],this.matrix[1],this.matrix[2],this.matrix[3],this.matrix[4],this.matrix[5],this.matrix[6],this.matrix[7],this.matrix[8],this.matrix[9],this.matrix[10],this.matrix[11],this.matrix[12],this.matrix[13],this.matrix[14],this.matrix[15]];return new B(e)}CreateIdentity(){return this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this}IsIdentity(){let e=new B().CreateIdentity().Get();for(let t=0;t<16;t++)if(!X(this.matrix[t],e[t]))return!1;return!0}CreateTranslation(e,t,i){return this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1],this}CreateRotation(e,t,i,r){let n=e+e,o=t+t,l=i+i,a=e*n,h=e*o,u=e*l,d=t*o,m=t*l,f=i*l,c=r*n,p=r*o,g=r*l;return this.matrix=[1-(d+f),h+g,u-p,0,h-g,1-(a+f),m+c,0,u+p,m-c,1-(a+d),0,0,0,0,1],this}CreateRotationAxisAngle(e,t){let i=Rn(e,t);return this.CreateRotation(i.x,i.y,i.z,i.w)}CreateScale(e,t,i){return this.matrix=[e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1],this}ComposeTRS(e,t,i){let r=e.x,n=e.y,o=e.z,l=t.x,a=t.y,h=t.z,u=t.w,d=i.x,m=i.y,f=i.z,c=l+l,p=a+a,g=h+h,v=l*c,x=l*p,M=l*g,T=a*p,N=a*g,L=h*g,y=u*c,U=u*p,b=u*g;return this.matrix=[(1-(T+L))*d,(x+b)*d,(M-U)*d,0,(x-b)*m,(1-(v+L))*m,(N+y)*m,0,(M+U)*f,(N-y)*f,(1-(v+T))*f,0,r,n,o,1],this}DecomposeTRS(){let e=new I(this.matrix[12],this.matrix[13],this.matrix[14]),t=Ci(this.matrix[0],this.matrix[1],this.matrix[2]),i=Ci(this.matrix[4],this.matrix[5],this.matrix[6]),r=Ci(this.matrix[8],this.matrix[9],this.matrix[10]),n=this.Determinant();nt(n)&&(t*=-1);let o=new I(t,i,r),l=this.matrix[0]/t,a=this.matrix[4]/i,h=this.matrix[8]/r,u=this.matrix[1]/t,d=this.matrix[5]/i,m=this.matrix[9]/r,f=this.matrix[2]/t,c=this.matrix[6]/i,p=this.matrix[10]/r,g=null,v=l+d+p;if(v>0){let x=Math.sqrt(v+1)*2;g=new Te((c-m)/x,(h-f)/x,(u-a)/x,.25*x)}else if(l>d&&l>p){let x=Math.sqrt(1+l-d-p)*2;g=new Te(.25*x,(a+u)/x,(h+f)/x,(c-m)/x)}else if(d>p){let x=Math.sqrt(1+d-l-p)*2;g=new Te((a+u)/x,.25*x,(m+c)/x,(h-f)/x)}else{let x=Math.sqrt(1+p-l-d)*2;g=new Te((h+f)/x,(m+c)/x,.25*x,(u-a)/x)}return{translation:e,rotation:g,scale:o}}Determinant(){let e=this.matrix[0],t=this.matrix[1],i=this.matrix[2],r=this.matrix[3],n=this.matrix[4],o=this.matrix[5],l=this.matrix[6],a=this.matrix[7],h=this.matrix[8],u=this.matrix[9],d=this.matrix[10],m=this.matrix[11],f=this.matrix[12],c=this.matrix[13],p=this.matrix[14],g=this.matrix[15],v=e*o-t*n,x=e*l-i*n,M=e*a-r*n,T=t*l-i*o,N=t*a-r*o,L=i*a-r*l,y=h*c-u*f,U=h*p-d*f,b=h*g-m*f,A=u*p-d*c,z=u*g-m*c,G=d*g-m*p;return v*G-x*z+M*A+T*b-N*U+L*y}Invert(){let e=this.matrix[0],t=this.matrix[1],i=this.matrix[2],r=this.matrix[3],n=this.matrix[4],o=this.matrix[5],l=this.matrix[6],a=this.matrix[7],h=this.matrix[8],u=this.matrix[9],d=this.matrix[10],m=this.matrix[11],f=this.matrix[12],c=this.matrix[13],p=this.matrix[14],g=this.matrix[15],v=e*o-t*n,x=e*l-i*n,M=e*a-r*n,T=t*l-i*o,N=t*a-r*o,L=i*a-r*l,y=h*c-u*f,U=h*p-d*f,b=h*g-m*f,A=u*p-d*c,z=u*g-m*c,G=d*g-m*p,P=v*G-x*z+M*A+T*b-N*U+L*y;if(X(P,0))return null;let _=[(o*G-l*z+a*A)/P,(i*z-t*G-r*A)/P,(c*L-p*N+g*T)/P,(d*N-u*L-m*T)/P,(l*b-n*G-a*U)/P,(e*G-i*b+r*U)/P,(p*M-f*L-g*x)/P,(h*L-d*M+m*x)/P,(n*z-o*b+a*y)/P,(t*b-e*z-r*y)/P,(f*N-c*M+g*v)/P,(u*M-h*N-m*v)/P,(o*U-n*A-l*y)/P,(e*A-t*U+i*y)/P,(c*x-f*T-p*v)/P,(h*T-u*x+d*v)/P];return new B(_)}Transpose(){let e=[this.matrix[0],this.matrix[4],this.matrix[8],this.matrix[12],this.matrix[1],this.matrix[5],this.matrix[9],this.matrix[13],this.matrix[2],this.matrix[6],this.matrix[10],this.matrix[14],this.matrix[3],this.matrix[7],this.matrix[11],this.matrix[15]];return new B(e)}InvertTranspose(){let e=this.Invert();return e===null?null:e.Transpose()}MultiplyVector(e){let t=e.x,i=e.y,r=e.z,n=e.w,o=this.matrix[0],l=this.matrix[1],a=this.matrix[2],h=this.matrix[3],u=this.matrix[4],d=this.matrix[5],m=this.matrix[6],f=this.matrix[7],c=this.matrix[8],p=this.matrix[9],g=this.matrix[10],v=this.matrix[11],x=this.matrix[12],M=this.matrix[13],T=this.matrix[14],N=this.matrix[15];return new ke(t*o+i*u+r*c+n*x,t*l+i*d+r*p+n*M,t*a+i*m+r*g+n*T,t*h+i*f+r*v+n*N)}MultiplyMatrix(e){let t=this.matrix[0],i=this.matrix[1],r=this.matrix[2],n=this.matrix[3],o=this.matrix[4],l=this.matrix[5],a=this.matrix[6],h=this.matrix[7],u=this.matrix[8],d=this.matrix[9],m=this.matrix[10],f=this.matrix[11],c=this.matrix[12],p=this.matrix[13],g=this.matrix[14],v=this.matrix[15],x=e.matrix[0],M=e.matrix[1],T=e.matrix[2],N=e.matrix[3],L=e.matrix[4],y=e.matrix[5],U=e.matrix[6],b=e.matrix[7],A=e.matrix[8],z=e.matrix[9],G=e.matrix[10],P=e.matrix[11],_=e.matrix[12],se=e.matrix[13],O=e.matrix[14],ve=e.matrix[15],Ve=[t*x+i*L+r*A+n*_,t*M+i*y+r*z+n*se,t*T+i*U+r*G+n*O,t*N+i*b+r*P+n*ve,o*x+l*L+a*A+h*_,o*M+l*y+a*z+h*se,o*T+l*U+a*G+h*O,o*N+l*b+a*P+h*ve,u*x+d*L+m*A+f*_,u*M+d*y+m*z+f*se,u*T+d*U+m*G+f*O,u*N+d*b+m*P+f*ve,c*x+p*L+g*A+v*_,c*M+p*y+g*z+v*se,c*T+p*U+g*G+v*O,c*N+p*b+g*P+v*ve];return new B(Ve)}};var j=class{constructor(e){e!=null?this.matrix=e:(this.matrix=new B,this.matrix.CreateIdentity())}SetMatrix(e){return this.matrix=e,this}GetMatrix(){return this.matrix}IsIdentity(){return this.matrix.IsIdentity()}AppendMatrix(e){return this.matrix=this.matrix.MultiplyMatrix(e),this}Append(e){return this.AppendMatrix(e.GetMatrix()),this}TransformCoord3D(e){let t=new ke(e.x,e.y,e.z,1),i=this.matrix.MultiplyVector(t);return new I(i.x,i.y,i.z)}Clone(){let e=this.matrix.Clone();return new j(e)}};var Re=class{constructor(){this.name=null,this.url=null,this.buffer=null,this.offset=new V(0,0),this.scale=new V(1,1),this.rotation=0}IsValid(){return this.name!==null&&this.url!==null&&this.buffer!==null}HasTransformation(){return!St(this.offset,new V(0,0))||!St(this.scale,new V(1,1))||!X(this.rotation,0)}IsEqual(e){return!(this.name!==e.name||this.url!==e.url||!St(this.offset,e.offset)||!St(this.scale,e.scale)||!X(this.rotation,e.rotation))}};function Ft(s,e){return s===null&&e===null?!0:s===null||e===null?!1:s.IsEqual(e)}var Q={Phong:1,Physical:2},Fn=class{constructor(e){this.type=e,this.isDefault=!1,this.name="",this.color=new w(0,0,0),this.vertexColors=!1}IsEqual(e){return!(this.type!==e.type||this.isDefault!==e.isDefault||this.name!==e.name||!Dt(this.color,e.color)||this.vertexColors!==e.vertexColors)}},$i=class extends Fn{constructor(e){super(e);this.emissive=new w(0,0,0),this.opacity=1,this.transparent=!1,this.diffuseMap=null,this.bumpMap=null,this.normalMap=null,this.emissiveMap=null,this.alphaTest=0,this.multiplyDiffuseMap=!1}IsEqual(e){return!(!super.IsEqual(e)||!Dt(this.emissive,e.emissive)||!X(this.opacity,e.opacity)||this.transparent!==e.transparent||!Ft(this.diffuseMap,e.diffuseMap)||!Ft(this.bumpMap,e.bumpMap)||!Ft(this.normalMap,e.normalMap)||!Ft(this.emissiveMap,e.emissiveMap)||!X(this.alphaTest,e.alphaTest)||this.multiplyDiffuseMap!==e.multiplyDiffuseMap)}EnumerateTextureMaps(e){this.diffuseMap!==null&&e(this.diffuseMap),this.bumpMap!==null&&e(this.bumpMap),this.normalMap!==null&&e(this.normalMap),this.emissiveMap!==null&&e(this.emissiveMap)}},Y=class extends $i{constructor(){super(Q.Phong);this.ambient=new w(0,0,0),this.specular=new w(0,0,0),this.shininess=0,this.specularMap=null}IsEqual(e){return!(!super.IsEqual(e)||!Dt(this.ambient,e.ambient)||!Dt(this.specular,e.specular)||!X(this.shininess,e.shininess)||!Ft(this.specularMap,e.specularMap))}EnumerateTextureMaps(e){super.EnumerateTextureMaps(e),this.specularMap!==null&&e(this.specularMap)}},at=class extends $i{constructor(){super(Q.Physical);this.metalness=0,this.roughness=1,this.metalnessMap=null}IsEqual(e){return!(!super.IsEqual(e)||!X(this.metalness,e.metalness)||!X(this.roughness,e.roughness)||!Ft(this.metalnessMap,e.metalnessMap))}EnumerateTextureMaps(e){super.EnumerateTextureMaps(e),this.metalnessMap!==null&&e(this.metalnessMap)}};var Qe={Empty:0,TriangleMesh:1};function Nt(s){return s.TriangleCount()>0?Qe.TriangleMesh:Qe.Empty}function yi(s,e,t){let i=ie(e,s),r=ie(t,s),n=qe(i,r);return n.Normalize(),n}function ht(s,e){if(!e.IsIdentity()){for(let t=0;t<s.VertexCount();t++){let i=s.GetVertex(t),r=e.TransformCoord3D(i);i.x=r.x,i.y=r.y,i.z=r.z}if(s.NormalCount()>0){let t=e.GetMatrix().InvertTranspose();if(t!==null){let i=new j(t);for(let r=0;r<s.NormalCount();r++){let n=s.GetNormal(r),o=i.TransformCoord3D(n);n.x=o.x,n.y=o.y,n.z=o.z}}}}}function Nn(s){for(let e=0;e<s.TriangleCount();e++){let t=s.GetTriangle(e),i=t.v1;t.v1=t.v2,t.v2=i}}var bi=class{constructor(e,t){this.min=e,this.max=t}GetMin(){return this.min}GetMax(){return this.max}GetCenter(){return new I((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,(this.min.z+this.max.z)/2)}},er=class{constructor(){this.box=new bi(new I(1/0,1/0,1/0),new I(-1/0,-1/0,-1/0)),this.isValid=!1}GetBox(){return this.isValid?this.box:null}AddPoint(e){this.box.min.x=Math.min(this.box.min.x,e.x),this.box.min.y=Math.min(this.box.min.y,e.y),this.box.min.z=Math.min(this.box.min.z,e.z),this.box.max.x=Math.max(this.box.max.x,e.x),this.box.max.y=Math.max(this.box.max.y,e.y),this.box.max.z=Math.max(this.box.max.z,e.z),this.isValid=!0}};var Si=class{constructor(e,t){this.boundingBox=e,this.level=t,this.pointItems=[],this.childNodes=[]}AddPoint(e,t,i){let r=this.FindNodeForPoint(e);if(r===null||r.FindPointDirectly(e)!==null)return!1;if(r.pointItems.length<i.maxPointsPerNode||r.level>=i.maxTreeDepth)return r.AddPointDirectly(e,t),!0;{r.CreateChildNodes();let n=r.pointItems;r.pointItems=[];for(let o=0;o<n.length;o++){let l=n[o];if(!r.AddPoint(l.point,l.data,i))return!1}return r.AddPoint(e,t,i)}}FindPoint(e){let t=this.FindNodeForPoint(e);return t===null?null:t.FindPointDirectly(e)}AddPointDirectly(e,t){this.pointItems.push({point:e,data:t})}FindPointDirectly(e){for(let t=0;t<this.pointItems.length;t++){let i=this.pointItems[t];if(Be(e,i.point))return i.data}return null}FindNodeForPoint(e){if(!this.IsPointInBounds(e))return null;if(this.childNodes.length===0)return this;for(let t=0;t<this.childNodes.length;t++){let r=this.childNodes[t].FindNodeForPoint(e);if(r!==null)return r}return null}CreateChildNodes(){function e(l,a,h,u,d,m,f){let c=new bi(new I(a,h,u),new I(a+d,h+m,u+f));l.childNodes.push(new Si(c,l.level+1))}let t=this.boundingBox.min,i=this.boundingBox.GetCenter(),r=(this.boundingBox.max.x-this.boundingBox.min.x)/2,n=(this.boundingBox.max.y-this.boundingBox.min.y)/2,o=(this.boundingBox.max.z-this.boundingBox.min.z)/2;e(this,t.x,t.y,t.z,r,n,o),e(this,i.x,t.y,t.z,r,n,o),e(this,t.x,i.y,t.z,r,n,o),e(this,i.x,i.y,t.z,r,n,o),e(this,t.x,t.y,i.z,r,n,o),e(this,i.x,t.y,i.z,r,n,o),e(this,t.x,i.y,i.z,r,n,o),e(this,i.x,i.y,i.z,r,n,o)}IsPointInBounds(e){return ui(e.x,this.boundingBox.min.x)&&ui(e.y,this.boundingBox.min.y)&&ui(e.z,this.boundingBox.min.z)&&hi(e.x,this.boundingBox.max.x)&&hi(e.y,this.boundingBox.max.y)&&hi(e.z,this.boundingBox.max.z)}},tr=class{constructor(e,t){this.options={maxPointsPerNode:10,maxTreeDepth:10},t!==void 0&&(t.maxPointsPerNode!==void 0&&(this.options.maxPointsPerNode=t.maxPointsPerNode),t.maxTreeDepth!==void 0&&(this.options.maxTreeDepth=t.maxTreeDepth)),this.rootNode=new Si(e,0)}AddPoint(e,t){return this.rootNode.AddPoint(e,t,this.options)}FindPoint(e){return this.rootNode.FindPoint(e)}};var Vn=class{constructor(){this.edges=[],this.triangles=[]}},Ln=class{constructor(e,t){this.vertex1=e,this.vertex2=t,this.triangles=[]}},Bn=class{constructor(e,t){this.edge=e,this.reversed=t}},On=class{constructor(){this.triEdge1=null,this.triEdge2=null,this.triEdge3=null}},ir=class{constructor(){this.vertices=[],this.edges=[],this.triangleEdges=[],this.triangles=[],this.edgeStartToEndVertexMap=new Map}AddVertex(){return this.vertices.push(new Vn),this.vertices.length-1}AddTriangle(e,t,i){function r(h,u,d){h[u].triangles.push(d)}function n(h,u,d,m){let f=h[d],c=u[m];f.edges.push(c.edge)}function o(h,u,d,m){let f=u[d];h[f.edge].triangles.push(m)}let l=this.triangles.length,a=new On;a.triEdge1=this.AddTriangleEdge(e,t),a.triEdge2=this.AddTriangleEdge(t,i),a.triEdge3=this.AddTriangleEdge(i,e),r(this.vertices,e,l),r(this.vertices,t,l),r(this.vertices,i,l),n(this.vertices,this.triangleEdges,e,a.triEdge1),n(this.vertices,this.triangleEdges,t,a.triEdge2),n(this.vertices,this.triangleEdges,i,a.triEdge3),o(this.edges,this.triangleEdges,a.triEdge1,l),o(this.edges,this.triangleEdges,a.triEdge2,l),o(this.edges,this.triangleEdges,a.triEdge3,l),this.triangles.push(a)}AddTriangleEdge(e,t){let i=e,r=t,n=!1;t<e&&(i=t,r=e,n=!0);let o=this.AddEdge(i,r);return this.triangleEdges.push(new Bn(o,n)),this.triangleEdges.length-1}AddEdge(e,t){this.edgeStartToEndVertexMap.has(e)||this.edgeStartToEndVertexMap.set(e,[]);let i=this.edgeStartToEndVertexMap.get(e);for(let n=0;n<i.length;n++){let o=i[n];if(o.endVertex===t)return o.edgeIndex}let r=this.edges.length;return i.push({endVertex:t,edgeIndex:r}),this.edges.push(new Ln(e,t)),r}};function wi(s){let e=!0;return s.EnumerateMeshInstances(t=>{Nt(t)!==Qe.Empty&&(e=!1)}),e}function rr(s){let e=new er;return s.EnumerateVertices(t=>{e.AddPoint(t)}),e.GetBox()}function Hs(s){function e(n,o,l){let a=o.FindPoint(n);return a===null&&(a=l.AddVertex(),o.AddPoint(n,a)),a}let t=rr(s),i=new tr(t),r=new ir;return s.EnumerateTriangleVertices((n,o,l)=>{let a=e(n,i,r),h=e(o,i,r),u=e(l,i,r);r.AddTriangle(a,h,u)}),r}function kn(s){function e(i,r,n){let o=i.triangles[r],l=i.triangleEdges[o.triEdge1],a=i.triangleEdges[o.triEdge2],h=i.triangleEdges[o.triEdge3];return l.edge===n?l.reversed:a.edge===n?a.reversed:h.edge===n?h.reversed:null}let t=Hs(s);for(let i=0;i<t.edges.length;i++){let r=t.edges[i],n=r.triangles.length;if(n===0||n%2!==0)return!1;let o=0;for(let l=0;l<r.triangles.length;l++){let a=r.triangles[l];e(t,a,i)?o+=1:o-=1}if(o!==0)return!1}return!0}function Un(s){for(let e=0;e<s.MaterialCount();e++){let t=s.GetMaterial(e);if(t.isDefault&&!t.vertexColors)return!0}return!1}function nr(s,e){for(let t=0;t<s.MaterialCount();t++){let i=s.GetMaterial(t);i.isDefault&&(i.color=e)}}var D={Text:1,Integer:2,Number:3,Boolean:4,Percent:5,Color:6},F=class{constructor(e,t,i){this.type=e,this.name=t,this.value=i}},Ee=class{constructor(e){this.name=e,this.properties=[]}PropertyCount(){return this.properties.length}AddProperty(e){this.properties.push(e)}GetProperty(e){return this.properties[e]}};var Hn=class{constructor(){}VertexCount(){return 0}VertexColorCount(){return 0}NormalCount(){return 0}TextureUVCount(){return 0}TriangleCount(){return 0}EnumerateVertices(e){}EnumerateTriangleVertexIndices(e){}EnumerateTriangleVertices(e){}},ut=class extends Hn{constructor(){super();this.name="",this.propertyGroups=[]}GetName(){return this.name}SetName(e){this.name=e}PropertyGroupCount(){return this.propertyGroups.length}AddPropertyGroup(e){return this.propertyGroups.push(e),this.propertyGroups.length-1}GetPropertyGroup(e){return this.propertyGroups[e]}};var q=class extends ut{constructor(){super();this.vertices=[],this.vertexColors=[],this.normals=[],this.uvs=[],this.triangles=[]}VertexCount(){return this.vertices.length}VertexColorCount(){return this.vertexColors.length}NormalCount(){return this.normals.length}TextureUVCount(){return this.uvs.length}TriangleCount(){return this.triangles.length}AddVertex(e){return this.vertices.push(e),this.vertices.length-1}SetVertex(e,t){this.vertices[e]=t}GetVertex(e){return this.vertices[e]}AddVertexColor(e){return this.vertexColors.push(e),this.vertexColors.length-1}SetVertexColor(e,t){this.vertexColors[e]=t}GetVertexColor(e){return this.vertexColors[e]}AddNormal(e){return this.normals.push(e),this.normals.length-1}SetNormal(e,t){this.normals[e]=t}GetNormal(e){return this.normals[e]}AddTextureUV(e){return this.uvs.push(e),this.uvs.length-1}SetTextureUV(e,t){this.uvs[e]=t}GetTextureUV(e){return this.uvs[e]}AddTriangle(e){return this.triangles.push(e),this.triangles.length-1}GetTriangle(e){return this.triangles[e]}EnumerateVertices(e){for(let t of this.vertices)e(t)}EnumerateTriangleVertexIndices(e){for(let t of this.triangles)e(t.v0,t.v1,t.v2)}EnumerateTriangleVertices(e){for(let t of this.triangles){let i=this.vertices[t.v0],r=this.vertices[t.v1],n=this.vertices[t.v2];e(i,r,n)}}Clone(){let e=new q;e.SetName(this.GetName());for(let t=0;t<this.VertexCount();t++){let i=this.GetVertex(t);e.AddVertex(i.Clone())}for(let t=0;t<this.VertexColorCount();t++){let i=this.GetVertexColor(t);e.AddVertexColor(i.Clone())}for(let t=0;t<this.NormalCount();t++){let i=this.GetNormal(t);e.AddNormal(i.Clone())}for(let t=0;t<this.TextureUVCount();t++){let i=this.GetTextureUV(t);e.AddTextureUV(i.Clone())}for(let t=0;t<this.TriangleCount();t++){let i=this.GetTriangle(t);e.AddTriangle(i.Clone())}return e}};var k=class{constructor(e,t,i){this.v0=e,this.v1=t,this.v2=i,this.c0=null,this.c1=null,this.c2=null,this.n0=null,this.n1=null,this.n2=null,this.u0=null,this.u1=null,this.u2=null,this.mat=null,this.curve=null}HasVertices(){return this.v0!==null&&this.v1!==null&&this.v2!==null}HasVertexColors(){return this.c0!==null&&this.c1!==null&&this.c2!==null}HasNormals(){return this.n0!==null&&this.n1!==null&&this.n2!==null}HasTextureUVs(){return this.u0!==null&&this.u1!==null&&this.u2!==null}SetVertices(e,t,i){return this.v0=e,this.v1=t,this.v2=i,this}SetVertexColors(e,t,i){return this.c0=e,this.c1=t,this.c2=i,this}SetNormals(e,t,i){return this.n0=e,this.n1=t,this.n2=i,this}SetTextureUVs(e,t,i){return this.u0=e,this.u1=t,this.u2=i,this}SetMaterial(e){return this.mat=e,this}SetCurve(e){return this.curve=e,this}Clone(){let e=new k(this.v0,this.v1,this.v2);return e.SetVertexColors(this.c0,this.c1,this.c2),e.SetNormals(this.n0,this.n1,this.n2),e.SetTextureUVs(this.u0,this.u1,this.u2),e.SetMaterial(this.mat),e.SetCurve(this.curve),e}};function zn(){let s=document.createElement("canvas");document.body.appendChild(s);let e={canvas:s,antialias:!0},t=new THREE.WebGLRenderer(e);t.setClearColor("#ffffff",1),t.setSize(10,10);let i=new THREE.Scene,r=new THREE.AmbientLight(8947848);i.add(r);let n=new THREE.DirectionalLight(8947848);n.position.set(0,0,1),i.add(n);let o=new THREE.PerspectiveCamera(45,1,.1,1e3);o.position.set(0,0,1),o.up.set(0,1,0),o.lookAt(new THREE.Vector3(0,0,0)),i.add(o);let l=new THREE.PlaneGeometry(1,1),a=new THREE.Mesh(l,new THREE.MeshPhongMaterial({color:13369344}));i.add(a),t.render(i,o);let h=t.getContext(),u=new Uint8Array(4);h.readPixels(5,5,1,1,h.RGBA,h.UNSIGNED_BYTE,u),document.body.removeChild(s);let d=50;return u[0]<d&&u[1]<d&&u[2]<d}var he={Phong:1,Physical:2};function Wn(s){let e=0,t=0;for(let i=0;i<s.MaterialCount();i++){let r=s.GetMaterial(i);r.type===Q.Phong?e+=1:r.type===Q.Physical&&(t+=1)}return e>=t?he.Phong:he.Physical}function Ei(s){return Pe(s.r,s.g,s.b)}function Ae(s){return new THREE.Color(s.r/255,s.g/255,s.b/255)}function dt(s,e){let t=new q,i=s.attributes.position.array,r=s.attributes.position.itemSize||3;for(let h=0;h<i.length;h+=r){let u=i[h],d=i[h+1],m=i[h+2];t.AddVertex(new I(u,d,m))}let n=s.attributes.color!==void 0;if(n){let h=s.attributes.color.array,u=s.attributes.color.itemSize||3;for(let d=0;d<h.length;d+=u){let m=new THREE.Color(h[d],h[d+1],h[d+2]);t.AddVertexColor(Ei(m))}}let o=s.attributes.normal!==void 0;if(o){let h=s.attributes.normal.array,u=s.attributes.normal.itemSize||3;for(let d=0;d<h.length;d+=u){let m=h[d],f=h[d+1],c=h[d+2];t.AddNormal(new I(m,f,c))}}let l=s.attributes.uv!==void 0;if(l){let h=s.attributes.uv.array,u=s.attributes.uv.itemSize||2;for(let d=0;d<h.length;d+=u){let m=h[d],f=h[d+1];t.AddTextureUV(new V(m,f))}}let a=null;if(s.index!==null)a=s.index.array;else{a=[];for(let h=0;h<i.length/3;h++)a.push(h)}for(let h=0;h<a.length;h+=3){let u=a[h],d=a[h+1],m=a[h+2],f=new k(u,d,m);n&&f.SetVertexColors(u,d,m),o&&f.SetNormals(u,d,m),l&&f.SetTextureUVs(u,d,m),e!==null&&f.SetMaterial(e),t.AddTriangle(f)}return t}var $e=class{constructor(e,t){this.nodeId=e,this.meshIndex=t}IsEqual(e){return this.nodeId===e.nodeId&&this.meshIndex===e.meshIndex}GetKey(){return this.nodeId.toString()+":"+this.meshIndex.toString()}},Ai=class extends ut{constructor(e,t,i){super();this.id=e,this.node=t,this.mesh=i}GetId(){return this.id}GetTransformation(){return this.node.GetWorldTransformation()}GetMesh(){return this.mesh}VertexCount(){return this.mesh.VertexCount()}VertexColorCount(){return this.mesh.VertexColorCount()}NormalCount(){return this.mesh.NormalCount()}TextureUVCount(){return this.mesh.TextureUVCount()}TriangleCount(){return this.mesh.TriangleCount()}EnumerateVertices(e){let t=this.node.GetWorldTransformation();t.IsIdentity()?this.mesh.EnumerateVertices(e):this.mesh.EnumerateVertices(i=>{let r=t.TransformCoord3D(i);e(r)})}EnumerateTriangleVertexIndices(e){this.mesh.EnumerateTriangleVertexIndices(e)}EnumerateTriangleVertices(e){let t=this.node.GetWorldTransformation();t.IsIdentity()?this.mesh.EnumerateTriangleVertices(e):this.mesh.EnumerateTriangleVertices((i,r,n)=>{let o=t.TransformCoord3D(i),l=t.TransformCoord3D(r),a=t.TransformCoord3D(n);e(o,l,a)})}PropertyGroupCount(){return this.mesh.PropertyGroupCount()}AddPropertyGroup(e){return this.mesh.AddPropertyGroup(e)}GetPropertyGroup(e){return this.mesh.GetPropertyGroup(e)}GetTransformedMesh(){let e=this.node.GetWorldTransformation(),t=this.mesh.Clone();return ht(t,e),t}};var jn=class{constructor(){this.nextId=0}GenerateId(){let e=this.nextId;return this.nextId+=1,e}},ue={GroupNode:0,MeshNode:1},Me=class{constructor(){this.type=ue.GroupNode,this.name="",this.parent=null,this.transformation=new j,this.childNodes=[],this.meshIndices=[],this.idGenerator=new jn,this.id=this.idGenerator.GenerateId()}IsEmpty(){return this.childNodes.length===0&&this.meshIndices.length===0}GetType(){return this.type}SetType(e){this.type=e}GetId(){return this.id}GetName(){return this.name}SetName(e){this.name=e}HasParent(){return this.parent!==null}GetParent(){return this.parent}GetTransformation(){return this.transformation}GetWorldTransformation(){let e=this.transformation.Clone(),t=this.parent;for(;t!==null;)e.Append(t.transformation),t=t.parent;return e}SetTransformation(e){this.transformation=e}AddChildNode(e){return e.parent=this,e.idGenerator=this.idGenerator,e.id=e.idGenerator.GenerateId(),this.childNodes.push(e),this.childNodes.length-1}RemoveChildNode(e){e.parent=null;let t=this.childNodes.indexOf(e);this.childNodes.splice(t,1)}GetChildNodes(){return this.childNodes}ChildNodeCount(){return this.childNodes.length}GetChildNode(e){return this.childNodes[e]}AddMeshIndex(e){return this.meshIndices.push(e),this.meshIndices.length-1}MeshIndexCount(){return this.meshIndices.length}GetMeshIndex(e){return this.meshIndices[e]}GetMeshIndices(){return this.meshIndices}Enumerate(e){e(this);for(let t of this.childNodes)t.Enumerate(e)}EnumerateChildren(e){for(let t of this.childNodes)e(t),t.EnumerateChildren(e)}EnumerateMeshIndices(e){for(let t of this.meshIndices)e(t);for(let t of this.childNodes)t.EnumerateMeshIndices(e)}};var sr=class extends ut{constructor(){super();this.root=new Me,this.materials=[],this.meshes=[]}GetRootNode(){return this.root}MaterialCount(){return this.materials.length}MeshCount(){return this.meshes.length}MeshInstanceCount(){let e=0;return this.root.Enumerate(t=>{e+=t.MeshIndexCount()}),e}VertexCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.VertexCount()}),e}VertexColorCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.VertexColorCount()}),e}NormalCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.NormalCount()}),e}TextureUVCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.TextureUVCount()}),e}TriangleCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.TriangleCount()}),e}AddMaterial(e){return this.materials.push(e),this.materials.length-1}GetMaterial(e){return this.materials[e]}AddMesh(e){return this.meshes.push(e),this.meshes.length-1}AddMeshToRootNode(e){let t=this.AddMesh(e);return this.root.AddMeshIndex(t),t}RemoveMesh(e){this.meshes.splice(e,1),this.root.Enumerate(t=>{for(let i=0;i<t.meshIndices.length;i++)t.meshIndices[i]===e?(t.meshIndices.splice(i,1),i-=1):t.meshIndices[i]>e&&(t.meshIndices[i]-=1)})}GetMesh(e){return this.meshes[e]}GetMeshInstance(e){let t=null;if(this.root.Enumerate(o=>{o.GetId()===e.nodeId&&(t=o)}),t===null||t.GetMeshIndices().indexOf(e.meshIndex)===-1)return null;let r=this.GetMesh(e.meshIndex),n=new $e(t.GetId(),e.meshIndex);return new Ai(n,t,r)}EnumerateMeshes(e){for(let t of this.meshes)e(t)}EnumerateMeshInstances(e){this.root.Enumerate(t=>{for(let i of t.GetMeshIndices()){let r=new $e(t.GetId(),i),n=this.GetMesh(i),o=new Ai(r,t,n);e(o)}})}EnumerateTransformedMeshes(e){this.EnumerateMeshInstances(t=>{let i=t.GetTransformedMesh();e(i)})}EnumerateVertices(e){this.EnumerateMeshInstances(t=>{t.EnumerateVertices(e)})}EnumerateTriangleVertexIndices(e){this.EnumerateMeshInstances(t=>{t.EnumerateTriangleVertexIndices(e)})}EnumerateTriangleVertices(e){this.EnumerateMeshInstances(t=>{t.EnumerateTriangleVertices(e)})}};function Vt(s){return s!=null}function Ue(s,e){return s??e}function or(s,e){if(!!Vt(s))for(let t of Object.keys(s))Vt(s[t])&&(e[t]=s[t])}var qn=class{constructor(e){this.params={getDefaultMaterialColor:()=>new w(0,0,0)},or(e,this.params),this.defaultMaterialIndex=null}Finalize(e){this.Reset(),this.FinalizeMeshes(e),this.FinalizeMaterials(e),this.FinalizeNodes(e)}FinalizeMaterials(e){if(!(e.VertexColorCount()>0))return;let i=new Map;for(let r=0;r<e.MeshCount();r++){let n=e.GetMesh(r);for(let o=0;o<n.TriangleCount();o++){let l=n.GetTriangle(o),a=l.HasVertexColors();i.has(l.mat)?a||i.set(l.mat,!1):i.set(l.mat,a)}}for(let[r,n]of i){let o=e.GetMaterial(r);o.vertexColors=n}}FinalizeMeshes(e){for(let t=0;t<e.MeshCount();t++){let i=e.GetMesh(t);if(Nt(i)===Qe.Empty){e.RemoveMesh(t),t=t-1;continue}this.FinalizeMesh(e,i)}}FinalizeMesh(e,t){function i(n){function o(h,u,d,m,f){function c(x,M){for(let T=0;T<x.length;T++){let N=x[T];if(Be(N,M))return!0}return!1}let p=[],g=f.get(d);for(let x=0;x<g.length;x++){let M=g[x],T=h.GetTriangle(M);if(u.curve===T.curve){let N=m[M];c(p,N)||p.push(N)}}let v=new I(0,0,0);for(let x=0;x<p.length;x++)v=Mn(v,p[x]);return v.MultiplyScalar(1/p.length),v.Normalize(),h.AddNormal(v)}let l=[],a=new Map;for(let h=0;h<n.VertexCount();h++)a.set(h,[]);for(let h=0;h<n.TriangleCount();h++){let u=n.GetTriangle(h),d=n.GetVertex(u.v0),m=n.GetVertex(u.v1),f=n.GetVertex(u.v2),c=yi(d,m,f);l.push(c),a.get(u.v0).push(h),a.get(u.v1).push(h),a.get(u.v2).push(h)}for(let h=0;h<n.TriangleCount();h++){let u=n.GetTriangle(h);if(!u.HasNormals()){let d=o(n,u,u.v0,l,a),m=o(n,u,u.v1,l,a),f=o(n,u,u.v2,l,a);u.SetNormals(d,m,f)}}}let r={calculateCurveNormals:!1};for(let n=0;n<t.TriangleCount();n++){let o=t.GetTriangle(n);this.FinalizeTriangle(t,o,r),o.mat===null&&(o.mat=this.GetDefaultMaterialIndex(e))}r.calculateCurveNormals&&i(t)}FinalizeTriangle(e,t,i){if(!t.HasNormals())if(t.curve===null||t.curve===0){let r=e.GetVertex(t.v0),n=e.GetVertex(t.v1),o=e.GetVertex(t.v2),l=yi(r,n,o),a=e.AddNormal(l);t.SetNormals(a,a,a)}else i.calculateCurveNormals=!0;t.curve===null&&(t.curve=0)}FinalizeNodes(e){let t=e.GetRootNode(),i=[];t.EnumerateChildren(r=>{r.IsEmpty()&&i.push(r)});for(let r=0;r<i.length;r++){let n=i[r],o=n.GetParent();o!==null&&(o.RemoveChildNode(n),o.IsEmpty()&&i.push(o))}}GetDefaultMaterialIndex(e){if(this.defaultMaterialIndex===null){let t=this.params.getDefaultMaterialColor(),i=new Y;i.color=t,i.isDefault=!0,this.defaultMaterialIndex=e.AddMaterial(i)}return this.defaultMaterialIndex}Reset(){this.defaultMaterialIndex=null}};function Xn(s,e){new qn(e).Finalize(s)}var H=class{constructor(){this.name=null,this.extension=null,this.callbacks=null,this.model=null,this.error=null,this.message=null}Import(e,t,i,r){this.Clear(),this.name=e,this.extension=t,this.callbacks=r,this.model=new sr,this.error=!1,this.message=null,this.ResetContent(),this.ImportContent(i,()=>{this.CreateResult(r)})}Clear(){this.name=null,this.extension=null,this.callbacks=null,this.model=null,this.error=null,this.message=null,this.ClearContent()}CreateResult(e){if(this.error){e.onError(),e.onComplete();return}if(wi(this.model)){this.SetError("The model doesn't contain any meshes."),e.onError(),e.onComplete();return}Xn(this.model,{getDefaultMaterialColor:this.callbacks.getDefaultMaterialColor}),e.onSuccess(),e.onComplete()}CanImportExtension(e){return!1}GetUpDirection(){return S.Z}ClearContent(){}ResetContent(){}ImportContent(e,t){}GetModel(){return this.model}SetError(e){this.error=!0,e!=null&&(this.message=e)}WasError(){return this.error}GetErrorMessage(){return this.message}};function et(s,e,t){let i=s.substring(e),r=i.indexOf(t);return r!==-1&&(i=i.substring(0,r)),i.trim()}function Ke(s,e){if(e!==null){let t=s.indexOf(e);t!==-1&&(s=s.substring(0,t).trim())}return s.split(/\s+/u)}function Fe(s,e){function t(n,o){let l=n.trim();l.length>0&&o(l)}let i=0,r=s.indexOf(`
`,i);for(;r!==-1;)t(s.substring(i,r),e),i=r+1,r=s.indexOf(`
`,i);t(s.substring(i),e)}function de(s){s.transparent=!1,ai(s.opacity,1)&&(s.transparent=!0)}var lr=class{constructor(e){this.createMaterialFunc=e,this.colorToMaterialIndex=new Map}GetMaterialIndex(e){let t=le(e);if(this.colorToMaterialIndex.has(t))return this.colorToMaterialIndex.get(t);{let i=this.createMaterialFunc(e);return this.colorToMaterialIndex.set(t,i),i}}};var ar=class extends H{constructor(){super();this.rhino=null}CanImportExtension(e){return e==="3dm"}GetUpDirection(){return S.Z}ClearContent(){this.instanceIdToObject=null,this.instanceIdToDefinition=null}ResetContent(){this.instanceIdToObject=new Map,this.instanceIdToDefinition=new Map}ImportContent(e,t){this.rhino===null?Se("loaders/rhino3dm.min.js").then(()=>{rhino3dm().then(i=>{this.rhino=i,this.ImportRhinoContent(e),t()})}).catch(()=>{this.SetError("Failed to load rhino3dm."),t()}):(this.ImportRhinoContent(e),t())}ImportRhinoContent(e){let t=this.rhino.File3dm.fromByteArray(e);if(t===null){this.SetError("Failed to read Rhino file.");return}this.ImportRhinoDocument(t),wi(this.model)&&this.SetError("The model doesn't contain any 3D meshes. Try to save the model while you are in shaded view in Rhino.")}ImportRhinoDocument(e){this.InitRhinoInstances(e),this.ImportRhinoUserStrings(e),this.ImportRhinoGeometry(e)}InitRhinoInstances(e){let t=e.objects();for(let r=0;r<t.count;r++){let n=t.get(r),o=n.attributes();o.isInstanceDefinitionObject&&this.instanceIdToObject.set(o.id,n)}let i=e.instanceDefinitions();for(let r=0;r<i.count();r++){let n=i.get(r);this.instanceIdToDefinition.set(n.id,n)}}ImportRhinoUserStrings(e){let t=e.strings();if(t.count()>0){let i=new Ee("Document user texts");for(let r=0;r<t.count();r++){let n=t.get(r);i.AddProperty(new F(D.Text,n[0],n[1]))}this.model.AddPropertyGroup(i)}}ImportRhinoGeometry(e){let t=e.objects();for(let i=0;i<t.count;i++){let r=t.get(i);this.ImportRhinoGeometryObject(e,r,[])}}ImportRhinoGeometryObject(e,t,i){let r=t.geometry(),n=t.attributes(),o=r.objectType;if(n.isInstanceDefinitionObject&&i.length===0)return;let l=null,a=!1;if(o===this.rhino.ObjectType.Mesh)l=r,a=!1;else if(o===this.rhino.ObjectType.Extrusion)l=r.getMesh(this.rhino.MeshType.Any),a=!0;else if(o===this.rhino.ObjectType.Brep){l=new this.rhino.Mesh;let h=r.faces();for(let u=0;u<h.count;u++){let d=h.get(u),m=d.getMesh(this.rhino.MeshType.Any);m&&(l.append(m),m.delete()),d.delete()}h.delete(),l.compact(),a=!0}else if(o===this.rhino.ObjectType.SubD)r.subdivide(3),l=this.rhino.Mesh.createFromSubDControlNet(r),a=!0;else if(o===this.rhino.ObjectType.InstanceReference){let h=r.parentIdefId;if(this.instanceIdToDefinition.has(h)){let d=this.instanceIdToDefinition.get(h).getObjectIds();for(let m=0;m<d.length;m++){let f=d[m];if(this.instanceIdToObject.has(f)){let c=this.instanceIdToObject.get(f);i.push(t),this.ImportRhinoGeometryObject(e,c,i),i.pop()}}}}l!==null&&(this.ImportRhinoMesh(e,l,t,i),a&&l.delete())}ImportRhinoMesh(e,t,i,r){let n=i.attributes(),o=this.GetMaterialIndex(e,i,r),l=t.toThreejsJSON(),a=dt(l.data,o);a.SetName(n.name);let h=n.getUserStrings();if(h.length>0){let u=new Ee("User texts");for(let d=0;d<h.length;d++){let m=h[d];u.AddProperty(new F(D.Text,m[0],m[1]))}a.AddPropertyGroup(u)}if(r.length!==0){let u=new B().CreateIdentity();for(let m=r.length-1;m>=0;m--){let p=r[m].geometry().xform.toFloatArray(!1),g=new B(p);u=u.MultiplyMatrix(g)}let d=new j(u);ht(a,d)}this.model.AddMeshToRootNode(a)}GetMaterialIndex(e,t,i){function r(a,h,u){let d=h.attributes();if(d.materialSource===a.ObjectMaterialSource.MaterialFromObject){let m=d.materialIndex;if(m>-1)return e.materials().get(m)}else if(d.materialSource===a.ObjectMaterialSource.MaterialFromLayer){let m=d.layerIndex;if(m>-1){let c=e.layers().get(m).renderMaterialIndex;if(c>-1)return e.materials().get(c)}}else if(d.materialSource===a.ObjectMaterialSource.MaterialFromParent&&u.length!==0)return r(a,u[0],[]);return null}function n(a,h){function u(g,v){g.Set(v.r,v.g,v.b)}function d(g){return g.r===0&&g.g===0&&g.b===0}function m(g){return g.r===255&&g.g===255&&g.b===255}let f=null,c=a.physicallyBased();c.supported?(f=new at,f.metalness=c.metallic?1:0,f.roughness=c.roughness):(f=new Y,u(f.ambient,a.ambientColor),u(f.specular,a.specularColor)),f.name=a.name,u(f.color,a.diffuseColor),f.opacity=1-a.transparency,de(f),d(f.color)&&!m(a.reflectionColor)&&u(f.color,a.reflectionColor),d(f.color)&&!m(a.transparentColor)&&u(f.color,a.transparentColor);let p=a.getBitmapTexture();if(p){let g=new Re,v=re(p.fileName),x=h.getTextureBuffer(v);g.name=v,x!==null&&(g.url=x.url,g.buffer=x.buffer),f.diffuseMap=g}return f}function o(a,h,u){let d=n(h,u);for(let m=0;m<a.MaterialCount();m++)if(a.GetMaterial(m).IsEqual(d))return m;return a.AddMaterial(d)}let l=r(this.rhino,t,i);return l===null?null:o(this.model,l,this.callbacks)}};var De=class{constructor(e,t){this.arrayBuffer=e,this.dataView=new DataView(e),this.isLittleEndian=t,this.position=0}GetPosition(){return this.position}SetPosition(e){this.position=e}GetByteLength(){return this.arrayBuffer.byteLength}Skip(e){this.position=this.position+e}End(){return this.position>=this.arrayBuffer.byteLength}ReadArrayBuffer(e){let t=new Uint8Array(this.arrayBuffer),i=new ArrayBuffer(e),r=new Uint8Array(i),n=t.subarray(this.position,this.position+e);return r.set(n,0),this.position+=e,i}ReadBoolean8(){let e=this.dataView.getInt8(this.position);return this.position=this.position+1,!!e}ReadCharacter8(){let e=this.dataView.getInt8(this.position);return this.position=this.position+1,e}ReadUnsignedCharacter8(){let e=this.dataView.getUint8(this.position);return this.position=this.position+1,e}ReadInteger16(){let e=this.dataView.getInt16(this.position,this.isLittleEndian);return this.position=this.position+2,e}ReadUnsignedInteger16(){let e=this.dataView.getUint16(this.position,this.isLittleEndian);return this.position=this.position+2,e}ReadInteger32(){let e=this.dataView.getInt32(this.position,this.isLittleEndian);return this.position=this.position+4,e}ReadUnsignedInteger32(){let e=this.dataView.getUint32(this.position,this.isLittleEndian);return this.position=this.position+4,e}ReadFloat32(){let e=this.dataView.getFloat32(this.position,this.isLittleEndian);return this.position=this.position+4,e}ReadDouble64(){let e=this.dataView.getFloat64(this.position,this.isLittleEndian);return this.position=this.position+8,e}};var E={MAIN3DS:19789,EDIT3DS:15677,EDIT_MATERIAL:45055,MAT_NAME:40960,MAT_AMBIENT:40976,MAT_DIFFUSE:40992,MAT_SPECULAR:41008,MAT_SHININESS:41024,MAT_SHININESS_STRENGTH:41025,MAT_TRANSPARENCY:41040,MAT_COLOR_F:16,MAT_COLOR:17,MAT_LIN_COLOR:18,MAT_LIN_COLOR_F:19,MAT_TEXMAP:41472,MAT_TEXMAP_NAME:41728,MAT_TEXMAP_UOFFSET:41816,MAT_TEXMAP_VOFFSET:41818,MAT_TEXMAP_USCALE:41812,MAT_TEXMAP_VSCALE:41814,MAT_TEXMAP_ROTATION:41820,PERCENTAGE:48,PERCENTAGE_F:49,EDIT_OBJECT:16384,OBJ_TRIMESH:16640,OBJ_LIGHT:17920,OBJ_CAMERA:18176,TRI_VERTEX:16656,TRI_TEXVERTEX:16704,TRI_FACE:16672,TRI_TRANSFORMATION:16736,TRI_MATERIAL:16688,TRI_SMOOTH:16720,KF3DS:45056,OBJECT_NODE:45058,OBJECT_HIERARCHY:45072,OBJECT_INSTANCE_NAME:45073,OBJECT_PIVOT:45075,OBJECT_POSITION:45088,OBJECT_ROTATION:45089,OBJECT_SCALE:45090,OBJECT_ID:45104},Yn=class{constructor(){this.id=-1,this.name="",this.flags=-1,this.parentId=-1,this.instanceName="",this.pivot=[0,0,0],this.positions=[],this.rotations=[],this.scales=[]}},Kn=class{constructor(){this.nodes=[],this.nodeIdToNode=new Map}IsEmpty(){return this.nodes.length===0}AddNode(e){this.nodes.push(e),this.nodeIdToNode.set(e.nodeId,e)}GetNodes(){return this.nodes}},hr=class extends H{constructor(){super()}CanImportExtension(e){return e==="3ds"}GetUpDirection(){return S.Z}ClearContent(){this.materialNameToIndex=null,this.meshNameToIndex=null,this.nodeList=null}ResetContent(){this.materialNameToIndex=new Map,this.meshNameToIndex=new Map,this.nodeList=new Kn}ImportContent(e,t){this.ProcessBinary(e),t()}ProcessBinary(e){let t=new De(e,!0),i=t.GetByteLength();this.ReadChunks(t,i,(r,n)=>{r===E.MAIN3DS?this.ReadMainChunk(t,n):this.SkipChunk(t,n)})}ReadMainChunk(e,t){let i=this.GetChunkEnd(e,t);this.ReadChunks(e,i,(r,n)=>{r===E.EDIT3DS?this.ReadEditorChunk(e,n):r===E.KF3DS?this.ReadKeyFrameChunk(e,n):this.SkipChunk(e,n)}),this.BuildNodeHierarchy()}ReadEditorChunk(e,t){let i=this.GetChunkEnd(e,t);this.ReadChunks(e,i,(r,n)=>{r===E.EDIT_MATERIAL?this.ReadMaterialChunk(e,n):r===E.EDIT_OBJECT?this.ReadObjectChunk(e,n):this.SkipChunk(e,n)})}ReadMaterialChunk(e,t){let i=new Y,r=this.GetChunkEnd(e,t),n=null,o=null;this.ReadChunks(e,r,(a,h)=>{a===E.MAT_NAME?i.name=this.ReadName(e):a===E.MAT_AMBIENT?i.ambient=this.ReadColorChunk(e,h):a===E.MAT_DIFFUSE?i.color=this.ReadColorChunk(e,h):a===E.MAT_SPECULAR?i.specular=this.ReadColorChunk(e,h):a===E.MAT_SHININESS?n=this.ReadPercentageChunk(e,h):a===E.MAT_SHININESS_STRENGTH?o=this.ReadPercentageChunk(e,h):a===E.MAT_TRANSPARENCY?(i.opacity=1-this.ReadPercentageChunk(e,h),de(i)):a===E.MAT_TEXMAP?(i.diffuseMap=this.ReadTextureMapChunk(e,h),de(i)):this.SkipChunk(e,h)}),n!==null&&o!==null&&(i.shininess=n*o/10);let l=this.model.AddMaterial(i);this.materialNameToIndex.set(i.name,l)}ReadTextureMapChunk(e,t){let i=new Re,r=this.GetChunkEnd(e,t);return this.ReadChunks(e,r,(n,o)=>{if(n===E.MAT_TEXMAP_NAME){let l=this.ReadName(e),a=this.callbacks.getTextureBuffer(l);i.name=l,a!==null&&(i.url=a.url,i.buffer=a.buffer)}else n===E.MAT_TEXMAP_UOFFSET?i.offset.x=e.ReadFloat32():n===E.MAT_TEXMAP_VOFFSET?i.offset.y=e.ReadFloat32():n===E.MAT_TEXMAP_USCALE?i.scale.x=e.ReadFloat32():n===E.MAT_TEXMAP_VSCALE?i.scale.y=e.ReadFloat32():n===E.MAT_TEXMAP_ROTATION?i.rotation=e.ReadFloat32()*bt:this.SkipChunk(e,o)}),i}ReadColorChunk(e,t){let i=new w(0,0,0),r=this.GetChunkEnd(e,t),n=!1;return this.ReadChunks(e,r,(o,l)=>{o===E.MAT_COLOR?n||(i.r=e.ReadUnsignedCharacter8(),i.g=e.ReadUnsignedCharacter8(),i.b=e.ReadUnsignedCharacter8()):o===E.MAT_LIN_COLOR?(i.r=e.ReadUnsignedCharacter8(),i.g=e.ReadUnsignedCharacter8(),i.b=e.ReadUnsignedCharacter8(),n=!0):o===E.MAT_COLOR_F?n||(i.r=we(e.ReadFloat32()),i.g=we(e.ReadFloat32()),i.b=we(e.ReadFloat32())):o===E.MAT_LIN_COLOR_F?(i.r=we(e.ReadFloat32()),i.g=we(e.ReadFloat32()),i.b=we(e.ReadFloat32()),n=!0):this.SkipChunk(e,l)}),i}ReadPercentageChunk(e,t){let i=0,r=this.GetChunkEnd(e,t);return this.ReadChunks(e,r,(n,o)=>{n===E.PERCENTAGE?i=e.ReadUnsignedInteger16()/100:n===E.PERCENTAGE_F?i=e.ReadFloat32():this.SkipChunk(e,o)}),i}ReadObjectChunk(e,t){let i=this.GetChunkEnd(e,t),r=this.ReadName(e);this.ReadChunks(e,i,(n,o)=>{n===E.OBJ_TRIMESH?this.ReadMeshChunk(e,o,r):this.SkipChunk(e,o)})}ReadMeshChunk(e,t,i){function r(u,d){if(!d.IsValid())return;let m=d.Determinant(),f=nt(m);f&&(d=new B().CreateScale(-1,1,1).MultiplyMatrix(d));let c=d.Invert();if(c===null)return;let p=new j(c);ht(u,p),f&&Nn(u)}let n=new q;n.SetName(i);let o=this.GetChunkEnd(e,t),l=null;if(this.ReadChunks(e,o,(u,d)=>{u===E.TRI_VERTEX?this.ReadVerticesChunk(n,e):u===E.TRI_TEXVERTEX?this.ReadTextureVerticesChunk(n,e):u===E.TRI_FACE?this.ReadFacesChunk(n,e,d):u===E.TRI_TRANSFORMATION?l=this.ReadTransformationChunk(e):this.SkipChunk(e,d)}),n.VertexCount()===n.TextureUVCount())for(let u=0;u<n.TriangleCount();u++){let d=n.GetTriangle(u);d.SetTextureUVs(d.v0,d.v1,d.v2)}let a=new B(l);r(n,a);let h=this.model.AddMesh(n);this.meshNameToIndex.set(n.GetName(),h)}ReadVerticesChunk(e,t){let i=t.ReadUnsignedInteger16();for(let r=0;r<i;r++){let n=t.ReadFloat32(),o=t.ReadFloat32(),l=t.ReadFloat32();e.AddVertex(new I(n,o,l))}}ReadTextureVerticesChunk(e,t){let i=t.ReadUnsignedInteger16();for(let r=0;r<i;r++){let n=t.ReadFloat32(),o=t.ReadFloat32();e.AddTextureUV(new V(n,o))}}ReadFacesChunk(e,t,i){let r=this.GetChunkEnd(t,i),n=t.ReadUnsignedInteger16();for(let o=0;o<n;o++){let l=t.ReadUnsignedInteger16(),a=t.ReadUnsignedInteger16(),h=t.ReadUnsignedInteger16();t.ReadUnsignedInteger16(),e.AddTriangle(new k(l,a,h))}this.ReadChunks(t,r,(o,l)=>{o===E.TRI_MATERIAL?this.ReadFaceMaterialsChunk(e,t):o===E.TRI_SMOOTH?this.ReadFaceSmoothingGroupsChunk(e,n,t):this.SkipChunk(t,l)})}ReadFaceMaterialsChunk(e,t){let i=this.ReadName(t),r=this.materialNameToIndex.get(i),n=t.ReadUnsignedInteger16();for(let o=0;o<n;o++){let l=t.ReadUnsignedInteger16(),a=e.GetTriangle(l);r!==void 0&&(a.mat=r)}}ReadFaceSmoothingGroupsChunk(e,t,i){for(let r=0;r<t;r++){let n=i.ReadUnsignedInteger32(),o=e.GetTriangle(r);o.curve=n}}ReadTransformationChunk(e){let t=[];for(let i=0;i<4;i++){for(let r=0;r<3;r++)t.push(e.ReadFloat32());i<3?t.push(0):t.push(1)}return t}ReadKeyFrameChunk(e,t){let i=this.GetChunkEnd(e,t);this.ReadChunks(e,i,(r,n)=>{r===E.OBJECT_NODE?this.ReadObjectNodeChunk(e,n):this.SkipChunk(e,n)})}BuildNodeHierarchy(){function e(i,r){function n(h){return h.positions.length===0?[0,0,0]:h.positions[0]}function o(h){function u(m){let f=[0,0,0,1],c=Math.sqrt(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]);if(c>0){let p=m[3]*-.5,g=Math.sin(p)/c;f=[g*m[0],g*m[1],g*m[2],Math.cos(p)]}return f}if(h.rotations.length===0)return[0,0,0,1];let d=h.rotations[0];return u(d)}function l(h){return h.scales.length===0?[1,1,1]:h.scales[0]}let a=new B;if(a.ComposeTRS(Xe(n(i)),Rt(o(i)),Xe(l(i))),r){let h=i.pivot;a=new B().CreateTranslation(-h[0],-h[1],-h[2]).MultiplyMatrix(a)}return new j(a)}let t=this.model.GetRootNode();if(this.nodeList.IsEmpty())for(let i=0;i<this.model.MeshCount();i++)t.AddMeshIndex(i);else{let i=new Map;for(let r of this.nodeList.GetNodes()){let n=new Me;r.name.length>0&&r.name!=="$$$DUMMY"&&(n.SetName(r.name),r.instanceName.length>0&&n.SetName(n.GetName()+" "+r.instanceName)),r.parentId===65535||!i.has(r.parentId)?t.AddChildNode(n):i.get(r.parentId).AddChildNode(n),i.set(r.id,n);let o=this.meshNameToIndex.has(r.name);n.SetTransformation(e(r,o)),o&&(n.SetType(ue.MeshNode),n.AddMeshIndex(this.meshNameToIndex.get(r.name)))}}}ReadObjectNodeChunk(e,t){function i(o,l,a){let h=[];l.Skip(10);let u=l.ReadInteger32();for(let d=0;d<u;d++){l.ReadInteger32(),l.ReadUnsignedInteger16()!==0&&l.ReadFloat32();let f=null;if(a===E.OBJECT_ROTATION){let c=l.ReadFloat32();f=o.ReadVector(l),f[3]=c}else f=o.ReadVector(l);h.push(f)}return h}let r=new Yn,n=this.GetChunkEnd(e,t);this.ReadChunks(e,n,(o,l)=>{o===E.OBJECT_HIERARCHY?(r.name=this.ReadName(e),r.flags=e.ReadUnsignedInteger32(),r.parentId=e.ReadUnsignedInteger16()):o===E.OBJECT_INSTANCE_NAME?r.instanceName=this.ReadName(e):o===E.OBJECT_PIVOT?r.pivot=this.ReadVector(e):o===E.OBJECT_POSITION?r.positions=i(this,e,E.OBJECT_POSITION):o===E.OBJECT_ROTATION?r.rotations=i(this,e,E.OBJECT_ROTATION):o===E.OBJECT_SCALE?r.scales=i(this,e,E.OBJECT_SCALE):o===E.OBJECT_ID?r.id=e.ReadUnsignedInteger16():this.SkipChunk(e,l)}),this.nodeList.AddNode(r)}ReadName(e){let t="",i=0,r=0;for(;r<64&&(i=e.ReadCharacter8(),i!==0);)t=t+String.fromCharCode(i),r=r+1;return t}ReadVector(e){return[e.ReadFloat32(),e.ReadFloat32(),e.ReadFloat32()]}ReadChunks(e,t,i){for(;e.GetPosition()<=t-6;){let r=e.ReadUnsignedInteger16(),n=e.ReadUnsignedInteger32();i(r,n)}}GetChunkEnd(e,t){return e.GetPosition()+t-6}SkipChunk(e,t){e.Skip(t-6)}};var ye={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126},Ne={SCALAR:0,VEC2:1,VEC3:2,VEC4:3,MAT2:4,MAT3:5,MAT4:6},mt={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},ur={GLTF_STRING:1179937895,JSON_CHUNK_TYPE:1313821514,BINARY_CHUNK_TYPE:5130562};function Wt(s){return Pe(Ut(s[0]),Ut(s[1]),Ut(s[2]))}function zs(s,e){function t(i,r){let n=i;return r!==ye.FLOAT&&(n/=255),we(Ut(n))}return new w(t(s[0],e),t(s[1],e),t(s[2],e))}var Jn=class{constructor(e){this.reader=new De(e,!0),this.componentType=null,this.dataType=null,this.byteStride=null,this.dataCount=null,this.sparseReader=null}SetComponentType(e){this.componentType=e}SetDataType(e){e==="SCALAR"?this.dataType=Ne.SCALAR:e==="VEC2"?this.dataType=Ne.VEC2:e==="VEC3"?this.dataType=Ne.VEC3:e==="VEC4"?this.dataType=Ne.VEC4:e==="MAT2"?this.dataType=Ne.MAT2:e==="MAT3"?this.dataType=Ne.MAT3:e==="MAT4"&&(this.dataType=Ne.MAT4)}SetByteStride(e){this.byteStride=e}SetDataCount(e){this.dataCount=e}SetSparseReader(e,t){this.sparseReader={indexReader:e,valueReader:t}}ReadArrayBuffer(e){return this.reader.ReadArrayBuffer(e)}GetDataCount(){return this.dataCount}ReadData(){if(this.dataType===null)return null;if(this.dataType===Ne.SCALAR){let e=this.ReadComponent();return this.SkipBytesByStride(1),e}else if(this.dataType===Ne.VEC2){let e=this.ReadComponent(),t=this.ReadComponent();return this.SkipBytesByStride(2),new V(e,t)}else if(this.dataType===Ne.VEC3){let e=this.ReadComponent(),t=this.ReadComponent(),i=this.ReadComponent();return this.SkipBytesByStride(3),new I(e,t,i)}else if(this.dataType===Ne.VEC4){let e=this.ReadComponent(),t=this.ReadComponent(),i=this.ReadComponent(),r=this.ReadComponent();return this.SkipBytesByStride(4),new ke(e,t,i,r)}return null}EnumerateData(e){if(this.sparseReader===null)for(let t=0;t<this.dataCount;t++)e(this.ReadData());else{let t=[];for(let r=0;r<this.sparseReader.indexReader.GetDataCount();r++){let n=this.sparseReader.indexReader.ReadData(),o=this.sparseReader.valueReader.ReadData();t.push({index:n,value:o})}let i=0;for(let r=0;r<this.dataCount;r++){let n=this.ReadData();i<t.length&&t[i].index===r?(e(t[i].value),i+=1):e(n)}}}SkipBytes(e){this.reader.Skip(e)}ReadComponent(){return this.componentType===null?null:this.componentType===ye.BYTE?this.reader.ReadCharacter8():this.componentType===ye.UNSIGNED_BYTE?this.reader.ReadUnsignedCharacter8():this.componentType===ye.SHORT?this.reader.ReadInteger16():this.componentType===ye.UNSIGNED_SHORT?this.reader.ReadUnsignedInteger16():this.componentType===ye.UNSIGNED_INT?this.reader.ReadInteger32():this.componentType===ye.FLOAT?this.reader.ReadFloat32():null}SkipBytesByStride(e){if(this.byteStride===null)return;let t=e*this.GetComponentSize();this.reader.Skip(this.byteStride-t)}GetComponentSize(){return this.componentType===ye.BYTE||this.componentType===ye.UNSIGNED_BYTE?1:this.componentType===ye.SHORT||this.componentType===ye.UNSIGNED_SHORT?2:this.componentType===ye.UNSIGNED_INT||this.componentType===ye.FLOAT?4:0}},Zn=class{constructor(){this.supportedExtensions=["KHR_draco_mesh_compression","KHR_materials_pbrSpecularGlossiness","KHR_texture_transform"],this.draco=null}LoadLibraries(e,t){if(e===void 0){t.onSuccess();return}this.draco===null&&e.indexOf("KHR_draco_mesh_compression")!==-1?Se("loaders/draco_decoder.js").then(()=>{DracoDecoderModule().then(i=>{this.draco=i,t.onSuccess()})}).catch(()=>{t.onError("Failed to load draco decoder.")}):t.onSuccess()}GetUnsupportedExtensions(e){let t=[];if(e===void 0)return t;for(let i=0;i<e.length;i++){let r=e[i];this.supportedExtensions.indexOf(r)===-1&&t.push(r)}return t}ProcessMaterial(e,t,i){if(e.extensions===void 0)return null;let r=e.extensions.KHR_materials_pbrSpecularGlossiness;if(r===void 0)return null;let n=new Y,o=r.diffuseFactor;o!==void 0&&(n.color=Wt(o),n.opacity=o[3]);let l=r.diffuseTexture;l!==void 0&&(n.diffuseMap=i(l));let a=r.specularFactor;a!==void 0&&(n.specular=Wt(a));let h=r.specularGlossinessTexture;h!==void 0&&(n.specularMap=i(h));let u=r.glossinessFactor;return u!==void 0&&(n.shininess=u),n}ProcessTexture(e,t){if(e.extensions===void 0)return;let i=e.extensions.KHR_texture_transform;i!==void 0&&(i.offset!==void 0&&(t.offset.x=i.offset[0],t.offset.y=-i.offset[1]),i.scale!==void 0&&(t.scale.x=i.scale[0],t.scale.y=i.scale[1]),i.rotation!==void 0&&(t.rotation=-i.rotation))}ProcessPrimitive(e,t,i,r){function n(G,P,_,se,O){let ve=P.GetAttributeByUniqueId(_,se),Ve=ve.num_components(),It=_.num_points()*Ve,Tt=It*4,rt=G._malloc(Tt);P.GetAttributeDataArrayForAllPoints(_,ve,G.DT_FLOAT32,Tt,rt);let $=new Float32Array(G.HEAPF32.buffer,rt,It).slice();if(Ve===2)for(let W=0;W<$.length;W+=2)O(new V($[W+0],$[W+1]));else if(Ve===3)for(let W=0;W<$.length;W+=3)O(new I($[W+0],$[W+1],$[W+2]));else if(Ve===4)for(let W=0;W<$.length;W+=4)O(new ke($[W+0],$[W+1],$[W+2],$[W+3]));G._free(rt)}if(this.draco===null||i.extensions===void 0||i.extensions.KHR_draco_mesh_compression===void 0)return!1;let o=new this.draco.Decoder,l=new this.draco.DecoderBuffer,a=i.extensions.KHR_draco_mesh_compression,h=t.bufferViews[a.bufferView],d=e.GetReaderFromBufferView(h).ReadArrayBuffer(h.byteLength);if(l.Init(new Int8Array(d),d.byteLength),o.GetEncodedGeometryType(l)!==this.draco.TRIANGULAR_MESH)return!0;let f=new this.draco.Mesh;if(!o.DecodeBufferToMesh(l,f).ok())return!0;let p=a.attributes.POSITION!==void 0,g=!1,v=a.attributes.NORMAL!==void 0,x=a.attributes.TEXCOORD_0!==void 0;if(!p)return!0;let M=r.VertexCount(),T=r.VertexColorCount(),N=r.NormalCount(),L=r.TextureUVCount();n(this.draco,o,f,a.attributes.POSITION,G=>{r.AddVertex(G)}),v&&n(this.draco,o,f,a.attributes.NORMAL,G=>{r.AddNormal(G)}),x&&n(this.draco,o,f,a.attributes.TEXCOORD_0,G=>{G.y=-G.y,r.AddTextureUV(G)});let U=f.num_faces()*3,b=U*4,A=this.draco._malloc(b);o.GetTrianglesUInt32Array(f,b,A);let z=new Uint32Array(this.draco.HEAPU32.buffer,A,U).slice();for(let G=0;G<z.length;G+=3){let P=z[G],_=z[G+1],se=z[G+2];e.AddTriangle(i,r,P,_,se,g,v,x,M,T,N,L)}return this.draco._free(A),!0}},dr=class extends H{constructor(){super();this.gltfExtensions=new Zn}CanImportExtension(e){return e==="gltf"||e==="glb"}GetUpDirection(){return S.Y}ClearContent(){this.bufferContents=null,this.imageIndexToTextureParams=null}ResetContent(){this.bufferContents=[],this.imageIndexToTextureParams=new Map}ImportContent(e,t){this.extension==="gltf"?this.ProcessGltf(e,t):this.extension==="glb"&&this.ProcessBinaryGltf(e,t)}ProcessGltf(e,t){let i=te(e),r=JSON.parse(i);if(r.asset.version!=="2.0"){this.SetError("Invalid glTF version."),t();return}for(let n=0;n<r.buffers.length;n++){let o=null,l=r.buffers[n],a=Ht(l.uri);if(a!==null)o=a.buffer;else{let h=this.callbacks.getFileBuffer(l.uri);h!==null&&(o=h)}if(o===null){this.SetError("One of the requested buffers is missing."),t();return}this.bufferContents.push(o)}this.ProcessMainFile(r,t)}ProcessBinaryGltf(e,t){function i(h){let u=h.ReadUnsignedInteger32(),d=h.ReadUnsignedInteger32(),m=h.ReadArrayBuffer(u);return{type:d,buffer:m}}let r=new De(e,!0);if(r.ReadUnsignedInteger32()!==ur.GLTF_STRING){this.SetError("Invalid glTF file."),t();return}if(r.ReadUnsignedInteger32()!==2){this.SetError("Invalid glTF version."),t();return}if(r.ReadUnsignedInteger32()!==r.GetByteLength()){this.SetError("Invalid glTF file."),t();return}let a=null;for(;!r.End();){let h=i(r);h.type===ur.JSON_CHUNK_TYPE?a=te(h.buffer):h.type===ur.BINARY_CHUNK_TYPE&&this.bufferContents.push(h.buffer)}if(a!==null){let h=JSON.parse(a);this.ProcessMainFile(h,t)}}ProcessMainFile(e,t){let i=this.gltfExtensions.GetUnsupportedExtensions(e.extensionsRequired);if(i.length>0){this.SetError("Unsupported extension: "+i.join(", ")+"."),t();return}this.gltfExtensions.LoadLibraries(e.extensionsRequired,{onSuccess:()=>{this.ImportModel(e),t()},onError:r=>{this.SetError(r),t()}})}ImportModel(e){let t=e.materials;if(t!==void 0)for(let r of t)this.ImportMaterial(e,r);let i=e.meshes;if(i!==void 0)for(let r of i)this.ImportMesh(e,r);this.ImportNodes(e),this.ImportModelProperties(e)}ImportModelProperties(e){function t(i,r,n){let o=new Ee(r);for(let l in n)if(Object.prototype.hasOwnProperty.call(n,l)&&typeof n[l]=="string"){let a=new F(D.Text,l,n[l]);o.AddProperty(a)}return o.PropertyCount()>0&&i.AddPropertyGroup(o),o}t(this.model,"Asset properties",e.asset),e.asset.extras&&t(this.model,"Extras",e.asset.extras)}GetDefaultScene(e){let t=e.scene||0;return t>=e.scenes.length?null:e.scenes[t]}ImportMaterial(e,t){let i=new at;if(t.name!==void 0&&(i.name=t.name),i.color=Wt([1,1,1]),t.pbrMetallicRoughness!==void 0){let n=t.pbrMetallicRoughness.baseColorFactor;n!==void 0&&(i.color=Wt(n),i.opacity=n[3]);let o=t.pbrMetallicRoughness.metallicFactor;o!==void 0&&(i.metalness=o);let l=t.pbrMetallicRoughness.roughnessFactor;l!==void 0&&(i.roughness=l);let a=t.emissiveFactor;a!==void 0&&(i.emissive=Wt(a)),i.diffuseMap=this.ImportTexture(e,t.pbrMetallicRoughness.baseColorTexture),i.metalnessMap=this.ImportTexture(e,t.pbrMetallicRoughness.metallicRoughnessTexture),i.normalMap=this.ImportTexture(e,t.normalTexture),i.emissiveMap=this.ImportTexture(e,t.emissiveTexture),i.diffuseMap!==null&&(i.multiplyDiffuseMap=!0);let h=t.alphaMode;h!==void 0&&(h==="BLEND"?i.transparent=!0:h==="MASK"&&(i.transparent=!0,i.alphaTest=t.alphaCutoff||.5))}let r=this.gltfExtensions.ProcessMaterial(t,i,n=>this.ImportTexture(e,n));r!==null&&(i=r),this.model.AddMaterial(i)}ImportTexture(e,t){if(t==null)return null;let i=new Re,n=e.textures[t.index].source,o=e.images[n],l=null;if(this.imageIndexToTextureParams.has(n))l=this.imageIndexToTextureParams.get(n);else{l={name:null,url:null,buffer:null};let a=n.toString();if(o.uri!==void 0){let h=Ht(o.uri);if(h!==null)l.name="Embedded_"+a+"."+Gt(h.mimeType),l.url=qi(h.buffer,h.mimeType),l.buffer=h.buffer;else{let u=this.callbacks.getTextureBuffer(o.uri);l.name=o.uri,u!==null&&(l.url=u.url,l.buffer=u.buffer)}}else if(o.bufferView!==void 0){let h=e.bufferViews[o.bufferView],u=this.GetReaderFromBufferView(h);if(u!==null){let d=u.ReadArrayBuffer(h.byteLength);l.name="Binary_"+a+"."+Gt(o.mimeType),l.url=qi(d,o.mimeType),l.buffer=d}}this.imageIndexToTextureParams.set(n,l)}return i.name=l.name,i.url=l.url,i.buffer=l.buffer,this.gltfExtensions.ProcessTexture(t,i),i}ImportMesh(e,t){let i=new q;this.model.AddMesh(i),t.name!==void 0&&i.SetName(t.name);for(let r=0;r<t.primitives.length;r++){let n=t.primitives[r];this.ImportPrimitive(e,n,i)}}ImportPrimitive(e,t,i){if(this.gltfExtensions.ProcessPrimitive(this,e,t,i)||t.attributes===void 0)return;let r=t.attributes.POSITION!==void 0,n=t.attributes.COLOR_0!==void 0,o=t.attributes.NORMAL!==void 0,l=t.attributes.TEXCOORD_0!==void 0,a=t.indices!==void 0,h=mt.TRIANGLES;if(t.mode!==void 0&&(h=t.mode),h!==mt.TRIANGLES&&h!==mt.TRIANGLE_STRIP&&h!==mt.TRIANGLE_FAN)return;let u=i.VertexCount(),d=i.VertexColorCount(),m=i.NormalCount(),f=i.TextureUVCount();if(r){let p=e.accessors[t.attributes.POSITION],g=this.GetReaderFromAccessor(e,p);if(g===null)return;g.EnumerateData(v=>{i.AddVertex(v)})}else return;if(n){let p=e.accessors[t.attributes.COLOR_0],g=this.GetReaderFromAccessor(e,p);if(g===null)return;g.EnumerateData(v=>{let x=zs([v.x,v.y,v.z],g.componentType);i.AddVertexColor(x)})}if(o){let p=e.accessors[t.attributes.NORMAL],g=this.GetReaderFromAccessor(e,p);if(g===null)return;g.EnumerateData(v=>{i.AddNormal(v)})}if(l){let p=e.accessors[t.attributes.TEXCOORD_0],g=this.GetReaderFromAccessor(e,p);if(g===null)return;g.EnumerateData(v=>{v.y=-v.y,i.AddTextureUV(v)})}let c=[];if(a){let p=e.accessors[t.indices],g=this.GetReaderFromAccessor(e,p);if(g===null)return;g.EnumerateData(v=>{c.push(v)})}else{let p=i.VertexCount()-u;for(let g=0;g<p;g++)c.push(g)}if(h===mt.TRIANGLES)for(let p=0;p<c.length;p+=3){let g=c[p],v=c[p+1],x=c[p+2];this.AddTriangle(t,i,g,v,x,n,o,l,u,d,m,f)}else if(h===mt.TRIANGLE_STRIP)for(let p=0;p<c.length-2;p++){let g=c[p],v=c[p+1],x=c[p+2];if(p%2===1){let M=v;v=x,x=M}this.AddTriangle(t,i,g,v,x,n,o,l,u,d,m,f)}else if(h===mt.TRIANGLE_FAN)for(let p=1;p<c.length-1;p++){let g=c[0],v=c[p],x=c[p+1];this.AddTriangle(t,i,g,v,x,n,o,l,u,d,m,f)}}AddTriangle(e,t,i,r,n,o,l,a,h,u,d,m){let f=new k(h+i,h+r,h+n);o&&f.SetVertexColors(u+i,u+r,u+n),l&&f.SetNormals(d+i,d+r,d+n),a&&f.SetTextureUVs(m+i,m+r,m+n),e.material!==void 0&&(f.mat=e.material),t.AddTriangle(f)}ImportNodes(e){let t=this.GetDefaultScene(e);if(t===null)return;let i=this.model.GetRootNode();for(let r of t.nodes){let n=e.nodes[r];this.ImportNode(e,n,i)}}ImportNode(e,t,i){function r(o){let l=new B().CreateIdentity();if(o.matrix!==void 0)l.Set(o.matrix);else{let a=[0,0,0],h=[0,0,0,1],u=[1,1,1];o.translation!==void 0&&(a=o.translation),o.rotation!==void 0&&(h=o.rotation),o.scale!==void 0&&(u=o.scale),l.ComposeTRS(Xe(a),Rt(h),Xe(u))}return new j(l)}if(t.children===void 0&&t.mesh===void 0)return;let n=new Me;if(t.name!==void 0&&n.SetName(t.name),n.SetTransformation(r(t)),i.AddChildNode(n),t.children!==void 0)for(let o of t.children){let l=e.nodes[o];this.ImportNode(e,l,n)}t.mesh!==void 0&&((t.children===void 0||t.children.length===0)&&n.SetType(ue.MeshNode),n.AddMeshIndex(t.mesh))}GetReaderFromBufferView(e){let t=e.buffer||0,i=this.bufferContents[t];if(i==null)return null;let r=new Jn(i);r.SkipBytes(e.byteOffset||0);let n=e.byteStride;return n!==void 0&&n!==0&&r.SetByteStride(n),r}GetReaderFromAccessor(e,t){let i=t.bufferView||0,r=e.bufferViews[i],n=this.GetReaderFromBufferView(r);if(n===null)return null;if(n.SetComponentType(t.componentType),n.SetDataType(t.type),n.SetDataCount(t.count),n.SkipBytes(t.byteOffset||0),t.sparse!==void 0){let o=this.GetReaderFromSparseAccessor(e,t.sparse.indices,t.sparse.indices.componentType,"SCALAR",t.sparse.count),l=this.GetReaderFromSparseAccessor(e,t.sparse.values,t.componentType,t.type,t.sparse.count);o!==null&&l!==null&&n.SetSparseReader(o,l)}return n}GetReaderFromSparseAccessor(e,t,i,r,n){if(t.bufferView===void 0)return null;let o=e.bufferViews[t.bufferView],l=this.GetReaderFromBufferView(o);return l===null?null:(l.SetComponentType(i),l.SetDataType(r),l.SetDataCount(n),l.SkipBytes(t.byteOffset||0),l)}};var mr=class extends H{constructor(){super();this.ifc=null}CanImportExtension(e){return e==="ifc"}GetUpDirection(){return S.Y}ClearContent(){this.materialNameToIndex=null,this.expressIDToMesh=null}ResetContent(){this.materialNameToIndex=new Map,this.expressIDToMesh=new Map}ImportContent(e,t){this.ifc===null?Se("loaders/web-ifc-api-browser.js").then(()=>{this.ifc=new WebIFC.IfcAPI,this.ifc.Init().then(()=>{this.ImportIfcContent(e),t()})}).catch(()=>{this.SetError("Failed to load web-ifc."),t()}):(this.ImportIfcContent(e),t())}ImportIfcContent(e){let t=new Uint8Array(e),i=this.ifc.OpenModel(t,{COORDINATE_TO_ORIGIN:!0}),r=this.ifc.LoadAllGeometry(i);for(let n=0;n<r.size();n++){let o=r.get(n);o.geometries.size()>0&&this.ImportIfcMesh(i,o)}this.ImportProperties(i),this.ifc.CloseModel(i)}ImportIfcMesh(e,t){let i=new q;i.SetName("Mesh "+t.expressID.toString());let r=0,n=t.geometries;for(let o=0;o<n.size();o++){let l=n.get(o),a=this.ifc.GetGeometry(e,l.geometryExpressID),h=this.ifc.GetVertexArray(a.GetVertexData(),a.GetVertexDataSize()),u=this.ifc.GetIndexArray(a.GetIndexData(),a.GetIndexDataSize()),d=this.GetMaterialIndexByColor(l.color),m=new B(l.flatTransformation),f=new j(m);for(let c=0;c<h.length;c+=6){let p=h[c],g=h[c+1],v=h[c+2],x=new I(p,g,v),M=f.TransformCoord3D(x);i.AddVertex(M)}for(let c=0;c<u.length;c+=3){let p=u[c],g=u[c+1],v=u[c+2],x=new k(r+p,r+g,r+v);x.SetMaterial(d),i.AddTriangle(x)}r+=h.length/6}this.expressIDToMesh.set(t.expressID,i),this.model.AddMeshToRootNode(i)}ImportProperties(e){let t=this.ifc.GetLineIDsWithType(e,WebIFC.IFCRELDEFINESBYPROPERTIES);for(let i=0;i<t.size();i++){let r=t.get(i),n=this.ifc.GetLine(e,r);Array.isArray(n.RelatingPropertyDefinition)||n.RelatedObjects.forEach(o=>{let l=null;if(this.expressIDToMesh.has(o.value)?l=this.expressIDToMesh.get(o.value):this.ifc.GetLine(e,o.value,!0).type===WebIFC.IFCBUILDING&&(l=this.model),l===null)return;let a=n.RelatingPropertyDefinition,h=this.ifc.GetLine(e,a.value,!0);if(!h||!h.HasProperties)return;let u=new Ee(h.Name.value);h.HasProperties.forEach(d=>{if(!d||!d.Name||!d.NominalValue)return;let m=null,f=this.GetIFCString(d.Name.value),c=null;switch(d.NominalValue.label){case"IFCTEXT":case"IFCLABEL":case"IFCIDENTIFIER":m=new F(D.Text,f,this.GetIFCString(d.NominalValue.value));break;case"IFCBOOLEAN":case"IFCLOGICAL":c="Unknown",d.NominalValue.value==="T"?c="True":d.NominalValue.value==="F"&&(c="False"),m=new F(D.Text,f,c);break;case"IFCINTEGER":case"IFCCOUNTMEASURE":m=new F(D.Integer,f,d.NominalValue.value);break;case"IFCREAL":case"IFCLENGTHMEASURE":case"IFCPOSITIVELENGTHMEASURE":case"IFCAREAMEASURE":case"IFCVOLUMEMEASURE":case"IFCRATIOMEASURE":case"IFCPOSITIVERATIOMEASURE":case"IFCMASSMEASURE":case"IFCMASSPERLENGTHMEASURE":case"IFCPLANEANGLEMEASURE":case"IFCTHERMALTRANSMITTANCEMEASURE":m=new F(D.Number,f,d.NominalValue.value);break;default:console.log(d.NominalValue.label),console.log(d.NominalValue.value);break}m!==null&&u.AddProperty(m)}),u.PropertyCount()>0&&l.AddPropertyGroup(u)})}}GetMaterialIndexByColor(e){let t=Pe(e.x,e.y,e.z),i="Color "+J(t.r)+J(t.g)+J(t.b)+J(parseInt(e.w*255,10));if(this.materialNameToIndex.has(i))return this.materialNameToIndex.get(i);{let r=new Y;r.name=i,r.color=t,r.opacity=e.w,de(r);let n=this.model.AddMaterial(r);return this.materialNameToIndex.set(i,n),n}}GetIFCString(e){let t=this.DecodeIFCString(e);return t.length===0&&(t="-"),t}DecodeIFCString(e){let t=/\\X2\\(.*?)\\X0\\/uig,i=e,r=t.exec(e);for(;r;){let n=String.fromCharCode(parseInt(r[1],16));i=i.replace(r[0],n),r=t.exec(e)}return i}};var Di=class{constructor(){this.name=null,this.material=null}SetName(e){return this.name=e,this}SetMaterial(e){return this.material=e,this}},jt=class{constructor(e){this.params=e||new Di,this.mesh=new q,this.params.name!==null&&this.mesh.SetName(this.params.name),this.curve=null}GetMesh(){return this.mesh}AddVertex(e,t,i){let r=new I(e,t,i);return this.mesh.AddVertex(r)}AddVertices(e){let t=[];for(let i=0;i<e.length;i++){let r=e[i];t.push(this.AddVertex(r.x,r.y,r.z))}return t}SetCurve(e){this.curve=e}ResetCurve(){this.curve=null}AddTriangle(e,t,i){let r=new k(e,t,i);return this.params.material!==null&&(r.mat=this.params.material),this.curve!==null&&r.SetCurve(this.curve),this.mesh.AddTriangle(r)}AddTriangleInverted(e,t,i){this.AddTriangle(e,i,t)}AddConvexPolygon(e){for(let t=0;t<e.length-2;t++)this.AddTriangle(e[0],e[t+1],e[t+2])}AddConvexPolygonInverted(e){for(let t=0;t<e.length-2;t++)this.AddTriangleInverted(e[0],e[t+1],e[t+2])}},fr=class{constructor(e){this.generator=e}GenerateSurfaceBetweenPolygons(e,t){if(e.length!==t.length)return;let i=e.length;for(let r=0;r<i;r++){let n=r,o=r<i-1?n+1:0;this.generator.AddConvexPolygon([e[n],e[o],t[o],t[n]])}}GenerateTriangleFan(e,t){let i=e.length;for(let r=0;r<i;r++){let n=r,o=r<i-1?n+1:0;this.generator.AddTriangle(t,e[n],e[o])}}};function Qn(s,e){return new V(s*Math.cos(e),s*Math.sin(e))}function $n(s,e,t,i){if(!Le(e)||!Le(t)||!Le(i))return null;let r=new jt(s);return r.AddVertex(0,0,0),r.AddVertex(e,0,0),r.AddVertex(e,t,0),r.AddVertex(0,t,0),r.AddVertex(0,0,i),r.AddVertex(e,0,i),r.AddVertex(e,t,i),r.AddVertex(0,t,i),r.AddConvexPolygon([0,3,2,1]),r.AddConvexPolygon([0,1,5,4]),r.AddConvexPolygon([1,2,6,5]),r.AddConvexPolygon([2,3,7,6]),r.AddConvexPolygon([3,0,4,7]),r.AddConvexPolygon([4,5,6,7]),r.GetMesh()}function cr(s,e,t,i,r,n){if(nt(e)||nt(t)||!Le(i)||r<3)return null;let o=kt(e),l=kt(t);if(o&&l)return null;let a=new jt(s),h=new fr(a),u=2*Math.PI/r,d=n?1:null,m=[];if(o)m.push(a.AddVertex(0,0,i));else for(let c=0;c<r;c++){let p=Qn(e,c*u);m.push(a.AddVertex(p.x,p.y,i))}let f=[];if(l)f.push(a.AddVertex(0,0,0));else for(let c=0;c<r;c++){let p=Qn(t,c*u);f.push(a.AddVertex(p.x,p.y,0))}return o?(a.SetCurve(d),h.GenerateTriangleFan(f,m[0]),a.ResetCurve(),a.AddConvexPolygonInverted(f)):l?(a.SetCurve(d),h.GenerateTriangleFan(m.slice().reverse(),f[0]),a.ResetCurve(),a.AddConvexPolygon(m)):(a.SetCurve(d),h.GenerateSurfaceBetweenPolygons(f,m),a.ResetCurve(),a.AddConvexPolygonInverted(f),a.AddConvexPolygon(m)),a.GetMesh()}function es(s,e,t,i,r){return cr(s,e,e,t,i,r)}function ts(s,e,t,i){function r(f,c,p){return new I(f*Math.sin(c)*Math.cos(p),f*Math.sin(c)*Math.sin(p),f*Math.cos(c))}if(!Le(e)||t<3)return null;let n=new jt(s),o=new fr(n);n.SetCurve(i?1:null);let l=[],a=t+1,h=Math.PI/t,u=2*Math.PI/t;for(let f=1;f<a-1;f++){let c=[],p=f*h;for(let g=0;g<t;g++){let v=g*u,x=r(e,p,-v);c.push(n.AddVertex(x.x,x.y,x.z))}f>1&&o.GenerateSurfaceBetweenPolygons(l[l.length-1],c),l.push(c)}let d=n.AddVertex(0,0,e),m=n.AddVertex(0,0,-e);return o.GenerateTriangleFan(l[0].slice().reverse(),d),o.GenerateTriangleFan(l[l.length-1],m),n.ResetCurve(),n.GetMesh()}function is(s,e,t){function i(n,o,l,a,h){let u=new I(l,a,h);u.MultiplyScalar(o/u.Length()),n.AddVertex(u.x,u.y,u.z)}if(!Le(t))return null;let r=new jt(s);if(e==="tetrahedron"){let n=1;i(r,t,+n,+n,+n),i(r,t,-n,-n,+n),i(r,t,-n,+n,-n),i(r,t,+n,-n,-n),r.AddTriangle(0,1,3),r.AddTriangle(0,2,1),r.AddTriangle(0,3,2),r.AddTriangle(1,2,3)}else if(e==="hexahedron"){let n=1;i(r,t,+n,+n,+n),i(r,t,+n,+n,-n),i(r,t,+n,-n,+n),i(r,t,+n,-n,-n),i(r,t,-n,+n,+n),i(r,t,-n,+n,-n),i(r,t,-n,-n,+n),i(r,t,-n,-n,-n),r.AddConvexPolygon([0,1,5,4]),r.AddConvexPolygon([0,2,3,1]),r.AddConvexPolygon([0,4,6,2]),r.AddConvexPolygon([1,3,7,5]),r.AddConvexPolygon([2,6,7,3]),r.AddConvexPolygon([4,5,7,6])}else if(e==="octahedron"){let n=1,o=0;i(r,t,+n,+o,+o),i(r,t,-n,+o,+o),i(r,t,+o,+n,+o),i(r,t,+o,-n,+o),i(r,t,+o,+o,+n),i(r,t,+o,+o,-n),r.AddTriangle(0,2,4),r.AddTriangle(0,3,5),r.AddTriangle(0,4,3),r.AddTriangle(0,5,2),r.AddTriangle(1,2,5),r.AddTriangle(1,3,4),r.AddTriangle(1,4,2),r.AddTriangle(1,5,3)}else if(e==="dodecahedron"){let n=1,o=0,l=(1+Math.sqrt(5))/2,a=1/l;i(r,t,+n,+n,+n),i(r,t,+n,+n,-n),i(r,t,+n,-n,+n),i(r,t,-n,+n,+n),i(r,t,+n,-n,-n),i(r,t,-n,+n,-n),i(r,t,-n,-n,+n),i(r,t,-n,-n,-n),i(r,t,+o,+a,+l),i(r,t,+o,+a,-l),i(r,t,+o,-a,+l),i(r,t,+o,-a,-l),i(r,t,+a,+l,+o),i(r,t,+a,-l,+o),i(r,t,-a,+l,+o),i(r,t,-a,-l,+o),i(r,t,+l,+o,+a),i(r,t,-l,+o,+a),i(r,t,+l,+o,-a),i(r,t,-l,+o,-a),r.AddConvexPolygon([0,8,10,2,16]),r.AddConvexPolygon([0,16,18,1,12]),r.AddConvexPolygon([0,12,14,3,8]),r.AddConvexPolygon([1,9,5,14,12]),r.AddConvexPolygon([1,18,4,11,9]),r.AddConvexPolygon([2,10,6,15,13]),r.AddConvexPolygon([2,13,4,18,16]),r.AddConvexPolygon([3,14,5,19,17]),r.AddConvexPolygon([3,17,6,10,8]),r.AddConvexPolygon([4,13,15,7,11]),r.AddConvexPolygon([5,9,11,7,19]),r.AddConvexPolygon([6,17,19,7,15])}else if(e==="icosahedron"){let n=1,o=0,l=(1+Math.sqrt(5))/2;i(r,t,+o,+n,+l),i(r,t,+o,+n,-l),i(r,t,+o,-n,+l),i(r,t,+o,-n,-l),i(r,t,+n,+l,+o),i(r,t,+n,-l,+o),i(r,t,-n,+l,+o),i(r,t,-n,-l,+o),i(r,t,+l,+o,+n),i(r,t,+l,+o,-n),i(r,t,-l,+o,+n),i(r,t,-l,+o,-n),r.AddTriangle(0,2,8),r.AddTriangle(0,4,6),r.AddTriangle(0,6,10),r.AddTriangle(0,8,4),r.AddTriangle(0,10,2),r.AddTriangle(1,3,11),r.AddTriangle(1,4,9),r.AddTriangle(1,6,4),r.AddTriangle(1,9,3),r.AddTriangle(1,11,6),r.AddTriangle(2,5,8),r.AddTriangle(2,7,5),r.AddTriangle(2,10,7),r.AddTriangle(3,5,7),r.AddTriangle(3,7,11),r.AddTriangle(3,9,5),r.AddTriangle(4,8,9),r.AddTriangle(5,9,8),r.AddTriangle(6,11,10),r.AddTriangle(7,10,11)}return r.GetMesh()}var pr=class extends H{constructor(){super()}CanImportExtension(e){return e==="o3dv"}GetUpDirection(){return S.Z}ClearContent(){}ResetContent(){}ImportContent(e,t){let i=te(e),r=JSON.parse(i);if(r.root===void 0){t();return}if(r.materials!==void 0)for(let o=0;o<r.materials.length;o++){let l=r.materials[o];this.ImportMaterial(l)}if(r.meshes!==void 0)for(let o=0;o<r.meshes.length;o++){let l=r.meshes[o];this.ImportMesh(l)}let n=r.nodes[r.root];this.ImportNode(r,n,this.model.GetRootNode()),this.ImportProperties(this.model,r),t()}ImportMaterial(e){let t=new at;t.color.Set(255,255,255),e.name!==void 0&&(t.name=e.name),e.color!==void 0&&(t.color=mn(e.color)),t.metalness=Ue(e.metalness,0),t.roughness=Ue(e.roughness,1),this.model.AddMaterial(t)}ImportMesh(e){let t=new Di;e.name!==void 0&&t.SetName(e.name),e.material!==void 0&&t.SetMaterial(e.material);let i=e.parameters;if(i===void 0)return;let r=null;if(e.type==="cuboid"){if(i.size_x===void 0||i.size_y===void 0||i.size_z===void 0)return;r=$n(t,i.size_x,i.size_y,i.size_z)}else if(e.type==="cylinder"){if(i.radius===void 0||i.height===void 0)return;let n=Ue(i.segments,25),o=Ue(i.smooth,!0);r=es(t,i.radius,i.height,n,o)}else if(e.type==="cone"){if(i.top_radius===void 0||i.bottom_radius===void 0||i.height===void 0)return;let n=Ue(i.segments,25),o=Ue(i.smooth,!0);r=cr(t,i.top_radius,i.bottom_radius,i.height,n,o)}else if(e.type==="sphere"){if(i.radius===void 0)return;let n=Ue(i.segments,20),o=Ue(i.smooth,!0);r=ts(t,i.radius,n,o)}else if(e.type==="platonic"){if(i.solid_type===void 0)return;let n=Ue(i.radius,1);r=is(t,i.solid_type,n)}r!==null&&(this.ImportProperties(r,e),this.model.AddMesh(r))}ImportNode(e,t,i){if(t.name!==void 0&&i.SetName(t.name),t.transformation!==void 0){let r=this.GetTransformation(t.transformation);i.SetTransformation(r)}if(t.children!==void 0)for(let r of t.children){let n=e.nodes[r],o=new Me;i.AddChildNode(o),this.ImportNode(e,n,o)}t.mesh!==void 0&&((t.children===void 0||t.children.length===0)&&i.SetType(ue.MeshNode),i.AddMeshIndex(t.mesh))}ImportProperties(e,t){if(t.properties!==void 0){let i=new Ee("Properties");e.AddPropertyGroup(i);for(let r of t.properties){let n=new F(D.Text,r.name,r.value);i.AddProperty(n)}}}GetTransformation(e){let t=new I(0,0,0),i=new Te(0,0,0,1),r=new I(1,1,1);e.translation!==void 0&&(t=Xe(e.translation)),e.rotation!==void 0&&(i=Rt(e.rotation)),e.scale!==void 0&&(r=Xe(e.scale));let n=new B().ComposeTRS(t,i,r);return new j(n)}};var rs=class{constructor(e){this.mesh=e,this.globalToMeshVertices=new Map,this.globalToMeshVertexColors=new Map,this.globalToMeshNormals=new Map,this.globalToMeshUvs=new Map}AddVertex(e,t){return this.GetLocalIndex(e,t,this.globalToMeshVertices,i=>this.mesh.AddVertex(new I(i.x,i.y,i.z)))}AddVertexColor(e,t){return this.GetLocalIndex(e,t,this.globalToMeshVertexColors,i=>this.mesh.AddVertexColor(new w(i.r,i.g,i.b)))}AddNormal(e,t){return this.GetLocalIndex(e,t,this.globalToMeshNormals,i=>this.mesh.AddNormal(new I(i.x,i.y,i.z)))}AddUV(e,t){return this.GetLocalIndex(e,t,this.globalToMeshUvs,i=>this.mesh.AddTextureUV(new V(i.x,i.y)))}AddTriangle(e){this.mesh.AddTriangle(e)}GetLocalIndex(e,t,i,r){if(isNaN(e)||e<0||e>=t.length)return null;if(i.has(e))return i.get(e);{let n=t[e],o=r(n);return i.set(e,o),o}}};function Gi(s,e,t){return Pe(parseFloat(s),parseFloat(e),parseFloat(t))}var gr=class extends H{constructor(){super()}CanImportExtension(e){return e==="obj"}GetUpDirection(){return S.Y}ClearContent(){this.globalVertices=null,this.globalVertexColors=null,this.globalNormals=null,this.globalUvs=null,this.currentMeshConverter=null,this.currentMaterial=null,this.currentMaterialIndex=null,this.meshNameToConverter=null,this.materialNameToIndex=null}ResetContent(){this.globalVertices=[],this.globalVertexColors=[],this.globalNormals=[],this.globalUvs=[],this.currentMeshConverter=null,this.currentMaterial=null,this.currentMaterialIndex=null,this.meshNameToConverter=new Map,this.materialNameToIndex=new Map}ImportContent(e,t){let i=te(e);Fe(i,r=>{this.WasError()||this.ProcessLine(r)}),t()}ProcessLine(e){if(e[0]==="#")return;let t=Ke(e,"#");if(t.length===0)return;let i=t[0].toLowerCase();t.shift(),!this.ProcessMeshParameter(i,t,e)&&this.ProcessMaterialParameter(i,t,e)}AddNewMesh(e){if(this.meshNameToConverter.has(e))this.currentMeshConverter=this.meshNameToConverter.get(e);else{let t=new q;t.SetName(e),this.model.AddMeshToRootNode(t),this.currentMeshConverter=new rs(t),this.meshNameToConverter.set(e,this.currentMeshConverter)}}ProcessMeshParameter(e,t,i){if(e==="g"||e==="o"){if(t.length===0)return!0;let r=et(i,e.length,"#");return this.AddNewMesh(r),!0}else{if(e==="v")return t.length<3||(this.globalVertices.push(new I(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),t.length>=6&&this.globalVertexColors.push(Gi(t[3],t[4],t[5]))),!0;if(e==="vn")return t.length<3||this.globalNormals.push(new I(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),!0;if(e==="vt")return t.length<2||this.globalUvs.push(new V(parseFloat(t[0]),parseFloat(t[1]))),!0;if(e==="f")return t.length<3||this.ProcessFace(t),!0}return!1}ProcessMaterialParameter(e,t,i){function r(n,o,l){let a=new Re,h=et(o,n.length,"#"),u=l.getTextureBuffer(h);return a.name=h,u!==null&&(a.url=u.url,a.buffer=u.buffer),a}if(e==="newmtl"){if(t.length===0)return!0;let n=new Y,o=et(i,e.length,"#"),l=this.model.AddMaterial(n);return n.name=o,this.currentMaterial=n,this.materialNameToIndex.set(o,l),!0}else if(e==="usemtl"){if(t.length===0)return!0;let n=et(i,e.length,"#");return this.materialNameToIndex.has(n)&&(this.currentMaterialIndex=this.materialNameToIndex.get(n)),!0}else if(e==="mtllib"){if(t.length===0)return!0;let n=et(i,e.length,"#"),o=this.callbacks.getFileBuffer(n);if(o!==null){let l=te(o);Fe(l,a=>{this.WasError()||this.ProcessLine(a)})}return!0}else{if(e==="map_kd")return this.currentMaterial===null||t.length===0||(this.currentMaterial.diffuseMap=r(e,i,this.callbacks),de(this.currentMaterial)),!0;if(e==="map_ks")return this.currentMaterial===null||t.length===0||(this.currentMaterial.specularMap=r(e,i,this.callbacks)),!0;if(e==="map_bump"||e==="bump")return this.currentMaterial===null||t.length===0||(this.currentMaterial.bumpMap=r(e,i,this.callbacks)),!0;if(e==="ka")return this.currentMaterial===null||t.length<3||(this.currentMaterial.ambient=Gi(t[0],t[1],t[2])),!0;if(e==="kd")return this.currentMaterial===null||t.length<3||(this.currentMaterial.color=Gi(t[0],t[1],t[2])),!0;if(e==="ks")return this.currentMaterial===null||t.length<3||(this.currentMaterial.specular=Gi(t[0],t[1],t[2])),!0;if(e==="ns")return this.currentMaterial===null||t.length<1||(this.currentMaterial.shininess=parseFloat(t[0])/1e3),!0;if(e==="tr")return this.currentMaterial===null||t.length<1||(this.currentMaterial.opacity=1-parseFloat(t[0]),de(this.currentMaterial)),!0;if(e==="d")return this.currentMaterial===null||t.length<1||(this.currentMaterial.opacity=parseFloat(t[0]),de(this.currentMaterial)),!0}return!1}ProcessFace(e){function t(l,a){return l>0?l-1:a+l}let i=[],r=[],n=[],o=[];for(let l=0;l<e.length;l++){let a=e[l].split("/");i.push(t(parseInt(a[0],10),this.globalVertices.length)),this.globalVertices.length===this.globalVertexColors.length&&r.push(t(parseInt(a[0],10),this.globalVertices.length)),a.length>1&&a[1].length>0&&o.push(t(parseInt(a[1],10),this.globalUvs.length)),a.length>2&&a[2].length>0&&n.push(t(parseInt(a[2],10),this.globalNormals.length))}this.currentMeshConverter===null&&this.AddNewMesh("");for(let l=0;l<i.length-2;l++){let a=this.currentMeshConverter.AddVertex(i[0],this.globalVertices),h=this.currentMeshConverter.AddVertex(i[l+1],this.globalVertices),u=this.currentMeshConverter.AddVertex(i[l+2],this.globalVertices);if(a===null||h===null||u===null){this.SetError("Invalid vertex index.");break}let d=new k(a,h,u);if(r.length===i.length){let m=this.currentMeshConverter.AddVertexColor(r[0],this.globalVertexColors),f=this.currentMeshConverter.AddVertexColor(r[l+1],this.globalVertexColors),c=this.currentMeshConverter.AddVertexColor(r[l+2],this.globalVertexColors);if(m===null||f===null||c===null){this.SetError("Invalid vertex color index.");break}d.SetVertexColors(m,f,c)}if(n.length===i.length){let m=this.currentMeshConverter.AddNormal(n[0],this.globalNormals),f=this.currentMeshConverter.AddNormal(n[l+1],this.globalNormals),c=this.currentMeshConverter.AddNormal(n[l+2],this.globalNormals);if(m===null||f===null||c===null){this.SetError("Invalid normal index.");break}d.SetNormals(m,f,c)}if(o.length===i.length){let m=this.currentMeshConverter.AddUV(o[0],this.globalUvs),f=this.currentMeshConverter.AddUV(o[l+1],this.globalUvs),c=this.currentMeshConverter.AddUV(o[l+2],this.globalUvs);if(m===null||f===null||c===null){this.SetError("Invalid uv index.");break}d.SetTextureUVs(m,f,c)}this.currentMaterialIndex!==null&&(d.mat=this.currentMaterialIndex),this.currentMeshConverter.AddTriangle(d)}}};var xr=class extends H{constructor(){super()}CanImportExtension(e){return e==="off"}GetUpDirection(){return S.Y}ClearContent(){this.mesh=null,this.status=null}ResetContent(){this.mesh=new q,this.model.AddMeshToRootNode(this.mesh),this.status={vertexCount:0,faceCount:0,foundVertex:0,foundFace:0}}ImportContent(e,t){let i=te(e);Fe(i,r=>{this.WasError()||this.ProcessLine(r)}),t()}ProcessLine(e){if(e[0]==="#")return;let t=Ke(e,"#");if(t.length!==0&&t[0]!=="OFF"){if(this.status.vertexCount===0&&this.status.faceCount===0){t.length>1&&(this.status.vertexCount=parseInt(t[0],10),this.status.faceCount=parseInt(t[1],10));return}if(this.status.foundVertex<this.status.vertexCount){t.length>=3&&(this.mesh.AddVertex(new I(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),this.status.foundVertex+=1);return}if(this.status.foundFace<this.status.faceCount){if(t.length>=4){let i=parseInt(t[0],10);if(t.length<i+1)return;for(let r=0;r<i-2;r++){let n=parseInt(t[1]),o=parseInt(t[r+2]),l=parseInt(t[r+3]),a=new k(n,o,l);this.mesh.AddTriangle(a)}this.status.foundFace+=1}return}}}};var tt={Ok:1,NoVertices:2,NoFaces:3,UnknownError:4},ns=class{constructor(){this.format=null,this.elements=[]}SetFormat(e){this.format=e}AddElement(e,t){this.elements.push({name:e,count:t,format:[]})}GetElements(){return this.elements}AddSingleFormat(e,t){this.elements[this.elements.length-1].format.push({name:t,isSingle:!0,elemType:e})}AddListFormat(e,t,i){this.elements[this.elements.length-1].format.push({name:i,isSingle:!1,countType:e,elemType:t})}GetElement(e){for(let t=0;t<this.elements.length;t++){let i=this.elements[t];if(i.name===e)return i}return null}Check(){let e=this.GetElement("vertex");if(e===null||e.length===0||e.format.length<3)return tt.NoVertices;let t=this.GetElement("face");if(this.format==="ascii"){if(t===null||t.count===0||t.format.length<0)return tt.NoFaces}else if(this.format==="binary_little_endian"||this.format==="binary_big_endian"){let i=this.GetElement("tristrips"),r=t!==null&&t.count>0&&t.format.length>0,n=i!==null&&i.count>0&&i.format.length>0;if(!r&&!n)return tt.NoFaces}else return tt.UnknownError;return tt.Ok}},ss=class{constructor(e){this.model=e,this.colorToMaterial=new Map}GetMaterialIndexByColor(e){let t="Color "+J(e[0])+J(e[1])+J(e[2])+J(e[3]);if(this.colorToMaterial.has(t))return this.colorToMaterial.get(t);{let i=new Y;i.name=t,i.color=new w(e[0],e[1],e[2]),i.opacity=e[3]/255,de(i);let r=this.model.AddMaterial(i);return this.colorToMaterial.set(t,r),r}}},Cr=class extends H{constructor(){super()}CanImportExtension(e){return e==="ply"}GetUpDirection(){return S.Y}ClearContent(){this.mesh=null}ResetContent(){this.mesh=new q,this.model.AddMeshToRootNode(this.mesh)}ImportContent(e,t){let i=this.GetHeaderContent(e),r=this.ReadHeader(i),n=r.Check();if(n===tt.Ok)if(r.format==="ascii"){let o=te(e);o=o.substring(i.length),this.ReadAsciiContent(r,o)}else(r.format==="binary_little_endian"||r.format==="binary_big_endian")&&this.ReadBinaryContent(r,e,i.length);else n===tt.NoVertices?this.SetError("The model contains no vertices."):n===tt.NoFaces?this.SetError("The model contains no faces."):this.SetError("Invalid header information.");t()}GetHeaderContent(e){let t="",i=new Uint8Array(e),r=0;for(r=0;r<e.byteLength&&(t+=String.fromCharCode(i[r]),!t.endsWith("end_header"));r++);for(r+=1;r<e.byteLength;){let n=String.fromCharCode(i[r]);if(t+=n,r+=1,n===`
`)break}return t}ReadHeader(e){let t=new ns;return Fe(e,i=>{let r=Ke(i,null);r.length===0||r[0]==="comment"||r[0]!=="ply"&&(r[0]==="format"&&r.length>=2?t.SetFormat(r[1]):r[0]==="element"&&r.length>=3?t.AddElement(r[1],parseInt(r[2],10)):r[0]==="property"&&r.length>=3&&(r[1]==="list"&&r.length>=5?t.AddListFormat(r[2],r[3],r[4]):t.AddSingleFormat(r[1],r[2])))}),t}ReadAsciiContent(e,t){let i=e.GetElement("vertex"),r=e.GetElement("face"),n=0,o=0;Fe(t,l=>{if(this.WasError())return;let a=Ke(l,null);if(!(a.length===0||a[0]==="comment")){if(n<i.count){a.length>=3&&(this.mesh.AddVertex(new I(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]))),n+=1);return}if(r!==null&&o<r.count){if(a.length>=4){let h=parseInt(a[0],10);if(a.length<h+1)return;for(let u=0;u<h-2;u++){let d=parseInt(a[1]),m=parseInt(a[u+2]),f=parseInt(a[u+3]),c=new k(d,m,f);this.mesh.AddTriangle(c)}o+=1}return}}})}ReadBinaryContent(e,t,i){function r(u,d){function m(f,c){return c==="char"||c==="int8"?f.ReadCharacter8():c==="uchar"||c==="uint8"?f.ReadUnsignedCharacter8():c==="short"||c==="int16"?f.ReadInteger16():c==="ushort"||c==="uint16"?f.ReadUnsignedInteger16():c==="int"||c==="int32"?f.ReadInteger32():c==="uint"||c==="uint32"?f.ReadUnsignedInteger32():c==="float"||c==="float32"?f.ReadFloat32():c==="double"||c==="double64"?f.ReadDouble64():null}if(d.isSingle)return m(u,d.elemType);{let f=[],c=m(u,d.countType);for(let p=0;p<c;p++)f.push(m(u,d.elemType));return f}}function n(u,d,m){for(let f=m;f<d.length;f++)r(u,d[f])}function o(u,d,m){let f=null,c=null,p=null,g=255;for(let v=m;v<d.length;v++){let x=d[v],M=r(u,x);x.name==="red"?f=M:x.name==="green"?c=M:x.name==="blue"?p=M:x.name==="alpha"&&(g=M)}return f!==null&&c!==null&&p!==null?[f,c,p,g]:null}let l=null;if(e.format==="binary_little_endian")l=new De(t,!0);else if(e.format==="binary_big_endian")l=new De(t,!1);else return;l.Skip(i);let a=new ss(this.model),h=e.GetElements();for(let u=0;u<h.length;u++){let d=h[u];if(d.name==="vertex")for(let m=0;m<d.count;m++){let f=r(l,d.format[0]),c=r(l,d.format[1]),p=r(l,d.format[2]),g=o(l,d.format,3);g!==null&&this.mesh.AddVertexColor(new w(g[0],g[1],g[2])),this.mesh.AddVertex(new I(f,c,p))}else if(d.name==="face")for(let m=0;m<d.count;m++){let f=r(l,d.format[0]),c=o(l,d.format,1);for(let p=0;p<f.length-2;p++){let g=f[0],v=f[p+1],x=f[p+2],M=new k(g,v,x);c!==null?M.mat=a.GetMaterialIndexByColor(c):this.mesh.VertexColorCount()>0&&M.SetVertexColors(g,v,x),this.mesh.AddTriangle(M)}}else if(d.name==="tristrips")for(let m=0;m<d.count;m++){let f=r(l,d.format[0]);n(l,d.format,1);let c=!0;for(let p=0;p<f.length-2;p++){let g=f[p],v=f[p+1],x=f[p+2];if(x===-1){p+=2,c=!0;continue}if(!c){let T=v;v=x,x=T}c=!c;let M=new k(g,v,x);this.mesh.AddTriangle(M)}}else n(l,d.format,0)}}};var vr=class extends H{constructor(){super();this.worker=null}CanImportExtension(e){return e==="stp"||e==="step"}GetUpDirection(){return S.Y}ClearContent(){}ResetContent(){}ImportContent(e,t){if(this.worker===null){let n=Hi("loaders/occt-import-js-worker.js");this.worker=new Worker(n)}let i=n=>{this.ImportStepContent(n.data,t),this.worker.removeEventListener("message",i)};this.worker.addEventListener("message",i),this.worker.addEventListener("error",n=>{this.worker=null,this.SetError("Failed to load occt-import-js."),t()});let r=new Uint8Array(e);this.worker.postMessage(r)}ImportStepContent(e,t){if(!e.success)return;let i=new lr(r=>{let n=new Y;return n.name=le(r).toUpperCase(),n.color=r,this.model.AddMaterial(n)});for(let r of e.meshes){let n=null;if(r.color){let l=Pe(r.color[0],r.color[1],r.color[2]);n=i.GetMaterialIndex(l)}let o=dt(r,n);if(r.name&&o.SetName(r.name),r.face_colors)for(let l of r.face_colors){let a=Pe(l.color[0],l.color[1],l.color[2]),h=i.GetMaterialIndex(a);for(let u=l.first;u<=l.last;u++)o.GetTriangle(u).SetMaterial(h)}this.model.AddMeshToRootNode(o)}t()}};var Ir=class extends H{constructor(){super()}CanImportExtension(e){return e==="stl"}GetUpDirection(){return S.Z}ClearContent(){this.mesh=null,this.triangle=null}ResetContent(){this.mesh=new q,this.model.AddMeshToRootNode(this.mesh),this.triangle=null}ImportContent(e,t){if(this.IsBinaryStlFile(e))this.ProcessBinary(e);else{let i=te(e);Fe(i,r=>{this.WasError()||this.ProcessLine(r)})}t()}IsBinaryStlFile(e){let t=e.byteLength;if(t<84)return!1;let i=new De(e,!0);i.Skip(80);let r=i.ReadUnsignedInteger32();return t===r*50+84}ProcessLine(e){if(e[0]==="#")return;let t=Ke(e,"#");if(t.length===0)return;let i=t[0];if(i==="solid"){if(t.length>1){let r=et(e,i.length,"#");this.mesh.SetName(r)}return}if(i==="facet"){if(this.triangle=new k(-1,-1,-1),t.length>=5&&t[1]==="normal"){let r=new I(parseFloat(t[2]),parseFloat(t[3]),parseFloat(t[4]));if(Le(r.Length())){let n=this.mesh.AddNormal(r);this.triangle.SetNormals(n,n,n)}}return}if(i==="vertex"&&this.triangle!==null){if(t.length>=4){let r=this.mesh.AddVertex(new I(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])));this.triangle.v0===-1?this.triangle.v0=r:this.triangle.v1===-1?this.triangle.v1=r:this.triangle.v2===-1&&(this.triangle.v2=r)}return}if(i==="endfacet"&&this.triangle!==null){this.triangle.v0!==-1&&this.triangle.v1!==-1&&this.triangle.v2!==null&&this.mesh.AddTriangle(this.triangle),this.triangle=null;return}}ProcessBinary(e){function t(o){let l=new I;return l.x=o.ReadFloat32(),l.y=o.ReadFloat32(),l.z=o.ReadFloat32(),l}function i(o,l){let a=t(l);return o.AddVertex(a)}let r=new De(e,!0);r.Skip(80);let n=r.ReadUnsignedInteger32();for(let o=0;o<n;o++){let l=t(r),a=i(this.mesh,r),h=i(this.mesh,r),u=i(this.mesh,r);r.Skip(2);let d=new k(a,h,u);if(Le(l.Length())){let m=this.mesh.AddNormal(l);d.SetNormals(m,m,m)}this.mesh.AddTriangle(d)}}};var Tr=class extends H{constructor(){super()}CanImportExtension(e){return e==="bim"}GetUpDirection(){return S.Z}ClearContent(){this.meshIdToMesh=null,this.colorToMaterialIndex=null}ResetContent(){this.meshIdToMesh=new Map,this.colorToMaterialIndex=new Map}ImportContent(e,t){let i=te(e),r=null;try{r=JSON.parse(i)}catch{this.SetError("Failed to parse bim file."),t();return}for(let n of r.meshes)this.meshIdToMesh.set(n.mesh_id,n);this.ImportProperties(r,this.model);for(let n of r.elements){let o=this.ImportElement(n);o.SetName(n.type),this.ImportProperties(n,o)}t()}ImportElement(e){let t=null;if(e.color){let m=J(e.color.r)+J(e.color.g)+J(e.color.b)+J(e.color.a);if(this.colorToMaterialIndex.has(m))t=this.colorToMaterialIndex.get(m);else{let f=new Y;f.name=m,f.color=new w(e.color.r,e.color.g,e.color.b),e.color.a<255&&(f.opacity=e.color.a/255,de(f)),t=this.model.AddMaterial(f),this.colorToMaterialIndex.set(m,t)}}let i=this.model.GetRootNode(),r=this.meshIdToMesh.get(e.mesh_id),n=this.ImportMesh(r,t),o=this.model.AddMesh(n),l=new Me;l.SetType(ue.MeshNode),l.AddMeshIndex(o);let a=new I(0,0,0);e.vector&&(a=new I(e.vector.x,e.vector.y,e.vector.z));let h=new Te(0,0,0,1);e.rotation&&(h=new Te(e.rotation.qx,e.rotation.qy,e.rotation.qz,e.rotation.qw));let u=new I(1,1,1),d=new B().ComposeTRS(a,h,u);return l.SetTransformation(new j(d)),i.AddChildNode(l),n}ImportMesh(e,t){let i=new q;for(let r=0;r<e.coordinates.length;r+=3)i.AddVertex(new I(e.coordinates[r+0],e.coordinates[r+1],e.coordinates[r+2]));for(let r=0;r<e.indices.length;r+=3){let n=new k(e.indices[r+0],e.indices[r+1],e.indices[r+2]);t!==null&&n.SetMaterial(t),i.AddTriangle(n)}return i}ImportProperties(e,t){function i(o,l,a){if(a==null)return;let h=new F(D.Text,l,a);o.AddProperty(h)}if(!e.info)return;let r=e.info,n=new Ee("Info");i(n,"Guid",e.guid),i(n,"Type",e.type);for(let o in r)Object.prototype.hasOwnProperty.call(r,o)&&typeof r[o]=="string"&&i(n,o,r[o]);t.AddPropertyGroup(n)}};var qt=class extends H{constructor(){super()}GetExternalLibraries(){return null}CreateLoader(e){return null}GetMainObject(e){return e}IsMeshVisible(e){return!0}ClearContent(){this.loader=null,this.materialIdToIndex=null,this.objectUrlToFileName=null}ResetContent(){this.loader=null,this.materialIdToIndex=new Map,this.objectUrlToFileName=new Map}ImportContent(e,t){async function i(n,o,l){try{for(let a=0;a<n.length;a++)await Se(n[a])}catch{l()}o()}let r=this.GetExternalLibraries();if(r===null){t();return}i(r,()=>{this.LoadModel(e,t)},()=>{this.SetError("Failed to load three.js loader."),t()})}LoadModel(e,t){let i=!1,r=new THREE.LoadingManager(()=>{i=!0}),n=Pt(e);r.setURLModifier(l=>{if(l===n)return l;let a=re(l);if(Oe(l).length>0){let u=this.callbacks.getFileBuffer(l);if(u!==null){let d=Pt(u);return this.objectUrlToFileName.set(d,a),d}}return l});let o=this.CreateLoader(r);if(o===null){t();return}o.load(n,l=>{_n(()=>i?(this.OnThreeObjectsLoaded(l,t),!1):!0)},()=>{},l=>{this.SetError(l),t()})}OnThreeObjectsLoaded(e,t){function i(l){let a=new B().CreateIdentity();return l.updateMatrix(),l.matrix!==void 0&&l.matrix!==null&&a.Set(l.matrix.elements),new j(a)}function r(l,a,h,u){let d=new Me;h.name!==void 0&&d.SetName(h.name),d.SetTransformation(i(h)),u.AddChildNode(d);for(let m of h.children)r(l,a,m,d);if(h.isMesh&&l.IsMeshVisible(h)){h.children.length===0&&d.SetType(ue.MeshNode);let m=l.ConvertThreeMesh(h),f=a.AddMesh(m);d.AddMeshIndex(f)}}let n=this.GetMainObject(e),o=this.model.GetRootNode();o.SetTransformation(i(n));for(let l of n.children)r(this,this.model,l,o);t()}ConvertThreeMesh(e){let t=null;if(Array.isArray(e.material)){if(t=dt(e.geometry,null),e.geometry.attributes.color===void 0||e.geometry.attributes.color===null){let i=[];for(let r=0;r<e.material.length;r++){let n=e.material[r],o=this.FindOrCreateMaterial(n);i.push(o)}for(let r=0;r<e.geometry.groups.length;r++){let n=e.geometry.groups[r],o=null;n.count===1/0?o=t.TriangleCount():o=n.start/3+n.count/3;for(let l=n.start/3;l<o;l++)t.GetTriangle(l).SetMaterial(i[n.materialIndex])}}}else{let i=this.FindOrCreateMaterial(e.material);t=dt(e.geometry,i)}return e.name!==void 0&&e.name!==null&&t.SetName(e.name),t}FindOrCreateMaterial(e){if(this.materialIdToIndex.has(e.id))return this.materialIdToIndex.get(e.id);let t=this.ConvertThreeMaterial(e),i=this.model.AddMaterial(t);return this.materialIdToIndex.set(e.id,i),i}ConvertThreeMaterial(e){function t(r,n){function o(l){if(l.data!==void 0&&l.data!==null){let a=new ImageData(l.width,l.height),h=l.width*l.height*4;for(let u=0;u<h;u++)a.data[u]=l.data[u];return THREE.ImageUtils.getDataURL(a)}else return THREE.ImageUtils.getDataURL(l)}if(r==null||r.image===void 0||r.image===null)return null;try{let l=o(r.image),a=Ht(l),h=new Re,u=null;return n.has(r.image.src)?u=n.get(r.image.src):r.name!==void 0&&r.name!==null?u=r.name+"."+Gt(a.mimeType):u="Embedded_"+r.id.toString()+"."+Gt(a.mimeType),h.name=u,h.url=l,h.buffer=a.buffer,h.rotation=r.rotation,h.offset.x=r.offset.x,h.offset.y=r.offset.y,h.scale.x=r.repeat.x,h.scale.y=r.repeat.y,h}catch{return null}}let i=new Y;return i.name=e.name,i.color=Ei(e.color),i.opacity=e.opacity,i.transparent=e.transparent,i.alphaTest=e.alphaTest,e.type==="MeshPhongMaterial"&&(i.specular=Ei(e.specular),i.shininess=e.shininess/100),i.diffuseMap=t(e.map,this.objectUrlToFileName),i.normalMap=t(e.normalMap,this.objectUrlToFileName),i.bumpMap=t(e.bumpMap,this.objectUrlToFileName),i}},Mr=class extends qt{constructor(){super()}CanImportExtension(e){return e==="fbx"}GetUpDirection(){return S.Y}GetExternalLibraries(){return["loaders/fflate.min.js","three_loaders/TGALoader.js","three_loaders/FBXLoader.js"]}CreateLoader(e){return e.addHandler(/\.tga$/i,new THREE.TGALoader(e)),new THREE.FBXLoader(e)}GetMainObject(e){return e}},yr=class extends qt{constructor(){super()}CanImportExtension(e){return e==="dae"}GetUpDirection(){return S.Y}GetExternalLibraries(){return["three_loaders/TGALoader.js","three_loaders/ColladaLoader.js"]}CreateLoader(e){return e.addHandler(/\.tga$/i,new THREE.TGALoader(e)),new THREE.ColladaLoader(e)}GetMainObject(e){return e.scene}},br=class extends qt{constructor(){super()}CanImportExtension(e){return e==="wrl"}GetUpDirection(){return S.Y}GetExternalLibraries(){return["three_loaders/chevrotain.min.js","three_loaders/VRMLLoader.js"]}CreateLoader(e){return new THREE.VRMLLoader(e)}GetMainObject(e){return e}IsMeshVisible(e){let t=!0;if(Array.isArray(e.material)){for(let i=0;i<e.material.length;i++)if(e.material[i].side===THREE.BackSide){t=!1;break}}else t=e.material.side!==THREE.BackSide;return t}},Sr=class extends qt{constructor(){super()}CanImportExtension(e){return e==="3mf"}GetUpDirection(){return S.Z}GetExternalLibraries(){return["loaders/fflate.min.js","three_loaders/3MFLoader.js"]}CreateLoader(e){return new THREE.ThreeMFLoader(e)}GetMainObject(e){return e}};var Lt=class{constructor(){this.defaultColor=new w(200,200,200)}},Ge={NoImportableFile:1,FailedToLoadFile:2,ImportFailed:3,UnknownError:4},Xt=class{constructor(e){this.code=e,this.mainFile=null,this.message=null}},os=class{constructor(){this.model=null,this.mainFile=null,this.upVector=null,this.usedFiles=null,this.missingFiles=null}},ls=class{constructor(e){this.getBufferCallback=e,this.fileBuffers=new Map,this.textureBuffers=new Map}GetFileBuffer(e){let t=re(e);if(this.fileBuffers.has(t))return this.fileBuffers.get(t);let i=this.getBufferCallback(t);return this.fileBuffers.set(t,i),i}GetTextureBuffer(e){let t=re(e);if(this.textureBuffers.has(t))return this.textureBuffers.get(t);let i=null,r=this.getBufferCallback(t);return r!==null&&(i={url:Pt(r),buffer:r}),this.textureBuffers.set(t,i),i}},wr=class{constructor(){this.importers=[new gr,new Ir,new xr,new Cr,new hr,new dr,new pr,new Tr,new ar,new mr,new vr,new Mr,new yr,new br,new Sr],this.fileList=new Mi,this.model=null,this.usedFiles=[],this.missingFiles=[]}AddImporter(e){this.importers.push(e)}ImportFiles(e,t,i,r){this.LoadFiles(e,t,()=>{r.onFilesLoaded(),_t(()=>{this.ImportLoadedFiles(i,r)})})}LoadFiles(e,t,i){let r=new Mi;t===K.Url?r.FillFromFileUrls(e):t===K.File&&r.FillFromFileObjects(e);let n=!1;if(this.HasImportableFile(r))n=!0;else{let o=!1;for(let l=0;l<this.missingFiles.length;l++){let a=this.missingFiles[l];r.ContainsFileByPath(a)&&(o=!0)}if(!o)n=!0;else{let l=r.GetFiles();this.fileList.ExtendFromFileList(l),n=!1}}n&&(this.fileList=r),this.fileList.GetContent(()=>{this.DecompressArchives(this.fileList,()=>{i()})})}ImportLoadedFiles(e,t){let i=this.GetImportableFiles(this.fileList);if(i.length===0){t.onImportError(new Xt(Ge.NoImportableFile));return}if(i.length===1||!t.onSelectMainFile){let r=i[0];this.ImportLoadedMainFile(r,e,t)}else{let r=i.map(n=>n.file.name);t.onSelectMainFile(r,n=>{if(n===null){t.onImportError(new Xt(Ge.NoImportableFile));return}_t(()=>{let o=i[n];this.ImportLoadedMainFile(o,e,t)})})}}ImportLoadedMainFile(e,t,i){if(e===null||e.file===null||e.file.content===null){let o=new Xt(Ge.FailedToLoadFile);e!==null&&e.file!==null&&(o.mainFile=e.file.name),i.onImportError(o);return}this.RevokeModelUrls(),this.model=null,this.usedFiles=[],this.missingFiles=[],this.usedFiles.push(e.file.name);let r=e.importer,n=new ls(o=>{let l=null,a=this.fileList.FindFileByPath(o);return a===null||a.content===null?(this.missingFiles.push(o),l=null):(this.usedFiles.push(o),l=a.content),l});r.Import(e.file.name,e.file.extension,e.file.content,{getDefaultMaterialColor:()=>t.defaultColor,getFileBuffer:o=>n.GetFileBuffer(o),getTextureBuffer:o=>n.GetTextureBuffer(o),onSuccess:()=>{this.model=r.GetModel();let o=new os;o.mainFile=e.file.name,o.model=this.model,o.usedFiles=this.usedFiles,o.missingFiles=this.missingFiles,o.upVector=r.GetUpDirection(),i.onImportSuccess(o)},onError:()=>{let o=new Xt(Ge.ImportFailed);o.mainFile=e.file.name,o.message=r.GetErrorMessage(),i.onImportError(o)},onComplete:()=>{r.Clear()}})}DecompressArchives(e,t){let i=e.GetFiles(),r=[];for(let n of i)n.extension==="zip"&&r.push(n);if(r.length===0){t();return}Se("loaders/fflate.min.js").then(()=>{for(let n=0;n<r.length;n++){let o=r[n],l=new Uint8Array(o.content),a=fflate.unzipSync(l);for(let h in a)if(Object.prototype.hasOwnProperty.call(a,h)){let u=new Ti(h,K.Decompressed);u.SetContent(a[h].buffer),e.AddFile(u)}}t()}).catch(()=>{t()})}GetFileList(){return this.fileList}HasImportableFile(e){return this.GetImportableFiles(e).length>0}GetImportableFiles(e){function t(n,o){for(let l=0;l<o.length;l++){let a=o[l];if(a.CanImportExtension(n.extension))return a}return null}let i=[],r=e.GetFiles();for(let n=0;n<r.length;n++){let o=r[n],l=t(o,this.importers);l!==null&&i.push({file:o,importer:l})}return i}RevokeModelUrls(){if(this.model!==null)for(let e=0;e<this.model.MaterialCount();e++)this.model.GetMaterial(e).EnumerateTextureMaps(i=>{i.url!==null&&fn(i.url)})}};function as(s,e,t){let i=e/t,r=i*i;return s*(r/(2*(r-i)+1))}function Pi(s,e,t,i){let r=ie(e,s).Normalize(),n=_e(s,e),o=[];for(let l=0;l<t;l++){let a=i(n,l,t-1);o.push(s.Clone().Offset(r,a))}return o}var hs=class{constructor(){this.prev=new V(0,0),this.curr=new V(0,0),this.diff=new V(0,0),this.buttons=[]}Down(e,t){this.buttons.push(t.which),this.curr=this.GetPositionFromEvent(e,t),this.prev=this.curr.Clone()}Move(e,t){this.curr=this.GetPositionFromEvent(e,t),this.diff=Wi(this.curr,this.prev),this.prev=this.curr.Clone()}Up(e,t){let i=this.buttons.indexOf(t.which);i!==-1&&this.buttons.splice(i,1),this.curr=this.GetPositionFromEvent(e,t)}Leave(e,t){this.buttons=[],this.curr=this.GetPositionFromEvent(e,t)}IsButtonDown(){return this.buttons.length>0}GetButton(){let e=this.buttons.length;return e===0?0:this.buttons[e-1]}GetPosition(){return this.curr}GetMoveDiff(){return this.diff}GetPositionFromEvent(e,t){return st(e,t.clientX,t.clientY)}},us=class{constructor(){this.prevPos=new V(0,0),this.currPos=new V(0,0),this.diffPos=new V(0,0),this.prevDist=0,this.currDist=0,this.diffDist=0,this.fingers=0}Start(e,t){t.touches.length!==0&&(this.fingers=t.touches.length,this.currPos=this.GetPositionFromEvent(e,t),this.prevPos=this.currPos.Clone(),this.currDist=this.GetTouchDistanceFromEvent(e,t),this.prevDist=this.currDist)}Move(e,t){t.touches.length!==0&&(this.currPos=this.GetPositionFromEvent(e,t),this.diffPos=Wi(this.currPos,this.prevPos),this.prevPos=this.currPos.Clone(),this.currDist=this.GetTouchDistanceFromEvent(e,t),this.diffDist=this.currDist-this.prevDist,this.prevDist=this.currDist)}End(e,t){t.touches.length!==0&&(this.fingers=0,this.currPos=this.GetPositionFromEvent(e,t),this.currDist=this.GetTouchDistanceFromEvent(e,t))}IsFingerDown(){return this.fingers!==0}GetFingerCount(){return this.fingers}GetPosition(){return this.currPos}GetMoveDiff(){return this.diffPos}GetDistanceDiff(){return this.diffDist}GetPositionFromEvent(e,t){let i=null;if(t.touches.length!==0){let r=t.touches[0];i=st(e,r.pageX,r.pageY)}return i}GetTouchDistanceFromEvent(e,t){if(t.touches.length!==2)return 0;let i=t.touches[0],r=t.touches[1];return ji(st(e,i.pageX,i.pageY),st(e,r.pageX,r.pageY))}},ds=class{constructor(){this.isClick=!1,this.startPosition=null}Start(e){this.isClick=!0,this.startPosition=e}Move(e){!this.isClick||(this.startPosition!==null?ji(this.startPosition,e)>3&&this.Cancel():this.Cancel())}End(){this.startPosition=null}Cancel(){this.isClick=!1,this.startPosition=null}IsClick(){return this.isClick}},be={None:0,Orbit:1,Pan:2,Zoom:3},Er=class{constructor(e,t,i){this.canvas=e,this.camera=t,this.callbacks=i,this.fixUpVector=!0,this.mouse=new hs,this.touch=new us,this.clickDetector=new ds,this.onMouseClick=null,this.onMouseMove=null,this.onContext=null,this.canvas.addEventListener&&(this.canvas.addEventListener("mousedown",this.OnMouseDown.bind(this)),this.canvas.addEventListener("wheel",this.OnMouseWheel.bind(this)),this.canvas.addEventListener("touchstart",this.OnTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this.OnTouchMove.bind(this)),this.canvas.addEventListener("touchcancel",this.OnTouchEnd.bind(this)),this.canvas.addEventListener("touchend",this.OnTouchEnd.bind(this)),this.canvas.addEventListener("contextmenu",this.OnContextMenu.bind(this))),document.addEventListener&&(document.addEventListener("mousemove",this.OnMouseMove.bind(this)),document.addEventListener("mouseup",this.OnMouseUp.bind(this)),document.addEventListener("mouseleave",this.OnMouseLeave.bind(this)))}SetMouseClickHandler(e){this.onMouseClick=e}SetMouseMoveHandler(e){this.onMouseMove=e}SetContextMenuHandler(e){this.onContext=e}IsFixUpVector(){return this.fixUpVector}SetFixUpVector(e){this.fixUpVector=e}GetCamera(){return this.camera}SetCamera(e){this.camera=e}MoveCamera(e,t){function i(r,n,o,l){r.camera.eye=n.eye[l],r.camera.center=n.center[l],r.camera.up=n.up[l],r.Update(),l<o-1&&requestAnimationFrame(()=>{i(r,n,o,l+1)})}if(e!==null){if(t===0||bn(this.camera,e))this.camera=e;else{let r=as,n={eye:Pi(this.camera.eye,e.eye,t,r),center:Pi(this.camera.center,e.center,t,r),up:Pi(this.camera.up,e.up,t,r)};requestAnimationFrame(()=>{i(this,n,t,0)})}this.Update()}}GetFitToSphereCamera(e,t,i){if(kt(t))return null;let r=this.camera.Clone(),n=ie(r.center,e);r.eye=ie(r.eye,n),r.center=e.Clone();let o=ie(r.eye,r.center).Normalize(),l=i/2;this.canvas.width<this.canvas.height&&(l=l*this.canvas.width/this.canvas.height);let a=t/Math.sin(l*bt);return r.eye=r.center.Clone().Offset(o,a),r}OnMouseDown(e){e.preventDefault(),this.mouse.Down(this.canvas,e),this.clickDetector.Start(this.mouse.GetPosition())}OnMouseMove(e){if(this.mouse.Move(this.canvas,e),this.clickDetector.Move(this.mouse.GetPosition()),this.onMouseMove){let n=st(this.canvas,e.clientX,e.clientY);this.onMouseMove(n)}if(!this.mouse.IsButtonDown())return;let t=this.mouse.GetMoveDiff(),i=this.mouse.GetButton(),r=be.None;if(i===1?e.ctrlKey?r=be.Zoom:e.shiftKey?r=be.Pan:r=be.Orbit:(i===2||i===3)&&(r=be.Pan),r===be.Orbit){let n=.5;this.Orbit(t.x*n,t.y*n)}else if(r===be.Pan){let n=_e(this.camera.eye,this.camera.center),o=.001*n;this.Pan(t.x*o,t.y*o)}else if(r===be.Zoom){let n=.005;this.Zoom(-t.y*n)}this.Update()}OnMouseUp(e){if(this.mouse.Up(this.canvas,e),this.clickDetector.End(),this.clickDetector.IsClick()){let t=this.mouse.GetPosition();this.Click(e.which,t)}}OnMouseLeave(e){this.mouse.Leave(this.canvas,e),this.clickDetector.Cancel()}OnTouchStart(e){e.preventDefault(),this.touch.Start(this.canvas,e),this.clickDetector.Start(this.touch.GetPosition())}OnTouchMove(e){if(e.preventDefault(),this.touch.Move(this.canvas,e),this.clickDetector.Move(this.touch.GetPosition()),!this.touch.IsFingerDown())return;let t=this.touch.GetMoveDiff(),i=this.touch.GetDistanceDiff(),r=this.touch.GetFingerCount(),n=be.None;if(r===1?n=be.Orbit:r===2&&(n=be.Pan),n===be.Orbit){let o=.5;this.Orbit(t.x*o,t.y*o)}else if(n===be.Pan){let o=.005;this.Zoom(i*o);let l=.001*_e(this.camera.eye,this.camera.center);this.Pan(t.x*l,t.y*l)}this.Update()}OnTouchEnd(e){if(e.preventDefault(),this.touch.End(this.canvas,e),this.clickDetector.End(),this.clickDetector.IsClick()){let t=this.touch.GetPosition();this.touch.GetFingerCount()===1&&this.Click(1,t)}}OnMouseWheel(e){let t=e||window.event;t.preventDefault();let i=-t.deltaY/40,r=.1;i<0&&(r=r*-1),this.Zoom(r),this.Update()}OnContextMenu(e){e.preventDefault(),this.clickDetector.IsClick()&&(this.Context(e.clientX,e.clientY),this.clickDetector.Cancel())}Orbit(e,t){let i=e*bt,r=t*bt,n=ie(this.camera.center,this.camera.eye).Normalize(),o=qe(n,this.camera.up).Normalize();if(this.fixUpVector){let a=yn(n,this.camera.up)+r;on(a,0)&&ai(a,Math.PI)&&this.camera.eye.Rotate(o,-r,this.camera.center),this.camera.eye.Rotate(this.camera.up,-i,this.camera.center)}else{let l=qe(o,n).Normalize();this.camera.eye.Rotate(o,-r,this.camera.center),this.camera.eye.Rotate(l,-i,this.camera.center),this.camera.up=l}}Pan(e,t){let i=ie(this.camera.center,this.camera.eye).Normalize(),r=qe(i,this.camera.up).Normalize(),n=qe(r,i).Normalize();this.camera.eye.Offset(r,-e),this.camera.center.Offset(r,-e),this.camera.eye.Offset(n,t),this.camera.center.Offset(n,t)}Zoom(e){let t=ie(this.camera.center,this.camera.eye),r=t.Length()*e;this.camera.eye.Offset(t,r)}Update(){this.callbacks.onUpdate()}Click(e,t){this.onMouseClick&&this.onMouseClick(e,t)}Context(e,t){if(this.onContext){let i={x:e,y:t},r=st(this.canvas,e,t);this.onContext(i,r)}}};function ms(s,e){function t(i,r){for(let n of i)n.polygonOffset=r,n.polygonOffsetUnit=1,n.polygonOffsetFactor=1}t(s.material,e),s.userData.threeMaterials&&t(s.userData.threeMaterials,e)}var Ar=class{constructor(e){this.scene=e,this.mainObject=null,this.mainEdgeObject=null,this.edgeSettings={showEdges:!1,edgeColor:new w(0,0,0),edgeThreshold:1}}SetMainObject(e){this.mainObject=e,this.scene.add(this.mainObject),this.edgeSettings.showEdges&&this.GenerateMainEdgeObject()}UpdateWorldMatrix(){this.mainObject!==null&&this.mainObject.updateWorldMatrix(!0,!0)}SetEdgeSettings(e,t,i){let r=!1;if(e&&(!this.edgeSettings.showEdges||this.edgeSettings.edgeThreshold!==i)&&(r=!0),this.edgeSettings.showEdges=e,this.edgeSettings.edgeThreshold=i,this.edgeSettings.edgeColor=t,this.mainObject!==null)if(this.edgeSettings.showEdges)if(r)this.ClearMainEdgeObject(),this.GenerateMainEdgeObject();else{let n=Ae(this.edgeSettings.edgeColor);this.EnumerateEdges(o=>{o.material.color=n})}else this.ClearMainEdgeObject()}GenerateMainEdgeObject(){let e=Ae(this.edgeSettings.edgeColor);this.mainEdgeObject=new THREE.Object3D,this.UpdateWorldMatrix(),this.EnumerateMeshes(t=>{ms(t,!0);let i=new THREE.EdgesGeometry(t.geometry,this.edgeSettings.edgeThreshold),r=new THREE.LineSegments(i,new THREE.LineBasicMaterial({color:e}));r.applyMatrix4(t.matrixWorld),r.userData=t.userData,r.visible=t.visible,this.mainEdgeObject.add(r)}),this.scene.add(this.mainEdgeObject)}GetBoundingBox(e){let t=!1,i=new THREE.Box3;return this.EnumerateMeshes(r=>{e(r.userData)&&(i.union(new THREE.Box3().setFromObject(r)),t=!0)}),t?i:null}GetBoundingSphere(e){let t=this.GetBoundingBox(e);if(t===null)return null;let i=new THREE.Sphere;return t.getBoundingSphere(i),i}Clear(){this.ClearMainObject(),this.ClearMainEdgeObject()}ClearMainObject(){this.mainObject!==null&&(this.EnumerateMeshes(e=>{e.geometry.dispose()}),this.scene.remove(this.mainObject),this.mainObject=null)}ClearMainEdgeObject(){this.mainEdgeObject!==null&&(this.EnumerateMeshes(e=>{ms(e,!1)}),this.EnumerateEdges(e=>{e.geometry.dispose()}),this.scene.remove(this.mainEdgeObject),this.mainEdgeObject=null)}EnumerateMeshes(e){this.mainObject!==null&&this.mainObject.traverse(t=>{t.isMesh&&e(t)})}EnumerateEdges(e){this.mainEdgeObject!==null&&this.mainEdgeObject.traverse(t=>{t.isLineSegments&&e(t)})}GetMeshIntersectionUnderMouse(e,t,i,r){if(this.mainObject===null||e.x<0||e.x>i||e.y<0||e.y>r)return null;let n=new THREE.Raycaster,o=new THREE.Vector2;o.x=e.x/i*2-1,o.y=-(e.y/r)*2+1,n.setFromCamera(o,t);let l=n.intersectObject(this.mainObject,!0);for(let a=0;a<l.length;a++){let h=l[a];if(h.object.type==="Mesh"&&h.object.visible)return h}return null}},Dr=class{constructor(e){this.scene=e,this.mainObject=null}AddObject(e){this.mainObject===null&&(this.mainObject=new THREE.Object3D,this.scene.add(this.mainObject)),this.mainObject.add(e)}Clear(){this.mainObject!==null&&(this.mainObject.traverse(e=>{(e.isMesh||e.isLineSegments)&&e.geometry.dispose()}),this.scene.remove(this.mainObject),this.mainObject=null)}};function fs(s){return s===S.X?new Ye(new I(2,-3,1.5),new I(0,0,0),new I(1,0,0)):s===S.Y?new Ye(new I(-1.5,2,3),new I(0,0,0),new I(0,1,0)):s===S.Z?new Ye(new I(-1.5,-3,2),new I(0,0,0),new I(0,0,1)):null}function cs(s,e){if(!e(s))return!1;for(let t of s.children)if(!cs(t,e))return!1;return!0}function Ws(s){let e=null;return cs(s,t=>{if(t.isMesh)for(let i of t.material)return i.type==="MeshPhongMaterial"?e=he.Phong:i.type==="MeshStandardMaterial"&&(e=he.Physical),!1;return!0}),e}var ps=class{constructor(){this.direction=S.Z,this.isFixed=!0,this.isFlipped=!1}SetDirection(e,t){this.direction=e,this.isFlipped=!1;let i=fs(this.direction),r=ie(i.eye,i.center),n=_e(t.center,t.eye),o=t.center.Clone().Offset(r,n),l=t.Clone();return this.direction===S.X?(l.up=new I(1,0,0),l.eye=o):this.direction===S.Y?(l.up=new I(0,1,0),l.eye=o):this.direction===S.Z&&(l.up=new I(0,0,1),l.eye=o),l}SetFixed(e,t){return this.isFixed=e,this.isFixed?this.SetDirection(this.direction,t):null}Flip(e){this.isFlipped=!this.isFlipped;let t=e.Clone();return t.up.MultiplyScalar(-1),t}},gs=class{constructor(e){this.scene=e,this.type=he.Phong,this.ambientLight=new THREE.AmbientLight(8947848),this.directionalLight=new THREE.DirectionalLight(8947848),this.environment=null,this.backgroundIsEnvMap=!1,this.scene.add(this.ambientLight),this.scene.add(this.directionalLight)}SetType(e){this.type=e,this.UpdateShading()}UpdateShading(){this.type===he.Phong?(this.ambientLight.color.set(8947848),this.directionalLight.color.set(8947848),this.scene.environment=null,this.scene.background=null):this.type===he.Physical&&(this.ambientLight.color.set(0),this.directionalLight.color.set(5592405),this.scene.environment=this.environment,this.backgroundIsEnvMap?this.scene.background=this.environment:this.scene.background=null)}SetEnvironment(e,t,i){let r=new THREE.CubeTextureLoader;this.environment=r.load(e,()=>{i()}),this.backgroundIsEnvMap=t}UpdateByCamera(e){let t=ie(e.eye,e.center);this.directionalLight.position.set(t.x,t.y,t.z)}CreateHighlightMaterial(e,t){let i=null;return this.type===he.Phong?i=new THREE.MeshPhongMaterial({color:e,side:THREE.DoubleSide}):this.type===he.Physical&&(i=new THREE.MeshStandardMaterial({color:e,side:THREE.DoubleSide})),i!==null&&t&&(i.polygonOffset=!0,i.polygonOffsetUnit=1,i.polygonOffsetFactor=1),i}},Yt=class{constructor(){this.canvas=null,this.renderer=null,this.scene=null,this.geometry=null,this.extraGeometry=null,this.camera=null,this.shading=null,this.navigation=null,this.upVector=null,this.settings={animationSteps:40}}Init(e){this.canvas=e,this.canvas.id="viewer";let t={canvas:this.canvas,antialias:!0};this.renderer=new THREE.WebGLRenderer(t),window.devicePixelRatio&&this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setClearColor("#ffffff",1),this.renderer.setSize(this.canvas.width,this.canvas.height),this.scene=new THREE.Scene,this.geometry=new Ar(this.scene),this.extraGeometry=new Dr(this.scene),this.InitNavigation(),this.InitShading(),this.Render()}SetMouseClickHandler(e){this.navigation.SetMouseClickHandler(e)}SetMouseMoveHandler(e){this.navigation.SetMouseMoveHandler(e)}SetContextMenuHandler(e){this.navigation.SetContextMenuHandler(e)}SetEnvironmentMapSettings(e,t){this.shading.SetEnvironment(e,t,()=>{this.Render()}),this.shading.UpdateShading(),this.Render()}SetBackgroundColor(e){let t="#"+le(e);this.renderer.setClearColor(t,1),this.Render()}SetEdgeSettings(e,t,i){this.geometry.SetEdgeSettings(e,t,i),this.Render()}GetCanvas(){return this.canvas}GetCamera(){return this.navigation.GetCamera()}SetCamera(e){this.navigation.SetCamera(e),this.Render()}Resize(e,t){let i=hn(this.canvas,e,t);this.ResizeRenderer(i.width,i.height)}ResizeRenderer(e,t){window.devicePixelRatio&&this.renderer.setPixelRatio(window.devicePixelRatio),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.Render()}FitSphereToWindow(e,t){if(e===null)return;let i=new I(e.center.x,e.center.y,e.center.z),r=e.radius,n=this.camera.fov,o=this.navigation.GetFitToSphereCamera(i,r,n);this.navigation.MoveCamera(o,t?this.settings.animationSteps:0)}AdjustClippingPlanesToSphere(e){e!==null&&(e.radius<10?(this.camera.near=.01,this.camera.far=100):e.radius<100?(this.camera.near=.1,this.camera.far=1e3):e.radius<1e3?(this.camera.near=10,this.camera.far=1e4):(this.camera.near=100,this.camera.far=1e6),this.camera.updateProjectionMatrix(),this.Render())}IsFixUpVector(){return this.navigation.IsFixUpVector()}SetFixUpVector(e){let t=this.navigation.GetCamera(),i=this.upVector.SetFixed(e,t);this.navigation.SetFixUpVector(e),i!==null&&this.navigation.MoveCamera(i,this.settings.animationSteps),this.Render()}SetUpVector(e,t){let i=this.navigation.GetCamera(),r=this.upVector.SetDirection(e,i),n=t?this.settings.animationSteps:0;this.navigation.MoveCamera(r,n),this.Render()}FlipUpVector(){let e=this.navigation.GetCamera(),t=this.upVector.Flip(e);this.navigation.MoveCamera(t,0),this.Render()}Render(){let e=this.navigation.GetCamera();this.camera.position.set(e.eye.x,e.eye.y,e.eye.z),this.camera.up.set(e.up.x,e.up.y,e.up.z),this.camera.lookAt(new THREE.Vector3(e.center.x,e.center.y,e.center.z)),this.shading.UpdateByCamera(e),this.renderer.render(this.scene,this.camera)}SetMainObject(e){let t=Ws(e);this.geometry.SetMainObject(e),this.shading.SetType(t),this.Render()}AddExtraObject(e){this.extraGeometry.AddObject(e),this.Render()}Clear(){this.geometry.Clear(),this.extraGeometry.Clear(),this.Render()}ClearExtra(){this.extraGeometry.Clear(),this.Render()}SetMeshesVisibility(e){this.geometry.EnumerateMeshes(t=>{let i=e(t.userData);t.visible!==i&&(t.visible=i)}),this.geometry.EnumerateEdges(t=>{let i=e(t.userData);t.visible!==i&&(t.visible=i)}),this.Render()}SetMeshesHighlight(e,t){function i(n,o){let l=[];for(let a=0;a<n.length;a++)l.push(o);return l}let r=this.CreateHighlightMaterial(e);this.geometry.EnumerateMeshes(n=>{t(n.userData)?n.userData.threeMaterials===null&&(n.userData.threeMaterials=n.material,n.material=i(n.material,r)):n.userData.threeMaterials!==null&&(n.material=n.userData.threeMaterials,n.userData.threeMaterials=null)}),this.Render()}CreateHighlightMaterial(e){let t=this.geometry.edgeSettings.showEdges;return this.shading.CreateHighlightMaterial(e,t)}GetMeshUserDataUnderMouse(e){let t=this.GetMeshIntersectionUnderMouse(e);return t===null?null:t.object.userData}GetMeshIntersectionUnderMouse(e){let t=this.GetCanvasSize(),i=this.geometry.GetMeshIntersectionUnderMouse(e,this.camera,t.width,t.height);return i===null?null:i}GetBoundingBox(e){return this.geometry.GetBoundingBox(e)}GetBoundingSphere(e){return this.geometry.GetBoundingSphere(e)}EnumerateMeshesUserData(e){this.geometry.EnumerateMeshes(t=>{e(t.userData)})}InitNavigation(){this.camera=new THREE.PerspectiveCamera(45,this.canvas.width/this.canvas.height,.1,1e3),this.scene.add(this.camera);let e=this.renderer.domElement,t=fs(S.Z);this.navigation=new Er(e,t,{onUpdate:()=>{this.Render()}}),this.upVector=new ps}InitShading(){this.shading=new gs(this.scene)}GetShadingType(){return this.shading.type}GetImageSize(){let e=new THREE.Vector2;return this.renderer.getSize(e),{width:parseInt(e.x,10),height:parseInt(e.y,10)}}GetCanvasSize(){let e=this.canvas.width,t=this.canvas.height;return window.devicePixelRatio&&(e/=window.devicePixelRatio,t/=window.devicePixelRatio),{width:e,height:t}}GetImageAsDataUrl(e,t){let i=this.GetImageSize(),r=e,n=t;window.devicePixelRatio&&(r/=window.devicePixelRatio,n/=window.devicePixelRatio),this.ResizeRenderer(r,n),this.Render();let o=this.renderer.domElement.toDataURL();return this.ResizeRenderer(i.width,i.height),o}};var Kt=class{constructor(){this.skipNextEvent=!1,this.eventListener=null}SetEventListener(e){this.eventListener=e,window.onhashchange=this.OnChange.bind(this)}SkipNextEventHandler(){this.skipNextEvent=!0}HasHash(){return this.GetHash().length>0}ClearHash(){this.SetHash("")}GetModelFilesFromHash(){return lt(this.GetHash()).GetModelUrls()}SetModelFilesToHash(e){let t=vi(e);this.SetHash(t)}GetCameraFromHash(){return lt(this.GetHash()).GetCamera()}GetBackgroundFromHash(){return lt(this.GetHash()).GetBackgroundColor()}GetEnvironmentSettingsFromHash(){return lt(this.GetHash()).GetEnvironmentSettings()}GetDefaultColorFromHash(){return lt(this.GetHash()).GetDefaultColor()}GetEdgeSettingsFromHash(){return lt(this.GetHash()).GetEdgeSettings()}GetHash(){return window.location.hash.substring(1)}SetHash(e){window.location.hash=e}OnChange(){if(this.skipNextEvent){this.skipNextEvent=!1;return}this.eventListener()}};var Gr=class{constructor(){this.forceMediumpForMaterials=!1}},Pr=class{constructor(){this.defaultMaterial=null}},xs=class{constructor(e){this.callbacks=e,this.texturesNeeded=0,this.texturesLoaded=0,this.threeObject=null}OnTextureNeeded(){this.texturesNeeded+=1}OnTextureLoaded(){this.texturesLoaded+=1,this.callbacks.onTextureLoaded(),this.Finish()}OnModelLoaded(e){this.threeObject=e,this.Finish()}Finish(){this.threeObject!==null&&this.texturesNeeded===this.texturesLoaded&&this.callbacks.onModelLoaded(this.threeObject)}},Cs=class{constructor(e,t){this.meshInstances=[],this.AddNode(e,t)}AddNode(e,t){let i=e.GetTransformation().GetMatrix(),r=new THREE.Matrix4().fromArray(i.Get());t.applyMatrix4(r);for(let n of e.GetChildNodes()){let o=new THREE.Object3D;t.add(o),this.AddNode(n,o)}for(let n of e.GetMeshIndices())this.meshInstances.push({node:e,threeNode:t,meshIndex:n})}GetMeshInstances(){return this.meshInstances}};function vs(s,e,t,i){function r(m,f,c,p,g,v){function x(b,A){A.wrapS=THREE.RepeatWrapping,A.wrapT=THREE.RepeatWrapping,A.rotation=b.rotation,A.offset.x=b.offset.x,A.offset.y=b.offset.y,A.repeat.x=b.scale.x,A.repeat.y=b.scale.y}function M(b,A,z,G){if(z===null||!z.IsValid())return;let P=new THREE.TextureLoader;b.OnTextureNeeded(),P.load(z.url,_=>{x(z,_),A.needsUpdate=!0,G(_),b.OnTextureLoaded()},null,_=>{b.OnTextureLoaded()})}let T=f.GetMaterial(c),N=Ae(T.color);T.vertexColors&&N.setRGB(1,1,1);let L={color:N,vertexColors:T.vertexColors,opacity:T.opacity,transparent:T.transparent,alphaTest:T.alphaTest,side:THREE.DoubleSide};g.forceMediumpForMaterials&&(L.precision="mediump");let y=null;if(p===he.Phong){if(y=new THREE.MeshPhongMaterial(L),T.type===Q.Phong){let b=Ae(T.specular);X(T.shininess,0)&&b.setRGB(0,0,0),y.specular=b,y.shininess=T.shininess*100,M(m,y,T.specularMap,A=>{y.specularMap=A})}}else p===he.Physical&&(y=new THREE.MeshStandardMaterial(L),T.type===Q.Physical&&(y.metalness=T.metalness,y.roughness=T.roughness,M(m,y,T.metalnessMap,b=>{y.metalness=1,y.roughness=1,y.metalnessMap=b,y.roughnessMap=b})));let U=Ae(T.emissive);return y.emissive=U,M(m,y,T.diffuseMap,b=>{T.multiplyDiffuseMap||y.color.setRGB(1,1,1),y.map=b}),M(m,y,T.bumpMap,b=>{y.bumpMap=b}),M(m,y,T.normalMap,b=>{y.normalMap=b}),M(m,y,T.emissiveMap,b=>{y.emissiveMap=b}),T.isDefault&&(v.defaultMaterial=y),y}function n(m,f,c){let p=m.GetMesh(f.meshIndex),g=p.TriangleCount(),v=[];for(let _=0;_<g;_++)v.push(_);v.sort((_,se)=>{let O=p.GetTriangle(_),ve=p.GetTriangle(se);return O.mat-ve.mat});let x=new THREE.BufferGeometry,M=[],T=[],N=new Map,L=[],y=[],U=[],b=[],A=[];A.push({start:0,end:-1});let z=p.VertexColorCount()>0,G=p.TextureUVCount()>0;for(let _=0;_<v.length;_++){let se=v[_],O=p.GetTriangle(se),ve=p.GetVertex(O.v0),Ve=p.GetVertex(O.v1),oi=p.GetVertex(O.v2);if(L.push(ve.x,ve.y,ve.z,Ve.x,Ve.y,Ve.z,oi.x,oi.y,oi.z),O.HasVertexColors()){let W=Ae(p.GetVertexColor(O.c0)),Mt=Ae(p.GetVertexColor(O.c1)),yt=Ae(p.GetVertexColor(O.c2));y.push(W.r,W.g,W.b,Mt.r,Mt.g,Mt.b,yt.r,yt.g,yt.b)}else z&&y.push(0,0,0,0,0,0,0,0,0);let It=p.GetNormal(O.n0),Tt=p.GetNormal(O.n1),rt=p.GetNormal(O.n2);if(U.push(It.x,It.y,It.z,Tt.x,Tt.y,Tt.z,rt.x,rt.y,rt.z),O.HasTextureUVs()){let W=p.GetTextureUV(O.u0),Mt=p.GetTextureUV(O.u1),yt=p.GetTextureUV(O.u2);b.push(W.x,W.y,Mt.x,Mt.y,yt.x,yt.y)}else G&&b.push(0,0,0,0,0,0);let $=O.mat;N.has($)||(N.set($,M.length),M.push(c[$]),T.push($),_>0&&(A[A.length-1].end=_-1,A.push({start:A[A.length-1].end+1,end:-1})))}A[A.length-1].end=g-1,x.setAttribute("position",new THREE.Float32BufferAttribute(L,3)),y.length!==0&&x.setAttribute("color",new THREE.Float32BufferAttribute(y,3)),x.setAttribute("normal",new THREE.Float32BufferAttribute(U,3)),b.length!==0&&x.setAttribute("uv",new THREE.Float32BufferAttribute(b,2));for(let _=0;_<A.length;_++){let se=A[_];x.addGroup(se.start*3,(se.end-se.start+1)*3,_)}let P=new THREE.Mesh(x,M);return P.userData={originalMeshId:f,originalMaterials:T,threeMaterials:null},P}function o(m,f,c,p){let g=f.GetMesh(c.meshIndex);if(Nt(g)===Qe.TriangleMesh){let x=n(f,c,p);m.add(x)}}function l(m,f,c,p){let g=f.GetRootNode(),x=new Cs(g,m).GetMeshInstances();Pn(x.length,100,{runTask:(M,T,N)=>{for(let L=M;L<=T;L++){let y=x[L],U=y.node,b=y.threeNode,A=new $e(U.GetId(),y.meshIndex);o(b,f,A,c)}N()},onReady:()=>{p.OnModelLoaded(m)}})}let a=new xs(i),h=Wn(s),u=[];for(let m=0;m<s.MaterialCount();m++){let f=r(a,s,m,h,e,t);u.push(f)}let d=new THREE.Object3D;l(d,s,u,a)}var _r=class{constructor(){this.importer=new wr,this.inProgress=!1,this.defaultMaterial=null,this.hasHighpDriverIssue=zn()}InProgress(){return this.inProgress}LoadModel(e,t,i,r){this.inProgress||(this.inProgress=!0,r.onLoadStart(),this.importer.ImportFiles(e,t,i,{onFilesLoaded:()=>{r.onImportStart()},onSelectMainFile:(n,o)=>{r.onSelectMainFile?r.onSelectMainFile(n,o):o(0)},onImportSuccess:n=>{r.onVisualizationStart();let o=new Gr;o.forceMediumpForMaterials=this.hasHighpDriverIssue;let l=new Pr;vs(n.model,o,l,{onTextureLoaded:()=>{r.onTextureLoaded()},onModelLoaded:a=>{if(this.defaultMaterial=l.defaultMaterial,n.upVector===S.X){let h=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),Math.PI/2);a.quaternion.multiply(h)}else if(n.upVector===S.Z){let h=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2);a.quaternion.multiply(h)}r.onModelFinished(n,a),this.inProgress=!1}})},onImportError:n=>{r.onLoadError(n),this.inProgress=!1}}))}GetImporter(){return this.importer}GetDefaultMaterial(){return this.defaultMaterial}ReplaceDefaultMaterialColor(e){this.defaultMaterial!==null&&!this.defaultMaterial.vertexColors&&(this.defaultMaterial.color=Ae(e))}};var Jt=null;function Rr(){Jt!==null&&(Jt.Close(),Jt=null)}function js(){Jt=null}function qs(s){Rr(),Jt=s}var _i=class{constructor(){this.modalDiv=pe("ov_modal"),this.modalDiv.addEventListener("mousemove",e=>{e.stopPropagation()}),this.overlayDiv=null,this.resizeHandler=null,this.positionCalculator=null,this.closeHandler=null,this.isOpen=!1,this.closeable=!0}GetContentDiv(){return this.modalDiv}SetCloseable(e){this.closeable=e}SetPositionCalculator(e){this.positionCalculator=e}SetCloseHandler(e){this.closeHandler=e}Open(){this.isOpen||(qs(this),this.overlayDiv=C(document.body,"ov_modal_overlay"),document.body.appendChild(this.modalDiv),this.resizeHandler=this.Resize.bind(this),window.addEventListener("resize",this.resizeHandler),this.closeable&&(this.overlayDiv.addEventListener("click",e=>{e.preventDefault(),this.Close()}),this.overlayDiv.addEventListener("mousemove",e=>{e.stopPropagation()}),this.overlayDiv.addEventListener("contextmenu",e=>{e.preventDefault(),this.Close()})),this.isOpen=!0,this.Resize())}Close(){!this.isOpen||(js(),window.removeEventListener("resize",this.resizeHandler),this.closeHandler!==null&&this.closeHandler(),this.modalDiv.remove(),this.overlayDiv.remove(),this.overlayDiv=null,this.resizeHandler=null,this.isOpen=!1)}Resize(){let e=window.innerWidth,t=window.innerHeight,i=(e-this.modalDiv.offsetWidth)/2,r=(t-this.modalDiv.offsetHeight)/3;if(this.positionCalculator!==null){let n=this.positionCalculator();i=n.x,r=n.y}this.modalDiv.style.left=i+"px",this.modalDiv.style.top=r+"px"}},Ri=class extends _i{constructor(){super();this.SetCloseable(!1),this.textDiv=null}Init(e){let t=this.GetContentDiv();t.classList.add("ov_progress"),C(t,"ov_progress_img",'<svg><use href="assets/images/3dviewer_net_logo.svg#logo"></use></svg>'),this.textDiv=C(t,"ov_progress_text"),this.SetText(e)}SetText(e){this.textDiv.innerHTML=e}},Je=class extends _i{constructor(){super()}Init(e,t){function i(a,h){let u=C(h,"ov_button ov_dialog_button",a.name);a.subClass&&u.classList.add(a.subClass),u.addEventListener("click",()=>{a.onClick()})}let r=this.GetContentDiv();r.classList.add("ov_dialog"),C(r,"ov_dialog_title",e);let n=C(r,"ov_dialog_content"),o=C(r,"ov_dialog_buttons"),l=C(o,"ov_dialog_buttons_inner");for(let a=0;a<t.length;a++)i(t[a],l);return n}},Fi=class extends _i{constructor(){super()}Init(e){let t=this.GetContentDiv();return t.classList.add("ov_popup"),this.SetPositionCalculator(e),t}},Fr=class extends Fi{constructor(){super();this.listDiv=null}Init(e){let t=super.Init(e);return this.listDiv=C(t,"ov_popup_list ov_thin_scrollbar"),t}AddListItem(e,t){let i=C(this.listDiv,"ov_popup_list_item");if(e.icon&&Z(i,e.icon,"left_inline"),e.color){let r=C(i,"ov_popup_list_item_icon"),n=pi(e.color);r.appendChild(n)}C(i,"ov_popup_list_item_name",e.name),i.addEventListener("click",t.onClick),Yi()&&t.onHoverStart&&t.onHoverStop&&(i.addEventListener("mouseover",()=>{t.onHoverStart()}),i.addEventListener("mouseout",()=>{t.onHoverStop()}))}};function ft(s,e,t){let i=new Je,r=i.Init(s,[{name:"OK",onClick(){i.Close()}}]);return C(r,"ov_dialog_message",e),t!==null&&C(r,"ov_dialog_submessage",t),i.Open(),i}function Bt(s,e){if(s.length===0)return null;let t=new Fr;t.Init(()=>e.calculatePosition(t.GetContentDiv()));for(let i=0;i<s.length;i++){let r=s[i];t.AddListItem(r,{onHoverStart:function(){e.onHoverStart&&e.onHoverStart(i)},onHoverStop:function(){e.onHoverStop&&e.onHoverStop(i)},onClick:function(){t.Close(),e.onClick(i)}})}return t.Open(),t}function Is(s,e){let t=s.getBoundingClientRect();return{x:t.left-e.offsetWidth,y:t.top}}function Ni(s,e){let t=s.getBoundingClientRect();return{x:t.left+s.offsetWidth,y:t.top+s.offsetHeight-e.offsetHeight}}function Ts(s,e){let t=window.innerWidth,i=window.innerHeight,r=s.x,n=s.y,o=r+e.offsetWidth,l=n+e.offsetHeight;return o>t&&(r=r-(o-t)),l>i&&(n=n-(l-i)),{x:r,y:n}}var Zt=class{constructor(){this.modelLoader=new _r,this.modalDialog=null}LoadModel(e,t,i,r){if(this.modelLoader.InProgress())return;let n=null;this.modelLoader.LoadModel(e,t,i,{onLoadStart:()=>{this.CloseDialogIfOpen(),r.onStart(),n=new Ri,n.Init("Loading Model"),n.Open()},onSelectMainFile:(o,l)=>{n.Close(),this.modalDialog=this.ShowFileSelectorDialog(o,a=>{n.Open(),l(a)})},onImportStart:()=>{n.SetText("Importing Model")},onVisualizationStart:()=>{n.SetText("Visualizing Model")},onModelFinished:(o,l)=>{n.Close(),r.onFinish(o,l)},onTextureLoaded:()=>{r.onRender()},onLoadError:o=>{n.Close(),this.modalDialog=this.ShowErrorDialog(o),r.onFinish({},{})}})}GetModelLoader(){return this.modelLoader}GetImporter(){return this.modelLoader.GetImporter()}ShowErrorDialog(e){return e.code===Ge.NoImportableFile?ft("\u9519\u8BEF","\u6CA1\u6709\u53EF\u5BFC\u5165\u7684\u6587\u4EF6.",null):e.code===Ge.FailedToLoadFile?ft("\u9519\u8BEF","\u5BFC\u5165\u6587\u4EF6\u5931\u8D25.","\u8FDC\u7A0B\u6587\u4EF6\u8BF7\u6C42\u5931\u8D25\uFF0C\u8BF7\u786E\u8BA4\u5730\u5740\u53CA\u670D\u52A1\u5668\u6743\u9650\u6B63\u786E."):e.code===Ge.ImportFailed?ft("\u9519\u8BEF","\u5BFC\u5165\u6A21\u578B\u5931\u8D25.",e.message):ft("\u9519\u8BEF","\u672A\u77E5\u9519\u8BEF.",null)}ShowFileSelectorDialog(e,t){let i=new Je,r=i.Init("Select Model",[{name:"Cancel",subClass:"outline",onClick(){i.Close()}}]);i.SetCloseHandler(()=>{t(null)}),C(r,"ov_dialog_message","Multiple importable models found. Select the model you would like to import from the list below.");let o=C(r,"ov_dialog_section"),l=C(o,"ov_dialog_import_file_list ov_thin_scrollbar");for(let a=0;a<e.length;a++){let h=e[a],u=C(l,"ov_dialog_file_link");Z(u,"meshes","ov_file_link_img"),C(u,"ov_dialog_file_link_text",h),u.addEventListener("click",()=>{i.SetCloseHandler(null),i.Close(),t(a)})}return i.Open(),i}CloseDialogIfOpen(){this.modalDialog!==null&&(this.modalDialog.Close(),this.modalDialog=null)}};var Nr=class{constructor(e){this.parameters=e,this.viewer=new Yt,this.hashHandler=new Kt,this.modelLoaderUI=new Zt}Load(){let e=ee(this.parameters.viewerDiv,"canvas");if(this.viewer.Init(e),this.Resize(),this.hashHandler.HasHash()){let t=this.hashHandler.GetModelFilesFromHash();if(t===null)return;Ii(t);let i="fishermans_bastion",r=!1,n=this.hashHandler.GetEnvironmentSettingsFromHash();n!==null&&(i=n.environmentMapName,r=n.backgroundIsEnvMap);let o="assets/envmaps/"+i+"/",l=[o+"posx.jpg",o+"negx.jpg",o+"posy.jpg",o+"negy.jpg",o+"posz.jpg",o+"negz.jpg"];this.viewer.SetEnvironmentMapSettings(l,r);let a=this.hashHandler.GetBackgroundFromHash();a!==null&&this.viewer.SetBackgroundColor(a);let h=this.hashHandler.GetEdgeSettingsFromHash();h!==null&&this.viewer.SetEdgeSettings(h.showEdges,h.edgeColor,h.edgeThreshold);let u=new Lt,d=this.hashHandler.GetDefaultColorFromHash();d!==null&&(u.defaultColor=d),this.modelLoaderUI.LoadModel(t,K.Url,u,{onStart:()=>{},onFinish:(c,p)=>{this.OnModelFinished(p)},onRender:()=>{this.viewer.Render()},onError:c=>{}});let m=vi(t),f=this.parameters.websiteLinkDiv.getAttribute("href")+"#"+m;this.parameters.websiteLinkDiv.setAttribute("href",f)}window.addEventListener("resize",()=>{this.Resize()})}Resize(){let e=window.innerWidth,t=window.innerHeight;this.viewer.Resize(e,t)}OnModelFinished(e){this.viewer.SetMainObject(e);let t=this.viewer.GetBoundingSphere(r=>!0);this.viewer.AdjustClippingPlanesToSphere(t);let i=this.hashHandler.GetCameraFromHash();i!==null?this.viewer.SetCamera(i):(this.viewer.SetUpVector(S.Y,!1),this.viewer.FitSphereToWindow(t,!1))}};var Qt=class{constructor(e){this.parentDiv=e,this.panelDiv=C(e),R(this.panelDiv,!1),this.visible=!1}GetName(){return null}GetIcon(){return null}IsVisible(){return this.visible}Show(e){this.visible!==e&&(this.visible=e,R(this.panelDiv,this.visible))}Resize(){}Clear(){}},$t=class{constructor(e){this.parentDiv=e,this.menuDiv=C(e,"ov_panel_set_menu"),this.contentDiv=C(e,"ov_panel_set_content ov_thin_scrollbar"),this.panels=[],this.panelButtons=[],this.panelsVisible=!0,this.panelsPrevWidth=null,this.callbacks=null}Init(e){this.callbacks=e}GetContentDiv(){return this.contentDiv}AddPanel(e){this.panels.push(e);let t=Z(this.menuDiv,e.GetIcon(),"ov_panel_set_menu_button");t.setAttribute("alt",e.GetName()),t.setAttribute("title",e.GetName()),this.panelButtons.push(t),t.addEventListener("click",()=>{e===this.GetVisiblePanel()?this.ShowPanels(!1):(this.ShowPanels(!0),this.ShowPanel(e))})}IsPanelsVisible(){return this.panelsVisible}ShowPanels(e){if(!!this.IsParentVisible()&&this.panelsVisible!==e){if(this.panelsVisible=e,this.panelsVisible)R(this.contentDiv,!0),Et(this.parentDiv,this.menuDiv.offsetWidth+this.panelsPrevWidth);else{for(let t of this.panelButtons)t.classList.remove("selected");for(let t of this.panels)t.Show(!1);this.panelsPrevWidth=this.contentDiv.offsetWidth,Et(this.parentDiv,this.menuDiv.offsetWidth),R(this.contentDiv,!1)}this.callbacks.onShowHidePanels(this.panelsVisible),this.callbacks.onResize()}}ShowPanel(e){if(e===this.GetVisiblePanel())return;let t=this.GetPanelButton(e);for(let i of this.panelButtons)i!==t&&i.classList.remove("selected");t.classList.add("selected");for(let i of this.panels)i!==e&&i.Show(!1);e.Show(!0),e.Resize()}GetVisiblePanel(){if(!this.panelsVisible)return null;for(let e of this.panels)if(e.IsVisible())return e;return null}SetPanelIcon(e,t){let i=this.GetPanelButton(e);je(i,t)}GetPanelButton(e){let t=this.panels.indexOf(e);return this.panelButtons[t]}Resize(){let e=this.parentDiv.offsetHeight;if(ce(this.menuDiv,e),ce(this.contentDiv,e),this.panelsVisible)for(let t of this.panels)t.IsVisible()&&t.Resize()}IsParentVisible(){return di(this.parentDiv)}Clear(){for(let e of this.panels)e.Clear()}};function Ms(s){s.scrollIntoView({behavior:"smooth",block:"nearest"})}var it=class{constructor(e){this.imagePath=e,this.mainElement=zt(this.imagePath,"ov_tree_item_button"),this.mainElement.setAttribute("src",this.imagePath)}SetImage(e){this.imagePath=e,je(this.mainElement,this.imagePath)}OnClick(e){this.mainElement.addEventListener("click",t=>{t.stopPropagation(),e(t)})}GetDomElement(){return this.mainElement}},Vr=class{constructor(e,t){if(this.name=e,this.parent=null,this.mainElement=pe("ov_tree_item"),this.mainElement.setAttribute("title",this.name),this.nameElement=C(this.mainElement,"ov_tree_item_name",this.name),Vt(t)){let i=zt(t,"ov_tree_item_icon");ot(i,this.nameElement)}}OnClick(e){this.mainElement.classList.add("clickable"),this.mainElement.style.cursor="pointer",this.mainElement.addEventListener("click",e)}SetParent(e){this.parent=e}AddDomElements(e){e.appendChild(this.mainElement)}},ct=class extends Vr{constructor(e,t){super(e,t);this.selected=!1}SetSelected(e){if(this.selected=e,this.selected){this.mainElement.classList.add("selected");let t=this.parent;if(t===null)Ms(this.mainElement);else for(;t!==null;)t.ShowChildren(!0),Ms(this.mainElement),t=t.parent}else this.mainElement.classList.remove("selected")}},ei=class extends ct{constructor(e,t){super(e,t);this.buttonsDiv=pe("ov_tree_item_button_container"),ot(this.buttonsDiv,this.nameElement)}AppendButton(e){this.buttonsDiv.appendChild(e.GetDomElement())}},pt=class extends Vr{constructor(e,t){super(e,t);this.children=[],this.isVisible=!0,this.isChildrenVisible=!1,this.childrenDiv=null,this.openButtonIcon="arrow_down",this.closeButtonIcon="arrow_right",this.openCloseButton=zt(this.openButtonIcon,"ov_tree_item_icon"),ot(this.openCloseButton,this.nameElement)}AddChild(e){this.CreateChildrenDiv(),this.children.push(e),e.SetParent(this),e.AddDomElements(this.childrenDiv)}ExpandAll(e){for(let t of this.children)t instanceof pt&&(t.ShowChildren(e),t.ExpandAll(e))}Show(e){this.isVisible=e,this.childrenDiv!==null&&(this.isVisible?(R(this.mainElement,!0),this.childrenDiv.classList.add("ov_tree_view_children")):(R(this.mainElement,!1),this.childrenDiv.classList.remove("ov_tree_view_children")))}ShowChildren(e){this.isChildrenVisible=e,this.childrenDiv!==null&&(e?(je(this.openCloseButton,this.openButtonIcon),R(this.childrenDiv,!0)):(je(this.openCloseButton,this.closeButtonIcon),R(this.childrenDiv,!1)))}CreateChildrenDiv(){return this.childrenDiv===null&&(this.childrenDiv=pe("ov_tree_view_children"),un(this.childrenDiv,this.mainElement),this.Show(this.isVisible),this.ShowChildren(this.isChildrenVisible),this.OnClick(e=>{this.isChildrenVisible=!this.isChildrenVisible,this.ShowChildren(this.isChildrenVisible)})),this.childrenDiv}},Lr=class extends pt{constructor(e,t){super(e,t);this.buttonsDiv=pe("ov_tree_item_button_container"),ot(this.buttonsDiv,this.nameElement)}AppendButton(e){this.buttonsDiv.appendChild(e.GetDomElement())}},Br=class{constructor(e){this.mainDiv=C(e,"ov_tree_view"),this.children=[]}AddClass(e){this.mainDiv.classList.add(e)}AddChild(e){e.AddDomElements(this.mainDiv),this.children.push(e)}Clear(){Ie(this.mainDiv),this.children=[]}};var ti=class{constructor(e){this.parentDiv=e,this.callbacks=null,this.popup=null,this.button=C(this.parentDiv,"ov_panel_button"),this.buttonText=C(this.button,"ov_panel_button_text"),Z(this.button,"arrow_right","ov_panel_button_icon"),this.button.addEventListener("click",()=>{this.OnButtonClick()})}Init(e){this.callbacks=e}OnButtonClick(){}Clear(){this.popup!==null&&(this.popup.Close(),this.popup=null)}},gt=class extends Qt{constructor(e){super(e);this.callbacks=null,this.titleDiv=C(this.panelDiv,"ov_navigator_tree_title"),this.treeDiv=C(this.panelDiv,"ov_navigator_tree_panel ov_thin_scrollbar"),this.treeView=new Br(this.treeDiv);let t=this.GetName();this.titleDiv.innerHTML=t,this.titleDiv.setAttribute("title",t)}Clear(){this.treeView.Clear()}GetName(){return null}Init(e){this.callbacks=e}Fill(e){}};var Or=class extends gt{constructor(e){super(e)}GetName(){return"Files"}GetIcon(){return"files"}Resize(){let e=We(this.titleDiv),t=this.parentDiv.offsetHeight;ce(this.treeDiv,t-e)}Clear(){super.Clear()}Fill(e){super.Fill(e);let t=e.usedFiles,i=e.missingFiles;if(i.length>0){let r=new pt("Missing Files",null);r.ShowChildren(!0),this.treeView.AddChild(r);for(let o=0;o<i.length;o++){let l=i[o],a=new ei(l),h=new it("open");h.OnClick(()=>{this.callbacks.onFileBrowseButtonClicked()}),a.AppendButton(h),r.AddChild(a)}let n=new pt("Available Files",null);n.ShowChildren(!0),this.treeView.AddChild(n);for(let o=0;o<t.length;o++){let l=t[o],a=new ct(l);n.AddChild(a)}}else for(let r=0;r<t.length;r++){let n=t[r],o=new ct(n);this.treeView.AddChild(o)}}};var Ce={No:0,Parents:1,Children:2,All:3},kr=class extends ct{constructor(e,t,i){super(e);this.OnClick(()=>{i.onSelected(t)})}},Ot=class extends ei{constructor(e,t,i,r){super(e,t);this.meshInstanceId=i,this.visible=!0,this.fitToWindowButton=new it("fit"),this.fitToWindowButton.OnClick(()=>{r.onFitToWindow(this.meshInstanceId)}),this.AppendButton(this.fitToWindowButton),this.showHideButton=new it("visible"),this.showHideButton.OnClick(()=>{r.onShowHide(this.meshInstanceId)}),this.AppendButton(this.showHideButton),this.OnClick(()=>{r.onSelected(this.meshInstanceId)})}GetMeshInstanceId(){return this.meshInstanceId}IsVisible(){return this.visible}SetVisible(e,t){if(this.visible!==e&&(this.visible=e,this.visible?this.showHideButton.SetImage("visible"):this.showHideButton.SetImage("hidden"),t===Ce.Parents&&this.parent instanceof He)){let i=this.parent.CalculateIsVisible();this.parent.SetVisible(i,Ce.Parents)}}},He=class extends Lr{constructor(e,t,i){super(e,null);this.nodeId=t,this.callbacks=i,this.visible=!0,this.fitToWindowButton=new it("fit"),this.fitToWindowButton.OnClick(()=>{this.callbacks.onFitToWindow(t)}),this.AppendButton(this.fitToWindowButton),this.showHideButton=new it("visible"),this.showHideButton.OnClick(()=>{this.callbacks.onShowHide(t)}),this.AppendButton(this.showHideButton)}GetNodeId(){return this.nodeId}IsVisible(){return this.visible}CalculateIsVisible(){let e=!1;for(let t of this.children)if((t instanceof He||t instanceof Ot)&&t.IsVisible()){e=!0;break}return e}SetVisible(e,t){if(this.visible!==e){if(this.visible=e,this.visible?this.showHideButton.SetImage("visible"):this.showHideButton.SetImage("hidden"),Vt(this.callbacks.onVisibilityChanged)&&this.callbacks.onVisibilityChanged(this.visible),t===Ce.Children||t===Ce.All)for(let i of this.children)(i instanceof He||i instanceof Ot)&&i.SetVisible(this.visible,Ce.Children);if((t===Ce.Parents||t===Ce.All)&&this.parent instanceof He){let i=this.parent.CalculateIsVisible();this.parent.SetVisible(i,Ce.Parents)}}}EnumerateMeshItems(e){for(let t of this.children)t instanceof He?t.EnumerateMeshItems(e):t instanceof Ot&&e(t)}};var ys=class extends ti{constructor(e){super(e);this.meshInfoArray=null}Update(e){if(this.meshInfoArray=e,this.meshInfoArray===null)return;let t="Meshes ("+this.meshInfoArray.length+")";this.buttonText.innerHTML=t}OnButtonClick(){if(this.meshInfoArray===null)return;let e=[];for(let t=0;t<this.meshInfoArray.length;t++){let i=this.meshInfoArray[t];e.push({name:mi(i.name)})}e.length!==0&&(this.popup=Bt(e,{calculatePosition:t=>Ni(this.button,t),onHoverStart:t=>{let i=this.meshInfoArray[t];this.callbacks.onMeshHover(i.meshId)},onHoverStop:t=>{this.callbacks.onMeshHover(null)},onClick:t=>{let i=this.meshInfoArray[t];this.callbacks.onMeshSelected(i.meshId)}}))}},Ur=class extends gt{constructor(e){super(e);this.callbacks=null,this.materialIndexToItem=new Map,this.popupDiv=C(this.panelDiv,"ov_navigator_info_panel"),this.meshesButton=new ys(this.popupDiv)}GetName(){return"Materials"}GetIcon(){return"materials"}Resize(){let e=We(this.titleDiv),t=We(this.popupDiv),i=this.parentDiv.offsetHeight;ce(this.treeDiv,i-e-t)}Clear(){super.Clear(),this.meshesButton.Clear(),this.materialIndexToItem=new Map}Init(e){super.Init(e),this.meshesButton.Init({onMeshHover:t=>{this.callbacks.onMeshTemporarySelected(t)},onMeshSelected:t=>{this.callbacks.onMeshSelected(t)}})}Fill(e){super.Fill(e);let t=e.model;for(let i=0;i<t.MaterialCount();i++){let r=t.GetMaterial(i),n=fi(r.name),o=new kr(n,i,{onSelected:l=>{this.callbacks.onMaterialSelected(l)}});this.materialIndexToItem.set(i,o),this.treeView.AddChild(o)}}GetMaterialItem(e){return this.materialIndexToItem.get(e)}SelectMaterialItem(e,t){this.GetMaterialItem(e).SetSelected(t)}UpdateMeshList(e){this.meshesButton.Update(e)}};var me={Simple:0,FlatList:1,TreeView:2},bs=class extends ti{constructor(e){super(e);this.materialInfoArray=null}Update(e){if(this.materialInfoArray=e,this.materialInfoArray===null)return;let t="Materials ("+this.materialInfoArray.length+")";this.buttonText.innerHTML=t}OnButtonClick(){if(this.materialInfoArray===null)return;let e=[];for(let t=0;t<this.materialInfoArray.length;t++){let i=this.materialInfoArray[t];e.push({name:fi(i.name),color:i.color})}e.length!==0&&(this.popup=Bt(e,{calculatePosition:t=>Ni(this.button,t),onClick:t=>{let i=this.materialInfoArray[t];this.callbacks.onMaterialSelected(i.index)}}))}},Hr=class extends gt{constructor(e){super(e);this.callbacks=null,this.nodeIdToItem=new Map,this.meshInstanceIdToItem=new Map,this.rootItem=null,this.mode=me.Simple,this.buttons=null,this.treeView.AddClass("tight"),this.titleButtonsDiv=C(this.titleDiv,"ov_navigator_tree_title_buttons"),this.buttonsDiv=pe("ov_navigator_buttons"),ot(this.buttonsDiv,this.treeDiv),this.popupDiv=C(this.panelDiv,"ov_navigator_info_panel"),this.materialsButton=new bs(this.popupDiv)}GetName(){return"Meshes"}GetIcon(){return"meshes"}Resize(){let e=We(this.titleDiv),t=0;di(this.buttonsDiv)&&(t=We(this.buttonsDiv));let i=We(this.popupDiv),r=this.parentDiv.offsetHeight;ce(this.treeDiv,r-e-t-i)}Clear(){this.ClearMeshTree(),Ie(this.titleButtonsDiv),Ie(this.buttonsDiv),this.buttons=null}ClearMeshTree(){super.Clear(),this.materialsButton.Clear(),this.nodeIdToItem=new Map,this.meshInstanceIdToItem=new Map,this.rootItem=null}Init(e){super.Init(e),this.materialsButton.Init({onMeshHover:t=>{this.callbacks.onMeshTemporarySelected(t)},onMeshSelected:t=>{this.callbacks.onMeshSelected(t)},onMaterialSelected:t=>{this.callbacks.onMaterialSelected(t)}})}Fill(e){super.Fill(e);let t=e.model.GetRootNode(),i=!1;for(let r of t.GetChildNodes())if(r.GetType()===ue.GroupNode){i=!0;break}this.mode===me.Simple?i&&(this.mode=me.FlatList):(this.mode===me.FlatList||this.mode===me.TreeView)&&(i||(this.mode=me.Simple)),this.FillButtons(e),this.mode===me.Simple?(R(this.buttonsDiv,!1),this.titleDiv.classList.add("withbuttons"),this.titleDiv.classList.remove("nomargin")):(R(this.buttonsDiv,!0),this.titleDiv.classList.remove("withbuttons"),this.titleDiv.classList.add("nomargin")),this.FillMeshTree(e.model),this.Resize()}FillButtons(e){function t(n,o,l,a){o.div=C(n,"ov_navigator_button"),o.div.setAttribute("alt",o.name),o.div.setAttribute("title",o.name),l&&o.div.classList.add(l),o.iconDiv=Z(o.div,o.icon),o.div.addEventListener("click",()=>{a()})}function i(n,o){let l=o===me.TreeView;l?(n.flatList.iconDiv.classList.remove("selected"),n.treeView.iconDiv.classList.add("selected")):(n.flatList.iconDiv.classList.add("selected"),n.treeView.iconDiv.classList.remove("selected")),R(n.separator,l),R(n.expandAll.div,l),R(n.collapseAll.div,l)}function r(n,o){let l=[];n.EnumerateMeshItems(a=>(a.IsVisible()||l.push(a.GetMeshInstanceId()),!0)),n.ClearMeshTree();for(let a of l)n.GetMeshItem(a).SetVisible(!1,Ce.Parents);i(n.buttons,n.mode),n.callbacks.onViewTypeChanged()}this.buttons={flatList:{name:"Flat list",icon:"flat_list",div:null,iconDiv:null},treeView:{name:"Tree view",icon:"tree_view",div:null,iconDiv:null},separator:null,expandAll:{name:"Expand all",icon:"expand",div:null,iconDiv:null},collapseAll:{name:"Collapse all",icon:"collapse",div:null,iconDiv:null},showHideMeshes:{name:"Show/hide meshes",icon:"visible",div:null,iconDiv:null},fitToWindow:{name:"Fit meshes to window",icon:"fit",div:null,iconDiv:null}},this.mode===me.Simple?(t(this.titleButtonsDiv,this.buttons.showHideMeshes,"right",()=>{let n=this.rootItem.GetNodeId();this.callbacks.onNodeShowHide(n)}),t(this.titleButtonsDiv,this.buttons.fitToWindow,"right",()=>{let n=this.rootItem.GetNodeId();this.callbacks.onNodeFitToWindow(n)})):(t(this.buttonsDiv,this.buttons.flatList,null,()=>{this.mode!==me.FlatList&&(this.mode=me.FlatList,r(this,e))}),t(this.buttonsDiv,this.buttons.treeView,null,()=>{this.mode!==me.TreeView&&(this.mode=me.TreeView,r(this,e))}),this.buttons.separator=C(this.buttonsDiv,"ov_navigator_buttons_separator"),t(this.buttonsDiv,this.buttons.expandAll,null,()=>{this.rootItem.ExpandAll(!0)}),t(this.buttonsDiv,this.buttons.collapseAll,null,()=>{this.rootItem.ExpandAll(!1)}),t(this.buttonsDiv,this.buttons.showHideMeshes,"right",()=>{let n=this.rootItem.GetNodeId();this.callbacks.onNodeShowHide(n)}),t(this.buttonsDiv,this.buttons.fitToWindow,"right",()=>{let n=this.rootItem.GetNodeId();this.callbacks.onNodeFitToWindow(n)}),i(this.buttons,this.mode))}FillMeshTree(e){function t(l,a,h,u,d,m){let f=a.GetMesh(u),c=mi(f.GetName()),p=new $e(h.GetId(),u),g=m===me.TreeView?"tree_mesh":null,v=new Ot(c,g,p,{onShowHide:x=>{l.callbacks.onMeshShowHide(x)},onFitToWindow:x=>{l.callbacks.onMeshFitToWindow(x)},onSelected:x=>{l.callbacks.onMeshSelected(x)}});l.meshInstanceIdToItem.set(p.GetKey(),v),d.AddChild(v)}function i(l,a){let h=pn(a.GetName()),u=a.GetId(),d=new He(h,u,{onShowHide:m=>{l.callbacks.onNodeShowHide(m)},onFitToWindow:m=>{l.callbacks.onNodeFitToWindow(m)}});return l.nodeIdToItem.set(u,d),d}function r(l,a){let h=a.GetId(),u=new He(null,h,{onVisibilityChanged:d=>{d?je(l.buttons.showHideMeshes.iconDiv,"visible"):je(l.buttons.showHideMeshes.iconDiv,"hidden")}});return u.Show(!1),u.ShowChildren(!0),l.treeView.AddChild(u),l.nodeIdToItem.set(h,u),u}function n(l,a,h,u,d){let m=[];for(let f of h.GetChildNodes())if(d===me.TreeView)if(f.GetType()===ue.GroupNode){let c=i(l,f);u.AddChild(c),n(l,a,f,c,d)}else f.GetType()===ue.MeshNode&&m.push(f);else n(l,a,f,u,d);for(let f of m)n(l,a,f,u,d);for(let f of h.GetMeshIndices())t(l,a,h,f,u,d)}let o=e.GetRootNode();this.rootItem=r(this,o),n(this,e,o,this.rootItem,this.mode)}UpdateMaterialList(e){this.materialsButton.Update(e)}GetNodeItem(e){return this.nodeIdToItem.get(e)}MeshItemCount(){return this.meshInstanceIdToItem.size}GetMeshItem(e){return this.meshInstanceIdToItem.get(e.GetKey())}EnumerateNodeItems(e){for(let t of this.nodeIdToItem.values())if(!e(t))break}EnumerateMeshItems(e){for(let t of this.meshInstanceIdToItem.values())if(!e(t))break}IsMeshVisible(e){return this.GetMeshItem(e).IsVisible()}HasHiddenMesh(){let e=!1;return this.EnumerateMeshItems(t=>t.IsVisible()?!0:(e=!0,!1)),e}ShowAllMeshes(e){this.EnumerateNodeItems(t=>(t.SetVisible(e,Ce.No),!0)),this.EnumerateMeshItems(t=>(t.SetVisible(e,Ce.No),!0))}ToggleNodeVisibility(e){let t=this.GetNodeItem(e);t.SetVisible(!t.IsVisible(),Ce.All)}ToggleMeshVisibility(e){let t=this.GetMeshItem(e);t.SetVisible(!t.IsVisible(),Ce.Parents)}IsMeshIsolated(e){let t=!0;return this.EnumerateMeshItems(i=>!i.GetMeshInstanceId().IsEqual(e)&&i.IsVisible()?(t=!1,!1):!0),t}IsolateMesh(e){this.ShowAllMeshes(!1),this.ToggleMeshVisibility(e)}};var ne={Material:1,Mesh:2},xt=class{constructor(e,t){this.type=e,this.materialIndex=null,this.meshInstanceId=null,this.type===ne.Material?this.materialIndex=t:this.type===ne.Mesh&&(this.meshInstanceId=t)}IsEqual(e){if(this.type!==e.type)return!1;if(this.type===ne.Material)return this.materialIndex===e.materialIndex;if(this.type===ne.Mesh)return this.meshInstanceId.IsEqual(e.meshInstanceId)}},zr=class{constructor(e,t){this.mainDiv=e,this.splitterDiv=t,this.panelSet=new $t(e),this.callbacks=null,this.selection=null,this.tempSelectedMeshId=null,this.filesPanel=new Or(this.panelSet.GetContentDiv()),this.materialsPanel=new Ur(this.panelSet.GetContentDiv()),this.meshesPanel=new Hr(this.panelSet.GetContentDiv()),this.panelSet.AddPanel(this.filesPanel),this.panelSet.AddPanel(this.materialsPanel),this.panelSet.AddPanel(this.meshesPanel),this.panelSet.ShowPanel(this.meshesPanel)}ShowPanels(e){this.panelSet.ShowPanels(e)}Init(e){this.callbacks=e,this.panelSet.Init({onResize:()=>{R(this.splitterDiv,this.panelSet.IsPanelsVisible()),this.callbacks.onResize()},onShowHidePanels:t=>{this.callbacks.onShowHidePanels(t)}}),this.filesPanel.Init({onFileBrowseButtonClicked:()=>{this.callbacks.openFileBrowserDialog()}}),this.materialsPanel.Init({onMaterialSelected:t=>{this.SetSelection(new xt(ne.Material,t))},onMeshTemporarySelected:t=>{this.tempSelectedMeshId=t,this.callbacks.updateMeshesSelection()},onMeshSelected:t=>{this.SetSelection(new xt(ne.Mesh,t))}}),this.meshesPanel.Init({onMeshSelected:t=>{this.SetSelection(new xt(ne.Mesh,t))},onMeshShowHide:t=>{this.ToggleMeshVisibility(t)},onMeshFitToWindow:t=>{this.FitMeshToWindow(t)},onNodeShowHide:t=>{this.ToggleNodeVisibility(t)},onNodeFitToWindow:t=>{this.FitNodeToWindow(t)},onMaterialSelected:t=>{this.SetSelection(new xt(ne.Material,t))},onViewTypeChanged:()=>{this.SetSelection(null)}}),gi(this.splitterDiv,this.mainDiv,!1,()=>{this.callbacks.onResize()})}GetWidth(){let e=At(this.mainDiv),t=0;return this.panelSet.IsPanelsVisible()&&(t=this.splitterDiv.offsetWidth),e+t}Resize(e){Ze(this.mainDiv,e),ce(this.splitterDiv,e),this.panelSet.Resize()}FillTree(e){this.filesPanel.Fill(e),e.missingFiles.length===0?this.panelSet.SetPanelIcon(this.filesPanel,"files"):this.panelSet.SetPanelIcon(this.filesPanel,"missing_files"),this.materialsPanel.Fill(e),this.meshesPanel.Fill(e),this.OnSelectionChanged()}MeshItemCount(){return this.meshesPanel.MeshItemCount()}IsMeshVisible(e){return this.meshesPanel.IsMeshVisible(e)}HasHiddenMesh(){return this.meshesPanel.HasHiddenMesh()}ShowAllMeshes(e){this.meshesPanel.ShowAllMeshes(e),this.callbacks.updateMeshesVisibility()}ToggleNodeVisibility(e){this.meshesPanel.ToggleNodeVisibility(e),this.callbacks.updateMeshesVisibility()}ToggleMeshVisibility(e){this.meshesPanel.ToggleMeshVisibility(e),this.callbacks.updateMeshesVisibility()}IsMeshIsolated(e){return this.meshesPanel.IsMeshIsolated(e)}IsolateMesh(e){this.meshesPanel.IsolateMesh(e),this.callbacks.updateMeshesVisibility()}GetSelectedMeshId(){return this.tempSelectedMeshId!==null?this.tempSelectedMeshId:this.selection===null||this.selection.type!==ne.Mesh?null:this.selection.meshInstanceId}SetSelection(e){function t(n,o,l){o.type===ne.Material?(l&&n.panelSet.IsPanelsVisible()&&n.panelSet.ShowPanel(n.materialsPanel),n.materialsPanel.SelectMaterialItem(o.materialIndex,l)):o.type===ne.Mesh&&(l&&n.panelSet.IsPanelsVisible()&&n.panelSet.ShowPanel(n.meshesPanel),n.meshesPanel.GetMeshItem(o.meshInstanceId).SetSelected(l))}function i(n,o){n.selection=o,n.OnSelectionChanged()}let r=this.selection;r!==null&&t(this,r,!1),i(this,e),this.tempSelectedMeshId=null,this.selection!==null&&(r!==null&&r.IsEqual(this.selection)?(t(this,this.selection,!1),i(this,null)):t(this,this.selection,!0)),this.callbacks.updateMeshesSelection()}OnSelectionChanged(){this.selection===null?this.callbacks.onModelSelected():this.selection.type===ne.Material?this.callbacks.onMaterialSelected(this.selection.materialIndex):this.selection.type===ne.Mesh&&this.callbacks.onMeshSelected(this.selection.meshInstanceId),this.UpdatePanels()}UpdatePanels(){let e=null,t=null;this.selection!==null&&(this.selection.type===ne.Material?e=this.selection.materialIndex:this.selection.type===ne.Mesh&&(t=this.selection.meshInstanceId));let i=this.callbacks.getMeshesForMaterial(e);this.materialsPanel.UpdateMeshList(i);let r=this.callbacks.getMaterialsForMesh(t);this.meshesPanel.UpdateMaterialList(r)}FitNodeToWindow(e){let t=new Set;this.meshesPanel.GetNodeItem(e).EnumerateMeshItems(r=>{t.add(r.GetMeshInstanceId())}),this.callbacks.fitMeshesToWindow(t)}FitMeshToWindow(e){this.callbacks.fitMeshToWindow(e)}Clear(){this.panelSet.Clear(),this.selection=null}};function Wr(s,e){let t=new Date,i=365;t.setTime(t.getTime()+i*24*60*60*1e3),document.cookie=s+"="+e+"; expires="+t.toUTCString()+";"}function Ct(s,e){let i=decodeURIComponent(document.cookie).split(";");for(let r=0;r<i.length;r++){let n=i[r].trim();if(n.startsWith(s+"="))return n.substring(s.length+1)}return e}function vt(s,e){let t=Ct(s,null);return t===null?e:t==="true"}function Vi(s,e){Wr(s,e?"true":"false")}function jr(s,e){let t=Ct(s,null);return t===null?e:parseInt(t,10)}function Li(s,e){let t=Ct(s,null);return t===null?e:ge.StringToColor(t)}var fe={Light:1,Dark:2},ii=class{constructor(){this.environmentMapName="fishermans_bastion",this.backgroundIsEnvMap=!1,this.backgroundColor=new w(255,255,255),this.defaultColor=new w(200,200,200),this.showEdges=!1,this.edgeColor=new w(0,0,0),this.edgeThreshold=1,this.themeId=fe.Light}LoadFromCookies(){this.environmentMapName=Ct("ov_environment_map","fishermans_bastion"),this.backgroundIsEnvMap=vt("ov_background_is_envmap",!1),this.backgroundColor=Li("ov_background_color",new w(255,255,255)),this.defaultColor=Li("ov_default_color",new w(200,200,200)),this.showEdges=vt("ov_show_edges",!1),this.edgeColor=Li("ov_edge_color",new w(0,0,0)),this.edgeThreshold=jr("ov_edge_threshold",1),this.themeId=jr("ov_theme_id",fe.Light)}SaveToCookies(){}};function Xs(s,e,t){let i=_e(s,e),r=_e(e,t),n=_e(s,t),o=(i+r+n)/2,l=o*(o-i)*(o-r)*(o-n);return l<0?0:Math.sqrt(l)}function Ys(s,e,t){return Zi(s,qe(e,t))/6}function Ss(s){let e=0;return s.EnumerateTriangleVertices((t,i,r)=>{e+=Ys(t,i,r)}),e}function ws(s){let e=0;return s.EnumerateTriangleVertices((t,i,r)=>{e+=Xs(t,i,r)}),e}var ri=class extends Qt{constructor(e){super(e);this.callbacks=null,this.titleDiv=null,this.HasTitle()&&(this.titleDiv=C(this.panelDiv,"ov_sidebar_title"),C(this.titleDiv,"ov_sidebar_title_text",this.GetName()),this.titleDiv.setAttribute("title",this.GetName())),this.contentDiv=C(this.panelDiv,"ov_sidebar_content ov_thin_scrollbar")}GetName(){return null}HasTitle(){return!0}Clear(){Ie(this.contentDiv)}Init(e){this.callbacks=e}};var qr=class extends ri{constructor(e){super(e)}GetName(){return"\u8BE6\u60C5"}GetIcon(){return"details"}AddObject3DProperties(e){this.Clear();let t=C(this.contentDiv,"ov_property_table"),i=rr(e),r=ie(i.max,i.min);if(this.AddProperty(t,new F(D.Integer,"\u9876\u70B9\u6570",e.VertexCount())),this.AddProperty(t,new F(D.Integer,"\u4E09\u89D2\u9762",e.TriangleCount())),this.AddProperty(t,new F(D.Number,"\u957F",r.x)),this.AddProperty(t,new F(D.Number,"\u5BBD",r.y)),this.AddProperty(t,new F(D.Number,"\u9AD8",r.z)),this.AddCalculatedProperty(t,"\u4F53\u79EF",()=>{if(!kn(e))return null;let n=Ss(e);return new F(D.Number,null,n)}),this.AddCalculatedProperty(t,"\u8868\u9762\u79EF",()=>{let n=ws(e);return new F(D.Number,null,n)}),e.PropertyGroupCount()>0){let n=C(this.contentDiv,"ov_property_table ov_property_table_custom");for(let o=0;o<e.PropertyGroupCount();o++){let l=e.GetPropertyGroup(o);this.AddPropertyGroup(n,l);for(let a=0;a<l.PropertyCount();a++){let h=l.GetProperty(a);this.AddPropertyInGroup(n,h)}}}this.Resize()}AddMaterialProperties(e){function t(n,o,l,a){if(a===null||a.name===null)return;let h=re(a.name);n.AddProperty(o,new F(D.Text,l,h))}this.Clear();let i=C(this.contentDiv,"ov_property_table"),r=null;e.type===Q.Phong?r="Phong":e.type===Q.Physical&&(r="Physical"),this.AddProperty(i,new F(D.Text,"Source",e.isDefault?"Default":"Model")),this.AddProperty(i,new F(D.Text,"Type",r)),e.vertexColors?this.AddProperty(i,new F(D.Text,"Color","Vertex colors")):(this.AddProperty(i,new F(D.Color,"Color",e.color)),e.type===Q.Phong&&(this.AddProperty(i,new F(D.Color,"Ambient",e.ambient)),this.AddProperty(i,new F(D.Color,"Specular",e.specular)))),e.type===Q.Physical&&(this.AddProperty(i,new F(D.Percent,"Metalness",e.metalness)),this.AddProperty(i,new F(D.Percent,"Roughness",e.roughness))),this.AddProperty(i,new F(D.Percent,"Opacity",e.opacity)),t(this,i,"Diffuse Map",e.diffuseMap),t(this,i,"Bump Map",e.bumpMap),t(this,i,"Normal Map",e.normalMap),t(this,i,"Emissive Map",e.emissiveMap),e.type===Q.Phong?t(this,i,"Specular Map",e.specularMap):e.type===Q.Physical&&t(this,i,"Metallic Map",e.metalnessMap),this.Resize()}AddPropertyGroup(e,t){C(e,"ov_property_table_row group",t.name).setAttribute("title",t.name)}AddProperty(e,t){let i=C(e,"ov_property_table_row"),r=C(i,"ov_property_table_cell ov_property_table_name",t.name+":"),n=C(i,"ov_property_table_cell ov_property_table_value");return r.setAttribute("title",t.name),this.DisplayPropertyValue(t,n),i}AddPropertyInGroup(e,t){this.AddProperty(e,t).classList.add("ingroup")}AddCalculatedProperty(e,t,i){let r=C(e,"ov_property_table_row"),n=C(r,"ov_property_table_cell ov_property_table_name",t+":"),o=C(r,"ov_property_table_cell ov_property_table_value");n.setAttribute("title",t),C(o,"ov_property_table_button","\u8BA1\u7B97...").addEventListener("click",()=>{Ie(o),o.innerHTML="Please wait...",_t(()=>{let a=i();a===null?o.innerHTML="-":this.DisplayPropertyValue(a,o)})})}DisplayPropertyValue(e,t){Ie(t);let i=null;if(e.type===D.Text)i=e.value;else if(e.type===D.Integer)i=e.value.toLocaleString();else if(e.type===D.Number)i=e.value.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});else if(e.type===D.Boolean)i=e.value?"True":"False";else if(e.type===D.Percent)i=parseInt(e.value*100,10).toString()+"%";else if(e.type===D.Color){let r="#"+le(e.value),n=pi(e.value);t.appendChild(n),ee(t,"span",null,r)}i!==null&&(t.innerHTML=i,t.setAttribute("title",i))}};var Es={EnvironmentMap:!1};function Xr(s,e,t,i){let r=Pickr.create({el:s,theme:"monolith",position:"left-start",swatches:t,comparison:!1,default:"#"+le(e),components:{preview:!1,opacity:!1,hue:!0,interaction:{hex:!1,rgba:!1,hsla:!1,hsva:!1,cmyk:!1,input:!0,clear:!1,save:!1}}});return r.on("change",(n,o,l)=>{let a=n.toRGBA(),h=new w(parseInt(a[0],10),parseInt(a[1],10),parseInt(a[2],10));i(h)}),r}var As=class extends Fi{constructor(){super()}ShowPopup(e,t,i){let r=super.Init(()=>Is(e,r)),n=[{element:null,name:"fishermans_bastion"},{element:null,name:"citadella"},{element:null,name:"maskonaive"},{element:null,name:"teide"},{element:null,name:"ice_river"},{element:null,name:"park"}];for(let l of n)l.element=ee(r,"img","ov_environment_map_preview"),l.element.setAttribute("src","assets/envmaps/"+l.name+".jpg"),l.name===t.environmentMapName&&l.element.classList.add("selected"),l.element.addEventListener("click",()=>{for(let a of n)a.element.classList.remove("selected");l.element.classList.add("selected"),t.environmentMapName=l.name,i.onEnvironmentMapChange()});let o=Ki(r,"use_as_background","Use as background",t.backgroundIsEnvMap,()=>{t.backgroundIsEnvMap=o.checked,i.onEnvironmentMapChange()});r.classList.add("sidebar"),this.Open()}},Bi=class{constructor(e,t){this.parentDiv=e,this.contentDiv=C(this.parentDiv,"ov_sidebar_settings_section"),C(this.contentDiv,"ov_sidebar_title",t)}Init(e,t){}Update(e){}Clear(){}},Ds=class extends Bi{constructor(e){super(e,"\u6A21\u578B\u5C55\u793A");this.environmentMapButton=null,this.environmentMapPopup=null,this.backgroundColorPicker=null,this.edgeDisplayToggle=null,this.edgeColorPicker=null,this.thresholdSlider=null,this.thresholdSliderValue=null,this.edgeSettingsDiv=null}Init(e,t){Es.EnvironmentMap&&(this.environmentMapButton=C(this.contentDiv,"ov_panel_button"),Z(this.environmentMapButton,"arrow_left","ov_panel_button_left_icon"),C(this.environmentMapButton,"ov_panel_button_text","Environment Map"),this.environmentMapButton.addEventListener("click",()=>{this.environmentMapPopup=new As,this.environmentMapPopup.ShowPopup(this.environmentMapButton,e,{onEnvironmentMapChange:()=>{t.onEnvironmentMapChange()}})}));let i=C(this.contentDiv,"ov_sidebar_parameter"),r=C(i,"ov_color_picker");C(i,null,"\u80CC\u666F\u8272");let n=["#ffffff","#e3e3e3","#c9c9c9","#898989","#5f5f5f","#494949","#383838","#0f0f0f"];this.backgroundColorPicker=Xr(r,e.backgroundColor,n,d=>{e.backgroundColor=d,t.onBackgroundColorChange()});let o=C(this.contentDiv,"ov_sidebar_parameter");this.edgeDisplayToggle=Ji(o,"ov_sidebar_parameter_toggle"),C(o,"ov_sidebar_parameter_text","\u663E\u793A\u8FB9\u7EBF"),this.edgeSettingsDiv=C(this.contentDiv,"ov_sidebar_settings_padded"),this.edgeDisplayToggle.OnChange(()=>{R(this.edgeSettingsDiv,this.edgeDisplayToggle.GetStatus()),e.showEdges=this.edgeDisplayToggle.GetStatus(),t.onShowEdgesChange()});let l=C(this.edgeSettingsDiv,"ov_sidebar_settings_row"),a=["#ffffff","#e3e3e3","#c9c9c9","#898989","#5f5f5f","#494949","#383838","#0f0f0f"],h=C(l,"ov_color_picker");this.edgeColorPicker=Xr(h,e.edgeColor,a,d=>{e.edgeColor=d,t.onEdgeColorChange()}),C(l,null,"\u8FB9\u7EBF\u989C\u8272");let u=C(this.edgeSettingsDiv,"ov_sidebar_settings_row large");this.thresholdSlider=In(u,0,90),this.thresholdSlider.setAttribute("title","\u8FB9\u7EBF\u89D2\u5EA6\u9608\u503C"),this.thresholdSliderValue=ee(u,"span","ov_slider_label"),this.thresholdSlider.addEventListener("input",()=>{this.thresholdSliderValue.innerHTML=this.thresholdSlider.value}),this.thresholdSlider.addEventListener("change",()=>{e.edgeThreshold=this.thresholdSlider.value,t.onEdgeThresholdChange()}),this.thresholdSlider.value=e.edgeThreshold,this.thresholdSliderValue.innerHTML=e.edgeThreshold,this.edgeDisplayToggle.SetStatus(e.showEdges),R(this.edgeSettingsDiv,e.showEdges)}UpdateVisibility(e){this.environmentMapButton!==null&&R(this.environmentMapButton,e)}Update(e){this.backgroundColorPicker!==null&&this.backgroundColorPicker.setColor("#"+le(e.backgroundColor)),this.edgeDisplayToggle!==null&&(this.edgeDisplayToggle.SetStatus(e.showEdges),R(this.edgeSettingsDiv,e.showEdges),this.edgeColorPicker.setColor("#"+le(e.edgeColor)),this.thresholdSlider.value=e.edgeThreshold,this.thresholdSliderValue.innerHTML=e.edgeThreshold)}Clear(){this.environmentMapPopup!==null&&(this.environmentMapPopup.Close(),this.environmentMapPopup=null),this.backgroundColorPicker!==null&&this.backgroundColorPicker.hide(),this.edgeColorPicker!==null&&this.edgeColorPicker.hide()}},Gs=class extends Bi{constructor(e){super(e,"Import Settings");this.defaultColorPicker=null}Init(e,t){let i=C(this.contentDiv,"ov_sidebar_parameter"),r=C(i,"ov_color_picker");C(i,null,"Default Color");let n=["#ffffff","#e3e3e3","#cc3333","#fac832","#4caf50","#3393bd","#9b27b0","#fda4b8"];this.defaultColorPicker=Xr(r,e.defaultColor,n,o=>{e.defaultColor=o,t.onDefaultColorChange()})}Update(e){this.defaultColorPicker!==null&&this.defaultColorPicker.setColor("#"+le(e.defaultColor))}UpdateVisibility(e){this.contentDiv!==null&&R(this.contentDiv,e)}Clear(){this.defaultColorPicker!==null&&this.defaultColorPicker.hide()}},Ps=class extends Bi{constructor(e){super(e,"\u5916\u89C2");this.darkModeToggle=null}Init(e,t){let i=C(this.contentDiv,"ov_sidebar_parameter");this.darkModeToggle=Ji(i,"ov_sidebar_parameter_toggle"),this.darkModeToggle.OnChange(()=>{e.themeId=this.darkModeToggle.GetStatus()?fe.Dark:fe.Light,t.onThemeChange()}),C(i,null,"\u9ED1\u6697\u6A21\u5F0F");let r=e.themeId===fe.Dark;this.darkModeToggle.SetStatus(r)}Update(e){if(this.darkModeToggle!==null){let t=e.themeId===fe.Dark;this.darkModeToggle.SetStatus(t)}}},Yr=class extends ri{constructor(e,t){super(e);this.settings=t,this.sectionsDiv=C(this.contentDiv,"ov_sidebar_settings_sections ov_thin_scrollbar"),this.modelDisplaySection=new Ds(this.sectionsDiv),this.importParametersSection=new Gs(this.sectionsDiv),this.appearanceSection=new Ps(this.sectionsDiv),this.resetToDefaultsButton=C(this.contentDiv,"ov_button ov_panel_button outline","\u56DE\u5230\u9ED8\u8BA4"),this.resetToDefaultsButton.addEventListener("click",()=>{this.ResetToDefaults()})}GetName(){return"Settings"}HasTitle(){return!1}GetIcon(){return"settings"}Clear(){this.modelDisplaySection.Clear(),this.importParametersSection.Clear(),this.appearanceSection.Clear()}Init(e){super.Init(e),this.modelDisplaySection.Init(this.settings,{onEnvironmentMapChange:()=>{e.onEnvironmentMapChange()},onBackgroundColorChange:()=>{e.onBackgroundColorChange()},onShowEdgesChange:()=>{e.onEdgeDisplayChange()},onEdgeColorChange:()=>{e.onEdgeDisplayChange()},onEdgeThresholdChange:()=>{e.onEdgeDisplayChange()}}),this.importParametersSection.Init(this.settings,{onDefaultColorChange:()=>{e.onDefaultColorChange()}}),this.appearanceSection.Init(this.settings,{onThemeChange:()=>{this.settings.themeId===fe.Light?(this.settings.backgroundColor=new w(255,255,255),this.settings.defaultColor=new w(200,200,200)):this.settings.themeId===fe.Dark&&(this.settings.backgroundColor=new w(42,43,46),this.settings.defaultColor=new w(200,200,200)),this.modelDisplaySection.Update(this.settings),this.importParametersSection.Update(this.settings),e.onThemeChange()}})}UpdateSettings(e,t){this.modelDisplaySection.UpdateVisibility(e),this.importParametersSection.UpdateVisibility(t),this.Resize()}ResetToDefaults(){let e=new ii;this.settings.environmentMapName=e.environmentMapName,this.settings.backgroundIsEnvMap=e.backgroundIsEnvMap,this.settings.backgroundColor=e.backgroundColor,this.settings.defaultColor=e.defaultColor,this.settings.showEdges=e.showEdges,this.settings.edgeColor=e.edgeColor,this.settings.edgeThreshold=e.edgeThreshold,this.settings.themeId=e.themeId,this.modelDisplaySection.Update(this.settings),this.importParametersSection.Update(this.settings),this.appearanceSection.Update(this.settings),this.callbacks.onEnvironmentMapChange(),this.callbacks.onThemeChange()}Resize(){let e=this.resetToDefaultsButton.offsetHeight,t=this.parentDiv.offsetHeight;Ze(this.sectionsDiv,t-e)}};var Kr=class{constructor(e,t,i){this.mainDiv=e,this.splitterDiv=t,this.panelSet=new $t(e),this.detailsPanel=new qr(this.panelSet.GetContentDiv()),this.settingsPanel=new Yr(this.panelSet.GetContentDiv(),i),this.panelSet.AddPanel(this.detailsPanel),this.panelSet.AddPanel(this.settingsPanel),this.panelSet.ShowPanel(this.detailsPanel)}IsPanelsVisible(){return this.panelSet.IsPanelsVisible()}ShowPanels(e){this.panelSet.ShowPanels(e)}Init(e){this.callbacks=e,this.panelSet.Init({onResize:()=>{R(this.splitterDiv,this.panelSet.IsPanelsVisible()),this.callbacks.onResize()},onShowHidePanels:t=>{this.callbacks.onShowHidePanels(t)}}),this.settingsPanel.Init({onEnvironmentMapChange:()=>{this.callbacks.onEnvironmentMapChange()},onBackgroundColorChange:()=>{this.callbacks.onBackgroundColorChange()},onDefaultColorChange:()=>{this.callbacks.onDefaultColorChange()},onEdgeDisplayChange:()=>{this.callbacks.onEdgeDisplayChange()},onThemeChange:()=>{this.callbacks.onThemeChange()}}),gi(this.splitterDiv,this.mainDiv,!0,()=>{this.callbacks.onResize()})}UpdateSettings(e,t){this.settingsPanel.UpdateSettings(e,t)}Resize(e){Ze(this.mainDiv,e),ce(this.splitterDiv,e),this.panelSet.Resize()}GetWidth(){let e=At(this.mainDiv),t=0;return this.panelSet.IsPanelsVisible()&&(t=this.splitterDiv.offsetWidth),e+t}DecreaseWidth(e){let t=this.mainDiv.offsetWidth;Et(this.mainDiv,t-e)}Clear(){this.panelSet.Clear()}AddObject3DProperties(e){this.detailsPanel.AddObject3DProperties(e)}AddMaterialProperties(e){this.detailsPanel.AddMaterialProperties(e)}};var Jr=class{constructor(){this.css={"--ov_foreground_color":{},"--ov_background_color":{},"--ov_button_color":{},"--ov_button_hover_color":{},"--ov_button_text_color":{},"--ov_outline_button_color":{},"--ov_outline_button_hover_color":{},"--ov_outline_button_text_color":{},"--ov_icon_color":{},"--ov_light_icon_color":{},"--ov_selected_icon_color":{},"--ov_disabled_icon_color":{},"--ov_hover_color":{},"--ov_hover_text_color":{},"--ov_logo_text_color":{},"--ov_logo_border_color":{},"--ov_toolbar_background_color":{},"--ov_toolbar_selected_color":{},"--ov_toolbar_separator_color":{},"--ov_treeview_selected_color":{},"--ov_dialog_foreground_color":{},"--ov_dialog_background_color":{},"--ov_border_color":{},"--ov_shadow":{}};let e=document.querySelector(":root"),t=window.getComputedStyle(e);for(let i in this.css)Object.prototype.hasOwnProperty.call(this.css,i)&&(this.css[i].light=t.getPropertyValue(i),this.css[i].dark=t.getPropertyValue(i+"_dark"))}SwitchTheme(e){let t=null;if(e===fe.Light)t="light";else if(e===fe.Dark)t="dark";else return;let i=document.querySelector(":root");for(let r in this.css)if(Object.prototype.hasOwnProperty.call(this.css,r)){let n=this.css[r][t];n!==void 0&&i.style.setProperty(r,n)}}};var Zr=class{constructor(e,t,i){this.image=e,this.imageTitle=t,this.selected=!1,this.buttonDiv=pe("ov_toolbar_button"),this.buttonImg=Z(this.buttonDiv,this.image),i!==null&&this.buttonDiv.addEventListener("click",i),this.buttonDiv.setAttribute("alt",this.imageTitle),ci(this.buttonDiv,this.imageTitle)}AddDomElements(e){e.appendChild(this.buttonDiv)}AddClass(e){this.buttonDiv.classList.add(e)}RemoveClass(e){this.buttonDiv.classList.remove(e)}AddImageClass(e){this.buttonImg.classList.add(e)}RemoveImageClass(e){this.buttonImg.classList.remove(e)}IsSelected(){return this.selected}SetSelected(e){this.selected=e,this.selected?this.buttonDiv.classList.add("selected"):this.buttonDiv.classList.remove("selected")}},Qr=class{constructor(e){this.mainDiv=C(e,"ov_toolbar")}AddImageButton(e,t,i){let r=new Zr(e,t,i);return r.AddDomElements(this.mainDiv),r}AddImagePushButton(e,t,i,r){let n=new Zr(e,t,()=>{n.SetSelected(!n.IsSelected()),r(n.IsSelected())});return n.AddDomElements(this.mainDiv),n.SetSelected(i),n}AddImageRadioButton(e,t,i){let r=[];for(let n=0;n<e.length;n++){let o=e[n],l=this.AddImageButton(o.image,o.title,()=>{for(let a=0;a<r.length;a++){let h=r[a];a===n?h.SetSelected(!0):h.SetSelected(!1)}i(n)});t===n&&l.SetSelected(!0),r.push(l)}return r}AddSeparator(){return C(this.mainDiv,"ov_toolbar_separator")}};function en(s){let e=new THREE.Matrix4;s.object.updateWorldMatrix(!0,!1),e.extractRotation(s.object.matrixWorld);let t=s.face.normal.clone();return t.applyMatrix4(e),t}function Fs(){return new THREE.LineBasicMaterial({color:2503224,depthTest:!1})}function Oi(s,e){let t=new THREE.BufferGeometry().setFromPoints(s);return new THREE.Line(t,e)}var Ns=class{constructor(e,t){this.intersection=null,this.markerObject=new THREE.Object3D;let i=Fs(),r=new THREE.EllipseCurve(0,0,t,t,0,2*Math.PI,!1,0);this.markerObject.add(Oi(r.getPoints(50),i)),this.markerObject.add(Oi([new THREE.Vector3(-t,0,0),new THREE.Vector3(t,0,0)],i)),this.markerObject.add(Oi([new THREE.Vector3(0,-t,0),new THREE.Vector3(0,t,0)],i)),this.UpdatePosition(e)}UpdatePosition(e){this.intersection=e;let t=en(this.intersection);this.markerObject.updateMatrixWorld(!0),this.markerObject.position.set(0,0,0),this.markerObject.lookAt(t),this.markerObject.position.set(this.intersection.point.x,this.intersection.point.y,this.intersection.point.z)}Show(e){this.markerObject.visible=e}GetIntersection(){return this.intersection}GetObject(){return this.markerObject}};function Qs(s,e){let t=s.GetIntersection(),i=e.GetIntersection(),r={pointsDistance:null,parallelFacesDistance:null,facesAngle:null},n=en(t),o=en(i);if(r.pointsDistance=t.point.distanceTo(i.point),r.facesAngle=n.angleTo(o),zi(r.facesAngle,0,1e-4)||zi(r.facesAngle,Math.PI,1e-4)){let l=new THREE.Plane().setFromNormalAndCoplanarPoint(n,t.point);r.parallelFacesDistance=Math.abs(l.distanceToPoint(i.point))}return r}var tn=class{constructor(e,t){this.viewer=e,this.settings=t,this.isActive=!1,this.markers=[],this.tempMarker=null,this.panel=null,this.button=null}SetButton(e){this.button=e}IsActive(){return this.isActive}SetActive(e){this.isActive!==e&&(this.isActive=e,this.button.SetSelected(e),this.isActive?(this.panel=C(document.body,"ov_measure_panel"),this.UpdatePanel(),this.Resize()):(this.ClearMarkers(),this.panel.remove()))}Click(e){let t=this.viewer.GetMeshIntersectionUnderMouse(e);if(t===null){this.ClearMarkers(),this.UpdatePanel();return}this.markers.length===2&&this.ClearMarkers(),this.AddMarker(t),this.UpdatePanel()}MouseMove(e){let t=this.viewer.GetMeshIntersectionUnderMouse(e);if(t===null){this.tempMarker!==null&&(this.tempMarker.Show(!1),this.viewer.Render());return}this.tempMarker===null&&(this.tempMarker=this.GenerateMarker(t)),this.tempMarker.UpdatePosition(t),this.tempMarker.Show(!0),this.viewer.Render()}AddMarker(e){let t=this.GenerateMarker(e);if(this.markers.push(t),this.markers.length===2){let i=Fs(),r=this.markers[0].GetIntersection().point,n=this.markers[1].GetIntersection().point;this.viewer.AddExtraObject(Oi([r,n],i))}}GenerateMarker(e){let i=this.viewer.GetBoundingSphere(n=>!0).radius/20,r=new Ns(e,i);return this.viewer.AddExtraObject(r.GetObject()),r}UpdatePanel(){function e(t,i,r,n){let o=Z(t,i,"left_inline");o.title=r,C(t,"ov_measure_value",n)}if(Ie(this.panel),Cn(this.settings.backgroundColor)?this.panel.style.color="#000000":this.panel.style.color="#ffffff",this.markers.length===0)this.panel.innerHTML="\u9009\u62E9\u4E00\u4E2A\u70B9.";else if(this.markers.length===1)this.panel.innerHTML="\u9009\u62E9\u53E6\u4E00\u4E2A\u70B9.";else{let t=Qs(this.markers[0],this.markers[1]);if(t.pointsDistance!==null&&e(this.panel,"measure_distance","Distance of points",t.pointsDistance.toFixed(3)),t.parallelFacesDistance!==null&&e(this.panel,"measure_distance_parallel","Distance of parallel faces",t.parallelFacesDistance.toFixed(3)),t.facesAngle!==null){let i=t.facesAngle*sn;e(this.panel,"measure_angle","Angle of faces",i.toFixed(1)+"\xB0")}}}Resize(){if(!this.isActive)return;let t=this.viewer.GetCanvas().getBoundingClientRect();this.panel.style.left=t.left+"px",this.panel.style.top=t.top+"px",this.panel.style.width=t.right-t.left+"px"}ClearMarkers(){this.viewer.ClearExtra(),this.markers=[],this.tempMarker=null}};var ze={Undefined:0,Intro:1,Model:2,Loading:3},rn=class{constructor(e){this.parameters=e,this.settings=new ii,this.viewer=new Yt,this.measureTool=new tn(this.viewer,this.settings),this.hashHandler=new Kt,this.toolbar=new Qr(this.parameters.toolbarDiv),this.navigator=new zr(this.parameters.navigatorDiv,this.parameters.navigatorSplitterDiv),this.sidebar=new Kr(this.parameters.sidebarDiv,this.parameters.sidebarSplitterDiv,this.settings),this.modelLoaderUI=new Zt,this.themeHandler=new Jr,this.highlightColor=new THREE.Color(9357808),this.uiState=ze.Undefined,this.model=null}Load(){this.settings.LoadFromCookies(),this.SwitchTheme(this.settings.themeId,!1),ae("theme_on_load",this.settings.themeId===fe.Light?"light":"dark"),this.InitViewer(),this.InitToolbar(),this.InitDragAndDrop(),this.InitSidebar(),this.InitNavigator(),this.InitCookieConsent(),this.viewer.SetMouseClickHandler(this.OnModelClicked.bind(this)),this.viewer.SetMouseMoveHandler(this.OnModelMouseMoved.bind(this)),this.viewer.SetContextMenuHandler(this.OnModelContextMenu.bind(this)),this.Resize(),this.SetUIState(ze.Intro),this.hashHandler.SetEventListener(this.OnHashChange.bind(this)),this.OnHashChange(),gn(()=>{this.OnSmallWidthChanged()}),window.addEventListener("resize",()=>{this.Resize()})}Resize(){let e=window.innerWidth,t=window.innerHeight,i=this.parameters.headerDiv.offsetHeight,r=0,n=0,o=0;xn()||(r=this.navigator.GetWidth(),n=this.sidebar.GetWidth(),o=1);let l=50,a=e-r-n;a<l&&(this.sidebar.DecreaseWidth(l-a),a=l);let h=t-i;Ze(this.parameters.introDiv,h),this.navigator.Resize(h),this.sidebar.Resize(h),this.viewer.Resize(a-o,h),this.measureTool.Resize()}OnSmallWidthChanged(){this.uiState===ze.Model&&this.UpdatePanelsVisibility()}HasLoadedModel(){return this.model!==null}SetUIState(e){function t(i){document.querySelector(":root").style.setProperty("--ov_only_on_model_display",i?"inherit":"none")}this.uiState!==e&&(this.uiState=e,this.uiState===ze.Intro?(R(this.parameters.introDiv,!0),R(this.parameters.mainDiv,!1),t(!1)):this.uiState===ze.Model?(R(this.parameters.introDiv,!1),R(this.parameters.mainDiv,!0),t(!0),this.UpdatePanelsVisibility()):this.uiState===ze.Loading&&(R(this.parameters.introDiv,!1),R(this.parameters.mainDiv,!1),t(!1)),this.Resize())}ClearModel(){Rr(),this.model=null,this.viewer.Clear(),this.parameters.fileNameDiv.innerHTML="",this.navigator.Clear(),this.sidebar.Clear(),this.measureTool.SetActive(!1)}OnModelLoaded(e,t){this.model=e.model,this.parameters.fileNameDiv.innerHTML=e.mainFile,this.viewer.SetMainObject(t),this.viewer.SetUpVector(S.Y,!1),this.navigator.FillTree(e),this.UpdateSidebar(),this.FitModelToWindow(!0)}OnModelClicked(e,t){if(e!==1)return;if(this.measureTool.IsActive()){this.measureTool.Click(t);return}let i=this.viewer.GetMeshUserDataUnderMouse(t);i===null?this.navigator.SetSelection(null):this.navigator.SetSelection(new xt(ne.Mesh,i.originalMeshId))}OnModelMouseMoved(e){this.measureTool.IsActive()&&this.measureTool.MouseMove(e)}OnModelContextMenu(e,t){let i=this.viewer.GetMeshUserDataUnderMouse(t),r=[];if(i===null)r.push({name:"\u5C06\u6A21\u578B\u9002\u914D\u5230\u7A97\u53E3",icon:"fit",onClick:()=>{this.FitModelToWindow(!1)}}),this.navigator.HasHiddenMesh()&&r.push({name:"Show all meshes",icon:"visible",onClick:()=>{this.navigator.ShowAllMeshes(!0)}});else if(r.push({name:"Hide mesh",icon:"hidden",onClick:()=>{this.navigator.ToggleMeshVisibility(i.originalMeshId)}}),r.push({name:"Fit mesh to window",icon:"fit",onClick:()=>{this.navigator.FitMeshToWindow(i.originalMeshId)}}),this.navigator.MeshItemCount()>1){let n=this.navigator.IsMeshIsolated(i.originalMeshId);r.push({name:n?"Remove isolation":"Isolate mesh",icon:n?"deisolate":"isolate",onClick:()=>{n?this.navigator.ShowAllMeshes(!0):this.navigator.IsolateMesh(i.originalMeshId)}})}Bt(r,{calculatePosition:n=>Ts(e,n),onClick:n=>{r[n].onClick()}})}OnHashChange(){if(this.hashHandler.HasHash()){let e=this.hashHandler.GetModelFilesFromHash();if(e===null)return;Ii(e);let t=new Lt;t.defaultColor=this.settings.defaultColor;let i=this.hashHandler.GetDefaultColorFromHash();i!==null&&(t.defaultColor=i),ae("model_load_started","hash"),this.LoadModelFromUrlList(e,t)}else this.ClearModel(),this.SetUIState(ze.Intro)}OpenFileBrowserDialog(){this.parameters.fileInput.click()}FitModelToWindow(e){let t=!e,i=this.viewer.GetBoundingSphere(r=>this.navigator.IsMeshVisible(r.originalMeshId));e&&this.viewer.AdjustClippingPlanesToSphere(i),this.viewer.FitSphereToWindow(i,t)}FitMeshToWindow(e){let t=this.viewer.GetBoundingSphere(i=>i.originalMeshId.IsEqual(e));this.viewer.FitSphereToWindow(t,!0)}FitMeshesToWindow(e){let t=new Set;for(let r of e)t.add(r.GetKey());let i=this.viewer.GetBoundingSphere(r=>t.has(r.originalMeshId.GetKey()));this.viewer.FitSphereToWindow(i,!0)}UpdateSidebar(){let t=this.viewer.GetShadingType()===he.Physical,i=Un(this.model);this.sidebar.UpdateSettings(t,i)}UpdateMeshesVisibility(){this.viewer.SetMeshesVisibility(e=>this.navigator.IsMeshVisible(e.originalMeshId))}UpdateMeshesSelection(){let e=this.navigator.GetSelectedMeshId();this.viewer.SetMeshesHighlight(this.highlightColor,t=>!!(e!==null&&t.originalMeshId.IsEqual(e)))}LoadModelFromUrlList(e,t){this.LoadModel(e,K.Url,t),this.ClearHashIfNotOnlyUrlList()}LoadModelFromFileList(e){let t=new Lt;t.defaultColor=this.settings.defaultColor,this.LoadModel(e,K.File,t),this.ClearHashIfNotOnlyUrlList()}LoadModel(e,t,i){this.modelLoaderUI.LoadModel(e,t,i,{onStart:()=>{this.SetUIState(ze.Loading),this.ClearModel()},onFinish:(r,n)=>{this.SetUIState(ze.Model),this.OnModelLoaded(r,n);let o=Oe(r.mainFile);ae("model_loaded",o)},onRender:()=>{this.viewer.Render()},onError:r=>{this.SetUIState(ze.Intro);let n=null;if(r.mainFile!==null)n=Oe(r.mainFile);else{let o=[],a=this.modelLoaderUI.GetImporter().GetFileList().GetFiles();for(let h=0;h<a.length;h++){let u=a[h].extension;o.push(u)}n=o.join(",")}r.code===Ge.NoImportableFile?ae("no_importable_file",n):r.code===Ge.FailedToLoadFile?ae("failed_to_load_file",n):r.code===Ge.ImportFailed&&ae("import_failed",n,{error_message:r.message})}})}ClearHashIfNotOnlyUrlList(){!this.modelLoaderUI.GetImporter().GetFileList().IsOnlyUrlSource()&&this.hashHandler.HasHash()&&(this.hashHandler.SkipNextEventHandler(),this.hashHandler.ClearHash())}UpdateEdgeDisplay(){this.settings.SaveToCookies(),this.viewer.SetEdgeSettings(this.settings.showEdges,this.settings.edgeColor,this.settings.edgeThreshold)}UpdateEnvironmentMap(){let e="assets/envmaps/"+this.settings.environmentMapName+"/",t=[e+"posx.jpg",e+"negx.jpg",e+"posy.jpg",e+"negy.jpg",e+"posz.jpg",e+"negz.jpg"];this.viewer.SetEnvironmentMapSettings(t,this.settings.backgroundIsEnvMap)}SwitchTheme(e,t){if(this.settings.themeId=e,this.themeHandler.SwitchTheme(this.settings.themeId),this.settings.SaveToCookies(),t){this.viewer.SetBackgroundColor(this.settings.backgroundColor);let i=this.modelLoaderUI.GetModelLoader();i.GetDefaultMaterial()!==null&&(nr(this.model,this.settings.defaultColor),i.ReplaceDefaultMaterialColor(this.settings.defaultColor))}}InitViewer(){let e=ee(this.parameters.viewerDiv,"canvas");this.viewer.Init(e),this.viewer.SetEdgeSettings(this.settings.showEdges,this.settings.edgeColor,this.settings.edgeThreshold),this.viewer.SetBackgroundColor(this.settings.backgroundColor),this.UpdateEnvironmentMap()}InitToolbar(){function e(l,a,h,u,d){let m=l.AddImageButton(a,h,()=>{d()});for(let f of u)m.AddClass(f);return m}function t(l,a,h,u,d){let m=l.AddImagePushButton(a,h,!1,f=>{d(f)});for(let f of u)m.AddClass(f);return m}function i(l,a,h,u,d,m){let f=[];for(let p=0;p<a.length;p++){let g=a[p],v=h[p];f.push({image:g,title:v})}let c=l.AddImageRadioButton(f,u,p=>{m(p)});for(let p of d)for(let g of c)g.AddClass(p)}function r(l,a){let h=l.AddSeparator();if(a!==null)for(let u of a)h.classList.add(u)}let n=this.modelLoaderUI.GetImporter();e(this.toolbar,"up_y","Y\u8F74\u671D\u4E0A",["only_on_model"],()=>{this.viewer.SetUpVector(S.Y,!0)}),e(this.toolbar,"up_z","Z\u8F74\u671D\u4E0A",["only_on_model"],()=>{this.viewer.SetUpVector(S.Z,!0)}),e(this.toolbar,"flip","\u7FFB\u8F6C",["only_on_model"],()=>{this.viewer.FlipUpVector()}),r(this.toolbar,["only_on_model"]),i(this.toolbar,["fix_up_on","fix_up_off"],["\u56FA\u5B9A\u89C6\u89D2","\u81EA\u7531\u89C6\u89D2"],0,["only_on_model"],l=>{l===0?this.viewer.SetFixUpVector(!0):l===1&&this.viewer.SetFixUpVector(!1)}),r(this.toolbar,["only_full_width","only_on_model"]);let o=t(this.toolbar,"measure","\u6D4B\u91CF",["only_full_width","only_on_model"],l=>{ae("measure_tool_activated",l?"on":"off"),this.navigator.SetSelection(null),this.measureTool.SetActive(l)});this.measureTool.SetButton(o),r(this.toolbar,["only_full_width","only_on_model"]),this.parameters.fileInput.addEventListener("change",l=>{l.target.files.length>0&&(ae("model_load_started","open_file"),this.LoadModelFromFileList(l.target.files))})}InitDragAndDrop(){window.addEventListener("dragstart",e=>{e.preventDefault()},!1),window.addEventListener("dragover",e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},!1),window.addEventListener("drop",e=>{e.stopPropagation(),e.preventDefault(),vn(e.dataTransfer,t=>{t.length>0&&(ae("model_load_started","drop"),this.LoadModelFromFileList(t))})},!1)}InitSidebar(){this.sidebar.Init({onEnvironmentMapChange:()=>{this.settings.SaveToCookies(),this.UpdateEnvironmentMap()},onBackgroundColorChange:()=>{this.settings.SaveToCookies(),this.viewer.SetBackgroundColor(this.settings.backgroundColor),this.measureTool.IsActive()&&this.measureTool.UpdatePanel()},onDefaultColorChange:()=>{this.settings.SaveToCookies();let e=this.modelLoaderUI.GetModelLoader();e.GetDefaultMaterial()!==null&&(nr(this.model,this.settings.defaultColor),e.ReplaceDefaultMaterialColor(this.settings.defaultColor)),this.viewer.Render()},onEdgeDisplayChange:()=>{ae("edge_display_changed",this.settings.showEdges?"on":"off"),this.UpdateEdgeDisplay()},onThemeChange:()=>{ae("theme_changed",this.settings.themeId===fe.Light?"light":"dark"),this.SwitchTheme(this.settings.themeId,!0)},onResize:()=>{this.Resize()},onShowHidePanels:e=>{Vi("ov_show_sidebar",e)}})}InitNavigator(){function e(n,o){let l=null;return n.EnumerateMeshesUserData(a=>{a.originalMeshId.IsEqual(o)&&(l=a)}),l}function t(n,o,l){let a=[];return n.EnumerateMeshesUserData(h=>{if(l===null||h.originalMaterials.indexOf(l)!==-1){let u=o.GetMesh(h.originalMeshId.meshIndex);a.push({meshId:h.originalMeshId,name:u.GetName()})}}),a}function i(n,o){let l=n.GetMaterial(o);return{index:o,name:l.name,color:l.color.Clone()}}function r(n,o,l){let a=[];if(l===null)for(let h=0;h<o.MaterialCount();h++)a.push(i(o,h));else{let h=e(n,l);for(let u=0;u<h.originalMaterials.length;u++){let d=h.originalMaterials[u];a.push(i(o,d))}}return a.sort((h,u)=>h.index-u.index),a}this.navigator.Init({openFileBrowserDialog:()=>{this.OpenFileBrowserDialog()},updateMeshesVisibility:()=>{this.UpdateMeshesVisibility()},updateMeshesSelection:()=>{this.UpdateMeshesSelection()},fitMeshToWindow:n=>{this.FitMeshToWindow(n)},fitMeshesToWindow:n=>{this.FitMeshesToWindow(n)},getMeshesForMaterial:n=>t(this.viewer,this.model,n),getMaterialsForMesh:n=>r(this.viewer,this.model,n),onModelSelected:()=>{this.sidebar.AddObject3DProperties(this.model)},onMeshSelected:n=>{let o=this.model.GetMeshInstance(n);this.sidebar.AddObject3DProperties(o)},onMaterialSelected:n=>{this.sidebar.AddMaterialProperties(this.model.GetMaterial(n))},onResize:()=>{this.Resize()},onShowHidePanels:n=>{Vi("ov_show_navigator",n)}})}UpdatePanelsVisibility(){let e=vt("ov_show_navigator",!0),t=vt("ov_show_sidebar",!0);this.navigator.ShowPanels(e),this.sidebar.ShowPanels(t)}InitCookieConsent(){if(vt("ov_cookie_consent",!1))return;let t='This website uses cookies to offer you better user experience. See the details at the <a target="_blank" href="info/cookies.html">Cookies Policy</a> page.',i=C(document.body,"ov_bottom_floating_panel");C(i,"ov_floating_panel_text",t),C(i,"ov_button ov_floating_panel_button","Accept").addEventListener("click",()=>{Vi("ov_cookie_consent",!0),i.remove()})}};function $s(s){Tn(s)}function eo(s){Ui(s),window.addEventListener("load",()=>{new rn({headerDiv:document.getElementById("header"),toolbarDiv:document.getElementById("toolbar"),mainDiv:document.getElementById("main"),introDiv:document.getElementById("intro"),fileNameDiv:document.getElementById("main_file_name"),navigatorDiv:document.getElementById("main_navigator"),navigatorSplitterDiv:document.getElementById("main_navigator_splitter"),sidebarDiv:document.getElementById("main_sidebar"),sidebarSplitterDiv:document.getElementById("main_sidebar_splitter"),viewerDiv:document.getElementById("main_viewer"),fileInput:document.getElementById("open_file")}).Load()})}function to(s){Ui(s),window.addEventListener("load",()=>{new Nr({viewerDiv:document.getElementById("embed_viewer"),websiteLinkDiv:document.getElementById("website_link")}).Load()})}function io(s,e,t,i){let r=wt("a");return r.setAttribute("href",i),r.setAttribute("target","_blank"),r.setAttribute("rel","noopener noreferrer"),ci(r,t),Z(r,e,"header_button"),s.appendChild(r),r}return Us(ro);})();
//# sourceMappingURL=o3dv.website.min-dev.js.map
